<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>استودیو هوش مصنوعی</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Highlight.js for code syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- Vazirmatn Font -->
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.395.0/dist/umd/lucide.min.js"></script>

    <style>
        /* --- CSS Variables for Theming --- */
        :root {
            --bg-primary: #f4f7fe; --bg-secondary: #ffffff; --text-primary: #1a202c; --text-secondary: #718096; --accent-color: #4a90e2; --accent-color-dark: #3a7bc8; --sidebar-bg: #ffffff; --border-color: #e2e8f0; --pro-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .dark {
            --bg-primary: #121212; --bg-secondary: #1E1E1E; --text-primary: #e2e2e2; --text-secondary: #a0a0a0; --accent-color: #58a6ff; --accent-color-dark: #388bfd; --sidebar-bg: #1E1E1E; --border-color: #333333; --pro-bg: linear-gradient(135deg, #303a52 0%, #574b90 100%);
        }
        .theme-ocean {
            --bg-primary: #E0F7FA; --bg-secondary: #FFFFFF; --text-primary: #004D40; --text-secondary: #00796B; --accent-color: #00BCD4; --accent-color-dark: #0097A7; --sidebar-bg: #B2EBF2; --border-color: #4DD0E1; --pro-bg: linear-gradient(135deg, #00BCD4 0%, #00796B 100%);
        }
        .theme-forest {
            --bg-primary: #E8F5E9; --bg-secondary: #FFFFFF; --text-primary: #1B5E20; --text-secondary: #388E3C; --accent-color: #4CAF50; --accent-color-dark: #388E3C; --sidebar-bg: #C8E6C9; --border-color: #A5D6A7; --pro-bg: linear-gradient(135deg, #4CAF50 0%, #1B5E20 100%);
        }
        .theme-rose {
            --bg-primary: #FCE4EC; --bg-secondary: #FFFFFF; --text-primary: #880E4F; --text-secondary: #C2185B; --accent-color: #E91E63; --accent-color-dark: #C2185B; --sidebar-bg: #F8BBD0; --border-color: #F48FB1; --pro-bg: linear-gradient(135deg, #E91E63 0%, #880E4F 100%);
        }

        body { font-family: 'Vazirmatn', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }
        
        /* --- Layout Fix --- */
        #sidebar {
            transition: transform 0.3s ease-in-out;
            flex-shrink: 0; /* Prevent sidebar from shrinking */
        }
        
        @media (max-width: 767px) {
            #sidebar {
                transform: translateX(100%);
                position: absolute; /* Keep it absolute for mobile overlay */
            }
            #app-wrapper.sidebar-open #sidebar {
                transform: translateX(0);
            }
        }
        @media (min-width: 768px) {
            #app-wrapper.sidebar-closed #sidebar {
                transform: translateX(100%);
                width: 0; /* Collapse width when closed */
            }
        }

        .prose pre { position: relative; background-color: #282c34; color: #abb2bf; padding: 2.5em 1em 1em; border-radius: 8px; overflow-x: auto; }
        .code-header { position: absolute; top: 0; left: 0; right: 0; display: flex; justify-content: space-between; align-items: center; padding: 4px 12px; background-color: #374151; color: white; border-top-left-radius: 8px; border-top-right-radius: 8px; font-size: 0.8em; }
        .copy-code-btn { background: none; border: none; color: white; cursor: pointer; padding: 4px; border-radius: 4px; }
        .copy-code-btn:hover { background-color: #4b5563; }
        textarea::-webkit-scrollbar { display: none; }
        .mic-active { color: var(--accent-color); }

        /* Typing animation cursor */
        .typing-cursor {
            display: inline-block;
            width: 8px;
            height: 1.2em;
            background-color: var(--text-primary);
            animation: blink 1s step-end infinite;
        }
        @keyframes blink {
            from, to { background-color: transparent }
            50% { background-color: var(--text-primary); }
        }
    </style>
</head>
<body class="overflow-hidden">
    <div id="app-wrapper" class="relative flex h-screen w-screen">
        <div id="sidebar-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>
        <aside id="sidebar" class="h-full w-72 bg-[var(--sidebar-bg)] flex flex-col z-40 border-l border-[var(--border-color)] shadow-lg">
            <div class="p-4 flex justify-between items-center border-b border-[var(--border-color)]">
                <h2 class="font-bold text-lg">تاریخچه</h2>
                <button id="new-chat-btn" class="p-2 rounded-md hover:bg-gray-300/50 dark:hover:bg-gray-600/50" title="گفتگوی جدید"><i data-lucide="plus-square"></i></button>
            </div>
            <nav id="conversations-list" class="flex-1 overflow-y-auto p-2 space-y-1"></nav>
            <div class="p-3 border-t border-[var(--border-color)] space-y-2">
                 <button id="upgrade-pro-btn" class="w-full text-white font-bold flex items-center justify-center gap-3 p-3 rounded-lg hover:opacity-90 transition-opacity" style="background: var(--pro-bg);"><i data-lucide="zap"></i><span>ارتقاء به پرو</span></button>
                 <button id="settings-btn" class="w-full text-right flex items-center gap-3 p-2 rounded-md hover:bg-gray-300/50 dark:hover:bg-gray-600/50"><i data-lucide="settings"></i><span>تنظیمات</span></button>
                 <button id="about-btn" class="w-full text-right flex items-center gap-3 p-2 rounded-md hover:bg-gray-300/50 dark:hover:bg-gray-600/50"><i data-lucide="info"></i><span>درباره ما</span></button>
            </div>
        </aside>

        <main id="main-content" class="flex-1 flex flex-col bg-[var(--bg-primary)] min-w-0">
            <header class="flex items-center justify-between p-4 border-b border-[var(--border-color)] bg-[var(--bg-secondary)]/80 backdrop-blur-sm">
                <button id="sidebar-toggle" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="panel-left"></i></button>
                <h1 id="chat-title" class="text-lg font-semibold text-center flex-1 truncate px-4"></h1>
                <button id="export-chat-btn" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 hidden" title="خروجی گرفتن"><i data-lucide="download"></i></button>
            </header>
            <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-6"></div>
            <footer class="p-4 bg-transparent">
                <div id="loading-indicator-container" class="hidden items-center justify-center mx-auto mb-2"></div>
                <form id="chat-form" class="flex items-end gap-2 bg-[var(--bg-secondary)] p-3 rounded-2xl shadow-lg border border-[var(--border-color)]">
                    <input type="file" id="file-input" class="hidden" accept="image/*" />
                    <button type="button" id="file-upload-btn" class="p-2 self-center flex-shrink-0 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" title="ارسال فایل"><i data-lucide="paperclip"></i></button>
                    <button type="button" id="mic-btn" class="p-2 self-center flex-shrink-0 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" title="گفتار به متن"><i data-lucide="mic"></i></button>
                    <textarea id="user-input" placeholder="پیام خود را بنویسید..." class="flex-1 bg-transparent focus:outline-none resize-none px-2 py-2 max-h-48" rows="1"></textarea>
                    <button type="button" id="create-btn" class="p-2 self-center flex-shrink-0 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" title="خلق کردن"><i data-lucide="sparkles"></i></button>
                    <button type="submit" id="send-btn" class="bg-[var(--accent-color)] text-white p-3 self-center flex-shrink-0 rounded-full transition-colors hover:bg-[var(--accent-color-dark)] disabled:opacity-50 disabled:cursor-not-allowed"><i data-lucide="arrow-up"></i></button>
                </form>
            </footer>
        </main>
    </div>
    
    <!-- Modals -->
    <div id="about-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
        <div class="bg-[var(--bg-secondary)] rounded-2xl shadow-xl p-6 w-full max-w-2xl mx-auto" data-modal-content>
            <div class="flex justify-between items-center mb-4">
                 <h3 class="text-2xl font-bold">درباره استودیو هوش مصنوعی</h3>
                 <button class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-close-modal><i data-lucide="x"></i></button>
            </div>
            <div class="space-y-4 text-justify text-[var(--text-primary)]">
                <details class="bg-gray-500/10 p-3 rounded-lg" open>
                    <summary class="font-semibold cursor-pointer">چشم‌انداز ما</summary>
                    <p class="mt-2 text-sm text-[var(--text-secondary)]">
                        هدف ما، فراهم کردن یک دستیار هوشمند، خلاق و در دسترس برای تمام کاربران فارسی‌زبان است. ما به دنبال دموکراتیک کردن فناوری هوش مصنوعی در یک محیط کاربری ساده و زیبا هستیم.
                    </p>
                </details>
                <details class="bg-gray-500/10 p-3 rounded-lg">
                    <summary class="font-semibold cursor-pointer">توسعه‌دهنده</summary>
                    <p class="mt-2 text-sm text-[var(--text-secondary)]">
                        این پروژه با افتخار توسط <strong class="text-[var(--accent-color)]">محمد امین</strong>، توسعه‌دهنده علاقه‌مند به وب و هوش مصنوعی، طراحی و اجرا شده است.
                    </p>
                </details>
                <details class="bg-gray-500/10 p-3 rounded-lg">
                    <summary class="font-semibold cursor-pointer">فناوری‌های کلیدی</summary>
                    <ul class="list-disc list-inside mt-2 text-sm text-[var(--text-secondary)] space-y-1">
                        <li><strong>هوش مصنوعی:</strong> Google Gemini & Imagen</li>
                        <li><strong>طراحی رابط کاربری:</strong> Tailwind CSS</li>
                        <li><strong>منطق برنامه:</strong> Vanilla JavaScript</li>
                    </ul>
                </details>
            </div>
        </div>
    </div>
    
    <div id="create-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
        <div class="bg-[var(--bg-secondary)] rounded-2xl shadow-xl p-6 w-full max-w-2xl mx-auto" data-modal-content>
            <div class="flex justify-between items-center mb-4">
                 <h3 class="text-xl font-bold">استودیو خلق</h3>
                 <button class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-close-modal><i data-lucide="x"></i></button>
            </div>
            <p class="text-[var(--text-secondary)] mb-6">ابزار مورد نظر خود را برای خلق کردن انتخاب کنید.</p>
            <div id="create-options" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button data-type="image" class="text-right p-4 border border-[var(--border-color)] rounded-lg hover:border-[var(--accent-color)] hover:bg-gray-500/10 transition-all group">
                    <i data-lucide="image" class="w-8 h-8 mb-2 text-[var(--accent-color)]"></i>
                    <h4 class="font-bold text-lg">خلق تصویر</h4>
                    <p class="text-sm text-[var(--text-secondary)]">ایده‌های خود را به تصاویر هنری و واقعی تبدیل کنید.</p>
                </button>
                <button data-type="code" class="text-right p-4 border border-[var(--border-color)] rounded-lg hover:border-[var(--accent-color)] hover:bg-gray-500/10 transition-all group">
                    <i data-lucide="code-2" class="w-8 h-8 mb-2 text-[var(--accent-color)]"></i>
                    <h4 class="font-bold text-lg">خلق وب‌سایت</h4>
                    <p class="text-sm text-[var(--text-secondary)]">یک صفحه وب کامل با HTML, CSS و JS بسازید.</p>
                </button>
            </div>
            <form id="create-form" class="hidden mt-6">
                <textarea id="create-prompt" rows="4" class="w-full p-2 border border-[var(--border-color)] rounded-md bg-transparent focus:ring-2 focus:ring-[var(--accent-color)] outline-none" required></textarea>
                <div class="flex justify-end gap-4 mt-4">
                    <button type="button" data-close-modal class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg">انصراف</button>
                    <button type="submit" class="px-4 py-2 bg-[var(--accent-color)] text-white rounded-lg">شروع کن!</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="settings-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
        <div class="bg-[var(--bg-secondary)] rounded-2xl shadow-xl p-6 w-full max-w-2xl mx-auto" data-modal-content>
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold">تنظیمات پیشرفته</h3>
                 <button data-close-modal class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="x"></i></button>
            </div>
            <div class="space-y-6">
                <div>
                    <label class="block mb-2 font-semibold">انتخاب تم</label>
                    <div id="theme-selector" class="flex gap-2">
                        <button data-theme="light" class="w-8 h-8 rounded-full bg-gray-200 ring-2 ring-offset-2 ring-offset-[var(--bg-primary)]"></button>
                        <button data-theme="dark" class="w-8 h-8 rounded-full bg-gray-800 ring-2 ring-offset-2 ring-offset-[var(--bg-primary)]"></button>
                        <button data-theme="ocean" class="w-8 h-8 rounded-full bg-[#00BCD4] ring-2 ring-offset-2 ring-offset-[var(--bg-primary)]"></button>
                        <button data-theme="forest" class="w-8 h-8 rounded-full bg-[#4CAF50] ring-2 ring-offset-2 ring-offset-[var(--bg-primary)]"></button>
                        <button data-theme="rose" class="w-8 h-8 rounded-full bg-[#E91E63] ring-2 ring-offset-2 ring-offset-[var(--bg-primary)]"></button>
                    </div>
                </div>
                <div>
                    <label class="block mb-2 font-semibold">شخصیت هوش مصنوعی (System Prompt)</label>
                    <textarea id="system-prompt-input" rows="4" class="w-full p-2 border border-[var(--border-color)] rounded-md bg-transparent focus:ring-2 focus:ring-[var(--accent-color)] outline-none" placeholder="مثال: تو یک دستیار برنامه‌نویس هستی که به زبان پایتون مسلط است."></textarea>
                </div>
                <div>
                    <label for="creativity-slider" class="block mb-2 font-semibold">میزان خلاقیت (دما): <span id="creativity-value">0.7</span></label>
                    <input id="creativity-slider" type="range" min="0" max="1" step="0.1" class="w-full">
                </div>
                <div>
                    <label class="block mb-2 font-semibold">مدیریت تنظیمات</label>
                    <div class="flex gap-2">
                        <input type="file" id="import-settings-input" class="hidden" accept=".json">
                        <button id="import-settings-btn" class="flex-1 text-center p-2 rounded-md border border-[var(--border-color)] hover:bg-gray-500/10">ورود تنظیمات</button>
                        <button id="export-settings-btn" class="flex-1 text-center p-2 rounded-md border border-[var(--border-color)] hover:bg-gray-500/10">خروج تنظیمات</button>
                    </div>
                </div>
                <div>
                    <label class="block mb-2 font-semibold">عملیات خطرناک</label>
                    <button id="clear-all-btn" class="w-full text-left p-3 rounded-md bg-red-500 text-white hover:bg-red-600 flex items-center gap-2"><i data-lucide="trash-2"></i>پاک کردن تمام گفتگوها</button>
                </div>
            </div>
        </div>
    </div>

    <div id="pro-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
        <div class="bg-[var(--bg-secondary)] rounded-2xl shadow-xl w-full max-w-4xl mx-auto" data-modal-content>
            <div class="p-6">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-bold">به دنیای حرفه‌ای‌ها خوش آمدید!</h3>
                    <button data-close-modal class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="x"></i></button>
                </div>
                <p class="text-[var(--text-secondary)] mt-2">با عضویت ویژه، قفل تمام قابلیت‌ها را باز کنید.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 p-6 bg-[var(--bg-primary)]">
                <div class="border border-[var(--border-color)] rounded-lg p-6 bg-[var(--bg-secondary)] text-center">
                    <h4 class="font-bold text-lg">پایه</h4>
                    <p class="text-3xl font-bold my-4">$10 <span class="text-sm font-normal">/ماهانه</span></p>
                    <ul class="space-y-2 text-sm text-[var(--text-secondary)]"><li>✓ 100 خلق تصویر</li><li>✓ 50 خلق وبسایت</li><li>✓ پشتیبانی استاندارد</li></ul>
                    <button class="mt-6 w-full p-2 rounded-lg border border-[var(--accent-color)] text-[var(--accent-color)] hover:bg-[var(--accent-color)] hover:text-white transition-colors">شروع کنید</button>
                </div>
                <div class="border-2 border-[var(--accent-color)] rounded-lg p-6 bg-[var(--bg-secondary)] text-center relative">
                    <div class="absolute -top-3 right-1/2 translate-x-1/2 bg-[var(--accent-color)] text-white px-3 py-1 rounded-full text-xs font-bold">محبوب‌ترین</div>
                    <h4 class="font-bold text-lg">حرفه‌ای</h4>
                    <p class="text-3xl font-bold my-4">$25 <span class="text-sm font-normal">/ماهانه</span></p>
                    <ul class="space-y-2 text-sm text-[var(--text-secondary)]"><li>✓ خلق تصویر نامحدود</li><li>✓ خلق وبسایت نامحدود</li><li>✓ دسترسی به مدل‌های جدید</li><li>✓ پشتیبانی ویژه</li></ul>
                    <button class="mt-6 w-full p-2 rounded-lg bg-[var(--accent-color)] text-white hover:bg-[var(--accent-color-dark)] transition-colors">همین حالا بخرید</button>
                </div>
                <div class="border border-[var(--border-color)] rounded-lg p-6 bg-[var(--bg-secondary)] text-center">
                    <h4 class="font-bold text-lg">سازمانی</h4>
                    <p class="text-3xl font-bold my-4">تماس بگیرید</p>
                    <ul class="space-y-2 text-sm text-[var(--text-secondary)]"><li>✓ تمام قابلیت‌های حرفه‌ای</li><li>✓ مدیریت تیم</li><li>✓ پشتیبانی اختصاصی</li></ul>
                    <button class="mt-6 w-full p-2 rounded-lg border border-[var(--accent-color)] text-[var(--accent-color)] hover:bg-[var(--accent-color)] hover:text-white transition-colors">تماس با ما</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        const elements = {
            appWrapper: document.getElementById('app-wrapper'),
            sidebar: document.getElementById('sidebar'),
            sidebarToggle: document.getElementById('sidebar-toggle'),
            sidebarBackdrop: document.getElementById('sidebar-backdrop'),
            chatContainer: document.getElementById('chat-container'),
            chatForm: document.getElementById('chat-form'),
            userInput: document.getElementById('user-input'),
            sendBtn: document.getElementById('send-btn'),
            newChatBtn: document.getElementById('new-chat-btn'),
            conversationsList: document.getElementById('conversations-list'),
            chatTitle: document.getElementById('chat-title'),
            loadingIndicatorContainer: document.getElementById('loading-indicator-container'),
            micBtn: document.getElementById('mic-btn'),
            fileUploadBtn: document.getElementById('file-upload-btn'),
            fileInput: document.getElementById('file-input'),
            createBtn: document.getElementById('create-btn'),
            createModal: document.getElementById('create-modal'),
            createOptions: document.getElementById('create-options'),
            createForm: document.getElementById('create-form'),
            createPrompt: document.getElementById('create-prompt'),
            settingsBtn: document.getElementById('settings-btn'),
            settingsModal: document.getElementById('settings-modal'),
            themeSelector: document.getElementById('theme-selector'),
            systemPromptInput: document.getElementById('system-prompt-input'),
            creativitySlider: document.getElementById('creativity-slider'),
            creativityValue: document.getElementById('creativity-value'),
            clearAllBtn: document.getElementById('clear-all-btn'),
            upgradeProBtn: document.getElementById('upgrade-pro-btn'),
            proModal: document.getElementById('pro-modal'),
            aboutBtn: document.getElementById('about-btn'),
            aboutModal: document.getElementById('about-modal'),
            exportChatBtn: document.getElementById('export-chat-btn'),
            exportSettingsBtn: document.getElementById('export-settings-btn'),
            importSettingsBtn: document.getElementById('import-settings-btn'),
            importSettingsInput: document.getElementById('import-settings-input'),
        };

        let state = {
            conversations: {},
            currentChatId: null,
            settings: { theme: 'light', systemPrompt: '', creativity: 0.7 },
            isRecording: false
        };
        let currentCreateType = null;
        let recognition;
        let apiAbortController = null;
        let typingEffectInterval = null;

        const saveState = () => localStorage.setItem('ai-studio-state', JSON.stringify(state));
        
        const loadState = () => {
            const savedState = localStorage.getItem('ai-studio-state');
            if (savedState) {
                const parsed = JSON.parse(savedState);
                state.conversations = parsed.conversations || {};
                state.currentChatId = parsed.currentChatId;
                state.settings = { ...state.settings, ...parsed.settings };
            }
        };
        
        const applyTheme = () => {
            document.body.className = `theme-${state.settings.theme} overflow-hidden`;
            document.documentElement.classList.toggle('dark', state.settings.theme === 'dark');
            elements.themeSelector.querySelectorAll('button').forEach(btn => {
                btn.classList.toggle('ring-[var(--accent-color)]', btn.dataset.theme === state.settings.theme);
            });
        };

        const callApi = async (url, payload) => {
            apiAbortController = new AbortController();
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: apiAbortController.signal
                });
                if (!response.ok) {
                    const errorBody = await response.json().catch(() => ({ error: { message: response.statusText } }));
                    throw new Error(`API Error ${response.status}: ${errorBody.error.message}`);
                }
                return await response.json();
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('API call aborted by user.');
                    return null; 
                }
                console.error("API Call failed:", error);
                throw error;
            } finally {
                apiAbortController = null;
            }
        };

        const generateText = async (prompt, history) => {
            const historyToSend = history.map(msg => {
                if (msg.type === 'text' || msg.type === 'code') {
                    return { role: msg.role === 'user' ? 'user' : 'model', parts: [{ text: msg.content }] };
                }
                return null;
            }).filter(Boolean);

            if (state.settings.systemPrompt) {
                historyToSend.unshift({ role: 'model', parts: [{ text: 'OK.' }] });
                historyToSend.unshift({ role: 'user', parts: [{ text: `System instruction: ${state.settings.systemPrompt}` }] });
            }
            historyToSend.push({ role: 'user', parts: [{ text: prompt }] });
            
            const apiKey = "AIzaSyDU68W5dCn_3VDGt7udcLzAPnfH37yode4";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = { contents: historyToSend, generationConfig: { temperature: parseFloat(state.settings.creativity) } };
            
            const result = await callApi(apiUrl, payload);
            if (!result) return null;
            if (!result.candidates?.[0]?.content?.parts?.[0]?.text) {
                throw new Error('پاسخ نامعتبر از سرور دریافت شد.');
            }
            return result.candidates[0].content.parts[0].text;
        };

        const generateImage = async (prompt) => {
            const apiKey = "AIzaSyDU68W5dCn_3VDGt7udcLzAPnfH37yode4";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
            const enhancedPrompt = `cinematic photo, 35mm, f/1.8, professional, high-quality, detailed, photorealistic image of: ${prompt}.`;
            const payload = { instances: [{ prompt: enhancedPrompt }], parameters: { "sampleCount": 1 } };
            
            const result = await callApi(apiUrl, payload);
            if (!result) return null;
            if (!result.predictions?.[0]?.bytesBase64Encoded) {
                 throw new Error('پاسخ نامعتبر از سرور تصویر دریافت شد.');
            }
            return `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
        };

        const toggleForm = (enabled) => {
            elements.userInput.disabled = !enabled;
            elements.sendBtn.disabled = !enabled;
            elements.sendBtn.classList.toggle('opacity-50', !enabled);
            elements.sendBtn.classList.toggle('cursor-not-allowed', !enabled);
        };

        const showLoadingIndicator = () => {
            elements.loadingIndicatorContainer.innerHTML = `
                <div class="flex items-center justify-center gap-4 text-sm text-[var(--text-secondary)]">
                    <span>در حال پردازش...</span>
                    <button id="cancel-generation-btn" class="text-red-500 hover:underline">لغو</button>
                </div>`;
            elements.loadingIndicatorContainer.classList.remove('hidden');
            elements.loadingIndicatorContainer.classList.add('flex');
            document.getElementById('cancel-generation-btn').addEventListener('click', () => {
                if (apiAbortController) {
                    apiAbortController.abort();
                    hideLoadingIndicator();
                    toggleForm(true);
                }
            });
        };

        const hideLoadingIndicator = () => {
            elements.loadingIndicatorContainer.classList.add('hidden');
            elements.loadingIndicatorContainer.classList.remove('flex');
            elements.loadingIndicatorContainer.innerHTML = '';
        };
        
        const renderConversationsList = () => {
            elements.conversationsList.innerHTML = '';
            const sortedChats = Object.values(state.conversations).sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
            sortedChats.forEach(chat => {
                const item = document.createElement('div');
                item.className = 'flex items-center group';
                const isActive = chat.id === state.currentChatId;
                item.innerHTML = `
                    <button data-chat-id="${chat.id}" class="flex-1 text-right p-2 rounded-md truncate ${isActive ? 'bg-blue-100 dark:bg-gray-700' : 'hover:bg-gray-300/50 dark:hover:bg-gray-600/50'}">${chat.title}</button>
                    <button data-delete-id="${chat.id}" class="p-2 rounded-md text-gray-500 hover:bg-red-200 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity" title="حذف"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                `;
                elements.conversationsList.appendChild(item);
            });
            lucide.createIcons();
        };

        const streamTextResponse = (textElement, fullText, callback) => {
            let i = 0;
            clearInterval(typingEffectInterval);
            textElement.innerHTML = '';
            const cursor = document.createElement('span');
            cursor.className = 'typing-cursor';
            textElement.appendChild(cursor);

            typingEffectInterval = setInterval(() => {
                if (i < fullText.length) {
                    textElement.insertBefore(document.createTextNode(fullText[i]), cursor);
                    i++;
                } else {
                    clearInterval(typingEffectInterval);
                    cursor.remove();
                    if (callback) callback();
                }
            }, 30);
        };

        const addMessageToUI = (role, content, type = 'text', messageId, isStreaming = false) => {
            const messageWrapper = document.createElement('div');
            messageWrapper.id = `msg-${messageId}`;
            messageWrapper.className = `flex items-start gap-3 group relative ${role === 'user' ? 'justify-end' : ''}`;
            
            const avatar = `<div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg flex-shrink-0 shadow-md ${role === 'user' ? 'bg-gray-300 dark:bg-gray-600' : 'bg-gradient-to-br from-blue-400 to-purple-500 text-white'}">${role === 'user' ? 'شما' : 'AI'}</div>`;
            
            let messageContentHTML = '';
            if (type === 'image_generation') {
                messageContentHTML = `<div class="p-3 rounded-lg shadow-md bg-[var(--bg-secondary)] max-w-sm"><p class="text-sm text-[var(--text-secondary)] mb-2">${content.prompt}</p><img src="${content.url}" alt="Generated Image" class="rounded-lg" /><a href="${content.url}" download="ai-image.png" class="mt-2 inline-block text-sm text-[var(--accent-color)]">دانلود</a></div>`;
            } else {
                const proseClass = role === 'user' ? 'bg-[var(--accent-color)] text-white' : 'bg-[var(--bg-secondary)]';
                messageContentHTML = `<div class="prose max-w-none break-words p-3 rounded-lg shadow-md ${proseClass}"></div>`;
            }

            const messageControls = role === 'user' ? `
                <div class="absolute top-1/2 -translate-y-1/2 left-0 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button onclick="editMessage('${messageId}')" class="p-1 rounded-full bg-gray-500/20 text-[var(--text-secondary)]"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                    <button onclick="deleteMessage('${messageId}')" class="p-1 rounded-full bg-gray-500/20 text-[var(--text-secondary)]"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>` : '';

            const ttsButton = role === 'assistant' ? `<button class="absolute top-2 left-2 p-1 rounded-full bg-gray-500/20 text-[var(--text-secondary)] opacity-0 group-hover:opacity-100 transition-opacity" onclick="speakMessage(this)"><i data-lucide="volume-2" class="w-4 h-4"></i></button>` : '';
            messageWrapper.innerHTML = (role === 'user' ? messageControls : '') + (role === 'user' ? '' : avatar) + `<div class="relative">${messageContentHTML}${ttsButton}</div>` + (role === 'user' ? avatar : '');
            
            elements.chatContainer.appendChild(messageWrapper);

            if (type === 'text' || type === 'code') {
                const textElement = messageWrapper.querySelector('.prose');
                if (isStreaming) {
                    streamTextResponse(textElement, content, () => {
                         textElement.innerHTML = marked.parse(content);
                         hljs.highlightAll();
                    });
                } else {
                    textElement.innerHTML = marked.parse(content);
                    textElement.querySelectorAll('pre').forEach(pre => {
                        const code = pre.querySelector('code');
                        if (!code) return;
                        const lang = code.className.replace('language-', '') || 'code';
                        const header = document.createElement('div');
                        header.className = 'code-header';
                        header.innerHTML = `<span>${lang}</span><button class="copy-code-btn" onclick="copyCode(this)">کپی</button>`;
                        pre.prepend(header);
                    });
                    hljs.highlightAll();
                }
            }
            
            elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight;
            lucide.createIcons();
        };
        
        const handleUserMessage = async (userInput, fileData = null, isEdit = false, originalMessageId = null) => {
            if (!userInput.trim() && !fileData) return;
            toggleForm(false);
            const currentChat = state.conversations[state.currentChatId];

            if (isEdit) {
                const messageIndex = currentChat.history.findIndex(m => m.id === originalMessageId);
                if (messageIndex !== -1) {
                    currentChat.history.splice(messageIndex);
                }
            }
            
            const messageId = `msg-${Date.now()}`;
            const userMessage = { id: messageId, role: 'user', type: 'text', content: userInput };
            currentChat.history.push(userMessage);
            
            loadChat(state.currentChatId, true);
            showLoadingIndicator();

            try {
                const aiResponseText = await generateText(userInput, currentChat.history.slice(0, -1));
                hideLoadingIndicator();
                if (aiResponseText) {
                    const aiMessageId = `msg-${Date.now() + 1}`;
                    const aiMessage = { id: aiMessageId, role: 'assistant', type: 'text', content: aiResponseText };
                    currentChat.history.push(aiMessage);
                    addMessageToUI(aiMessage.role, aiMessage.content, aiMessage.type, aiMessage.id, true);
                }
                
                if (currentChat.history.length <= 3) {
                    const titlePrompt = `این گفتگو را در 3 یا 4 کلمه برای عنوان خلاصه کن: "${userInput}"`;
                    const newTitle = await generateText(titlePrompt, []);
                    if (newTitle) currentChat.title = newTitle.replace(/"/g, '');
                    renderConversationsList();
                }
                saveState();
            } catch (error) {
                hideLoadingIndicator();
                addMessageToUI('assistant', `**خطا:** متاسفانه مشکلی در ارتباط با سرور پیش آمد.\n\n\`\`\`\n${error.message}\n\`\`\``, 'text', `msg-${Date.now() + 1}`);
            } finally {
                toggleForm(true);
            }
        };

        const handleCreateCommand = async (prompt, type) => {
            if (!prompt.trim()) return;
            toggleForm(false);
            const currentChat = state.conversations[state.currentChatId];
            
            const userMessageId = `msg-${Date.now()}`;
            const userMessage = { id: userMessageId, role: 'user', type: 'text', content: `خلق ${type === 'image' ? 'تصویر' : 'کد'}: ${prompt}` };
            currentChat.history.push(userMessage);
            addMessageToUI(userMessage.role, userMessage.content, userMessage.type, userMessage.id);
            showLoadingIndicator();

            try {
                let aiMessage;
                const aiMessageId = `msg-${Date.now() + 1}`;
                if (type === 'image') {
                    const imageUrl = await generateImage(prompt);
                    if(imageUrl) aiMessage = { id: aiMessageId, role: 'assistant', type: 'image_generation', content: { url: imageUrl, prompt: prompt } };
                } else {
                    const codePrompt = `Create a complete, single-file webpage using HTML, Tailwind CSS, and JavaScript. The page should be about: ${prompt}. Provide only the code in a single HTML markdown block. Do not add any explanation outside the code block.`;
                    const codeContent = await generateText(codePrompt, []);
                    if(codeContent) aiMessage = { id: aiMessageId, role: 'assistant', type: 'code', content: codeContent };
                }

                if (aiMessage) {
                    currentChat.history.push(aiMessage);
                    addMessageToUI(aiMessage.role, aiMessage.content, aiMessage.type, aiMessage.id);
                }
                saveState();
            } catch (error) {
                addMessageToUI('assistant', `**خطا:** متاسفانه در فرآیند خلق مشکلی پیش آمد.\n\n\`\`\`\n${error.message}\n\`\`\``, 'text', `msg-${Date.now() + 1}`);
            } finally {
                hideLoadingIndicator();
                toggleForm(true);
            }
        };

        const stopRecording = () => {
            if (recognition) recognition.stop();
            state.isRecording = false;
            elements.micBtn.classList.remove('mic-active');
        };

        const setupSpeechRecognition = () => {
            window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!window.SpeechRecognition) {
                elements.micBtn.disabled = true;
                return;
            }
            recognition = new SpeechRecognition();
            recognition.lang = 'fa-IR';
            recognition.interimResults = false;
            recognition.continuous = false;

            recognition.onresult = (event) => {
                elements.userInput.value = event.results[0][0].transcript;
            };
            recognition.onerror = (event) => console.error('Speech recognition error', event.error);
            recognition.onend = stopRecording;
        };

        const startRecording = () => {
            state.isRecording = true;
            elements.micBtn.classList.add('mic-active');
            recognition.start();
        };
        
        const showWelcomeScreen = () => {
            elements.chatContainer.innerHTML = `
                <div class="text-center h-full flex flex-col justify-center items-center">
                    <i data-lucide="bot" class="w-24 h-24 mb-4 text-[var(--accent-color)]"></i>
                    <h2 class="text-2xl font-bold">استودیو هوش مصنوعی</h2>
                    <p class="text-[var(--text-secondary)] mt-2">چطور میتونم امروز به شما کمک کنم؟</p>
                    <div class="grid grid-cols-2 gap-4 mt-8 max-w-md w-full">
                        <button class="welcome-prompt-btn">یک شعر درباره بهار بگو</button>
                        <button class="welcome-prompt-btn">ایده برای یک پست اینستاگرام</button>
                        <button class="welcome-prompt-btn">یک تابع جاوااسکریپت بنویس</button>
                        <button class="welcome-prompt-btn">پایتخت استرالیا کجاست؟</button>
                    </div>
                </div>
            `;
            document.querySelectorAll('.welcome-prompt-btn').forEach(btn => {
                btn.className = 'p-4 border border-[var(--border-color)] rounded-lg hover:border-[var(--accent-color)] hover:bg-gray-500/10 transition-all text-sm';
                btn.addEventListener('click', () => {
                    elements.userInput.value = btn.textContent;
                    handleUserMessage(btn.textContent);
                });
            });
            lucide.createIcons();
        };

        const loadChat = (chatId, isRerender = false) => {
            if (!chatId || !state.conversations[chatId]) {
                const chatIds = Object.keys(state.conversations);
                if (chatIds.length === 0) {
                    startNewChat();
                    return;
                }
                chatId = chatIds.sort((a,b) => (state.conversations[b].createdAt || 0) - (state.conversations[a].createdAt || 0))[0];
            }
            state.currentChatId = chatId;
            const chat = state.conversations[chatId];
            
            if (!chat || chat.history.length === 0) {
                elements.chatContainer.innerHTML = '';
                showWelcomeScreen();
                elements.chatTitle.textContent = 'گفتگوی جدید';
                elements.exportChatBtn.classList.add('hidden');
            } else {
                elements.chatTitle.textContent = chat.title;
                elements.chatContainer.innerHTML = '';
                chat.history.forEach(msg => addMessageToUI(msg.role, msg.content, msg.type, msg.id));
                elements.exportChatBtn.classList.remove('hidden');
            }

            if (!isRerender) {
                renderConversationsList();
                saveState();
            }
        };

        const startNewChat = () => {
            const newId = `chat-${Date.now()}`;
            state.conversations[newId] = { id: newId, title: 'گفتگوی جدید', history: [], createdAt: Date.now() };
            loadChat(newId);
        };

        window.speakMessage = (btn) => {
            const text = btn.closest('.relative').querySelector('.prose').innerText;
            speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'fa-IR';
            speechSynthesis.speak(utterance);
        };
        window.copyCode = (btn) => {
            const pre = btn.closest('pre');
            const code = pre.querySelector('code').innerText;
            navigator.clipboard.writeText(code).then(() => {
                btn.innerText = 'کپی شد!';
                setTimeout(() => { btn.innerText = 'کپی'; }, 2000);
            });
        };
        window.deleteMessage = (messageId) => {
            const chat = state.conversations[state.currentChatId];
            const messageIndex = chat.history.findIndex(m => m.id === messageId);
            if (messageIndex !== -1) {
                chat.history.splice(messageIndex, 1);
                document.getElementById(messageId)?.remove();
                saveState();
            }
        };
        window.editMessage = (messageId) => {
            const messageEl = document.getElementById(messageId);
            const proseEl = messageEl.querySelector('.prose');
            const currentText = state.conversations[state.currentChatId].history.find(m => m.id === messageId).content;
            
            const editArea = document.createElement('textarea');
            editArea.className = 'w-full p-2 border border-[var(--border-color)] rounded-md bg-transparent';
            editArea.value = currentText;
            
            const saveBtn = document.createElement('button');
            saveBtn.className = 'px-3 py-1 bg-green-500 text-white rounded-md mt-2';
            saveBtn.textContent = 'ذخیره';
            
            proseEl.innerHTML = '';
            proseEl.appendChild(editArea);
            proseEl.appendChild(saveBtn);
            
            saveBtn.onclick = () => {
                handleUserMessage(editArea.value, null, true, messageId);
            };
        };

        const init = () => {
            lucide.createIcons();
            loadState();
            applyTheme();
            setupSpeechRecognition();
            
            elements.systemPromptInput.value = state.settings.systemPrompt;
            elements.creativitySlider.value = state.settings.creativity;
            elements.creativityValue.textContent = state.settings.creativity;

            loadChat(state.currentChatId);

            elements.chatForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleUserMessage(elements.userInput.value);
                elements.userInput.value = '';
                elements.userInput.style.height = 'auto';
            });
            elements.userInput.addEventListener('input', () => {
                elements.userInput.style.height = 'auto';
                elements.userInput.style.height = (elements.userInput.scrollHeight) + 'px';
            });
            elements.sidebarToggle.addEventListener('click', () => {
                elements.appWrapper.classList.toggle('sidebar-closed');
            });
            elements.newChatBtn.addEventListener('click', startNewChat);

            document.querySelectorAll('[data-close-modal]').forEach(btn => btn.addEventListener('click', () => {
                btn.closest('.fixed').classList.add('hidden');
            }));
            elements.settingsBtn.addEventListener('click', () => elements.settingsModal.classList.remove('hidden'));
            elements.aboutBtn.addEventListener('click', () => elements.aboutModal.classList.remove('hidden'));
            elements.upgradeProBtn.addEventListener('click', () => elements.proModal.classList.remove('hidden'));
            elements.createBtn.addEventListener('click', () => {
                elements.createModal.classList.remove('hidden');
                elements.createForm.classList.add('hidden');
                elements.createOptions.classList.remove('hidden');
            });
            elements.createOptions.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (btn) {
                    currentCreateType = btn.dataset.type;
                    elements.createOptions.classList.add('hidden');
                    elements.createForm.classList.remove('hidden');
                    elements.createPrompt.placeholder = `توصیف دقیق برای ${currentCreateType === 'image' ? 'تصویر' : 'وب‌سایت'}...`;
                    elements.createPrompt.focus();
                }
            });
            elements.createForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleCreateCommand(elements.createPrompt.value, currentCreateType);
                elements.createModal.classList.add('hidden');
                elements.createPrompt.value = '';
            });
            
            elements.themeSelector.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (btn && btn.dataset.theme) {
                    state.settings.theme = btn.dataset.theme;
                    applyTheme();
                    saveState();
                }
            });
            elements.systemPromptInput.addEventListener('change', () => { state.settings.systemPrompt = elements.systemPromptInput.value; saveState(); });
            elements.creativitySlider.addEventListener('input', (e) => { elements.creativityValue.textContent = e.target.value; });
            elements.creativitySlider.addEventListener('change', (e) => { state.settings.creativity = e.target.value; saveState(); });
            elements.clearAllBtn.addEventListener('click', () => {
                state.conversations = {};
                startNewChat();
            });
            elements.conversationsList.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('[data-delete-id]');
                if (deleteBtn) {
                    const chatId = deleteBtn.dataset.deleteId;
                    delete state.conversations[chatId];
                    if (state.currentChatId === chatId) {
                        state.currentChatId = null;
                        loadChat(null);
                    }
                    renderConversationsList();
                    saveState();
                }
            });
            elements.exportChatBtn.addEventListener('click', () => {
                const chat = state.conversations[state.currentChatId];
                if (!chat) return;
                let chatContent = `عنوان: ${chat.title}\n\n`;
                chat.history.forEach(msg => {
                    const role = msg.role === 'user' ? 'شما' : 'هوش مصنوعی';
                    chatContent += `[${role}]: ${typeof msg.content === 'object' ? msg.content.prompt || msg.content.text : msg.content}\n\n`;
                });
                const blob = new Blob([chatContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${chat.title.replace(/ /g, '_')}.txt`;
                a.click();
                URL.revokeObjectURL(url);
            });

            elements.micBtn.addEventListener('click', () => state.isRecording ? stopRecording() : startRecording());
            elements.fileUploadBtn.addEventListener('click', () => elements.fileInput.click());
            elements.fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const base64Data = event.target.result.split(',')[1];
                        const fileData = { url: event.target.result, base64Data, mimeType: file.type };
                        const promptText = prompt("توضیحی برای این تصویر بنویسید (اختیاری):");
                        handleUserMessage(promptText || "این تصویر را تحلیل کن", fileData);
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Settings Import/Export
            elements.exportSettingsBtn.addEventListener('click', () => {
                const settingsJson = JSON.stringify(state.settings, null, 2);
                const blob = new Blob([settingsJson], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ai-studio-settings.json';
                a.click();
                URL.revokeObjectURL(url);
            });
            elements.importSettingsBtn.addEventListener('click', () => {
                elements.importSettingsInput.click();
            });
            elements.importSettingsInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedSettings = JSON.parse(event.target.result);
                        state.settings = { ...state.settings, ...importedSettings };
                        applyTheme();
                        elements.systemPromptInput.value = state.settings.systemPrompt;
                        elements.creativitySlider.value = state.settings.creativity;
                        elements.creativityValue.textContent = state.settings.creativity;
                        saveState();
                        alert('تنظیمات با موفقیت وارد شد!');
                    } catch (err) {
                        alert('خطا در خواندن فایل تنظیمات. لطفاً از یک فایل معتبر استفاده کنید.');
                        console.error("Error parsing settings file:", err);
                    }
                };
                reader.readAsText(file);
            });
        };

        init();
    });
    </script>
</body>
</html>