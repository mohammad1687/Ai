
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>استودیو هوش مصنوعی</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Highlight.js for code syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- Vazirmatn Font -->
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.395.0/dist/umd/lucide.min.js"></script>

    <style>
        /* --- CSS Variables for Theming --- */
        :root {
            --bg-primary: #f4f7fe; --bg-secondary: #ffffff; --text-primary: #1a202c; --text-secondary: #718096; --accent-color: #4a90e2; --accent-color-dark: #3a7bc8; --sidebar-bg: #ffffff; --border-color: #e2e8f0; --pro-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --vh: 1vh; --font-size: 14px;
        }
        .dark {
            --bg-primary: #121212; --bg-secondary: #1E1E1E; --text-primary: #e2e2e2; --text-secondary: #a0a0a0; --accent-color: #58a6ff; --accent-color-dark: #388bfd; --sidebar-bg: #1E1E1E; --border-color: #333333; --pro-bg: linear-gradient(135deg, #303a52 0%, #574b90 100%);
        }
        .theme-ocean { --bg-primary: #E0F7FA; --bg-secondary: #FFFFFF; --text-primary: #004D40; --text-secondary: #00796B; --accent-color: #00BCD4; --accent-color-dark: #0097A7; --sidebar-bg: #B2EBF2; --border-color: #4DD0E1; --pro-bg: linear-gradient(135deg, #00BCD4 0%, #00796B 100%); }
        .theme-forest { --bg-primary: #E8F5E9; --bg-secondary: #FFFFFF; --text-primary: #1B5E20; --text-secondary: #388E3C; --accent-color: #4CAF50; --accent-color-dark: #388E3C; --sidebar-bg: #C8E6C9; --border-color: #A5D6A7; --pro-bg: linear-gradient(135deg, #4CAF50 0%, #1B5E20 100%); }
        .theme-rose { --bg-primary: #FCE4EC; --bg-secondary: #FFFFFF; --text-primary: #880E4F; --text-secondary: #C2185B; --accent-color: #E91E63; --accent-color-dark: #C2185B; --sidebar-bg: #F8BBD0; --border-color: #F48FB1; --pro-bg: linear-gradient(135deg, #E91E63 0%, #880E4F 100%); }
        .theme-sunset { --bg-primary: #fde68a; --bg-secondary: #ffffff; --text-primary: #7c2d12; --text-secondary: #b45309; --accent-color: #f97316; --accent-color-dark: #ea580c; --sidebar-bg: #fef3c7; --border-color: #fcd34d; --pro-bg: linear-gradient(135deg, #f97316 0%, #c2410c 100%); }
        .theme-mint { --bg-primary: #d1fae5; --bg-secondary: #ffffff; --text-primary: #064e3b; --text-secondary: #047857; --accent-color: #10b981; --accent-color-dark: #059669; --sidebar-bg: #a7f3d0; --border-color: #6ee7b7; --pro-bg: linear-gradient(135deg, #10b981 0%, #065f46 100%); }
        .theme-graphite { --bg-primary: #e5e7eb; --bg-secondary: #f9fafb; --text-primary: #111827; --text-secondary: #4b5563; --accent-color: #6b7280; --accent-color-dark: #4b5563; --sidebar-bg: #f3f4f6; --border-color: #d1d5db; --pro-bg: linear-gradient(135deg, #6b7280 0%, #1f2937 100%); }

        body { font-family: 'Vazirmatn', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; font-size: var(--font-size); }
        
        #app-wrapper { height: 100vh; height: calc(var(--vh, 1vh) * 100); }
        #sidebar { transition: transform 0.3s ease-in-out, width 0.3s ease-in-out; flex-shrink: 0; }
        
        @media (max-width: 767px) {
            #sidebar { transform: translateX(100%); position: absolute; }
            #app-wrapper.sidebar-open #sidebar { transform: translateX(0); }
        }
        @media (min-width: 768px) {
            #app-wrapper.sidebar-closed #sidebar { transform: translateX(100%); width: 0; padding: 0; border: none; }
             #app-wrapper.sidebar-closed #sidebar > * { display: none; }
        }

        .prose pre { position: relative; background-color: #282c34; color: #abb2bf; padding: 2.5em 1em 1em; border-radius: 8px; overflow-x: auto; }
        .code-header { position: absolute; top: 0; left: 0; right: 0; display: flex; justify-content: space-between; align-items: center; padding: 4px 12px; background-color: #374151; color: white; border-top-left-radius: 8px; border-top-right-radius: 8px; font-size: 0.8em; }
        .copy-code-btn { background: none; border: none; color: white; cursor: pointer; padding: 4px; border-radius: 4px; }
        .copy-code-btn:hover { background-color: #4b5563; }
        textarea::-webkit-scrollbar { display: none; }
        .mic-active { color: red; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); } }

        .typing-cursor { display: inline-block; width: 8px; height: 1.2em; background-color: var(--text-primary); animation: blink 1s step-end infinite; }
        @keyframes blink { from, to { background-color: transparent } 50% { background-color: var(--text-primary); } }
        .toggle-switch { position: relative; display: inline-block; width: 40px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .toggle-slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: var(--accent-color); }
        input:checked + .toggle-slider:before { transform: translateX(16px); }
        
        .settings-nav-btn.active { background-color: var(--accent-color); color: white; }
    </style>
</head>
<body class="overflow-hidden">
    <div id="app-wrapper" class="relative flex h-screen w-screen">
        <div id="sidebar-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden"></div>
        <aside id="sidebar" class="h-full w-72 bg-[var(--sidebar-bg)] flex flex-col z-40 border-l border-[var(--border-color)] shadow-lg">
            <div class="p-4 flex justify-between items-center border-b border-[var(--border-color)]">
                <h2 class="font-bold text-lg">تاریخچه</h2>
                <div class="flex items-center">
                    <input type="file" id="import-chat-input" class="hidden" accept=".json">
                    <button id="import-chat-btn" class="p-2 rounded-md hover:bg-gray-300/50 dark:hover:bg-gray-600/50" title="ورود گفتگو"><i data-lucide="import"></i></button>
                    <button id="new-chat-btn" class="p-2 rounded-md hover:bg-gray-300/50 dark:hover:bg-gray-600/50" title="گفتگوی جدید"><i data-lucide="plus-square"></i></button>
                </div>
            </div>
            <div class="p-2 border-b border-[var(--border-color)]">
                <input type="search" id="search-input" placeholder="جستجو در گفتگوها..." class="w-full p-2 text-sm border border-[var(--border-color)] rounded-md bg-transparent focus:ring-2 focus:ring-[var(--accent-color)] outline-none">
            </div>
            <nav id="conversations-list" class="flex-1 overflow-y-auto p-2 space-y-1"></nav>
            <div class="p-3 border-t border-[var(--border-color)] space-y-2">
                 <button id="persona-btn" class="w-full text-right flex items-center gap-3 p-2 rounded-md hover:bg-gray-300/50 dark:hover:bg-gray-600/50"><i data-lucide="user-circle"></i><span>انتخاب شخصیت</span></button>
                 <button id="prompt-library-btn" class="w-full text-right flex items-center gap-3 p-2 rounded-md hover:bg-gray-300/50 dark:hover:bg-gray-600/50"><i data-lucide="library"></i><span>کتابخانه دستورات</span></button>
                 <button id="upgrade-pro-btn" class="w-full text-white font-bold flex items-center justify-center gap-3 p-3 rounded-lg hover:opacity-90 transition-opacity" style="background: var(--pro-bg);"><i data-lucide="zap"></i><span>ارتقاء به پرو</span></button>
                 <button id="settings-btn" class="w-full text-right flex items-center gap-3 p-2 rounded-md hover:bg-gray-300/50 dark:hover:bg-gray-600/50"><i data-lucide="settings"></i><span>تنظیمات</span></button>
                 <button id="about-btn" class="w-full text-right flex items-center gap-3 p-2 rounded-md hover:bg-gray-300/50 dark:hover:bg-gray-600/50"><i data-lucide="info"></i><span>درباره ما</span></button>
            </div>
        </aside>

        <main id="main-content" class="flex-1 flex flex-col bg-[var(--bg-primary)] min-w-0">
            <header class="flex items-center justify-between p-4 border-b border-[var(--border-color)] bg-[var(--bg-secondary)]/80 backdrop-blur-sm">
                <button id="sidebar-toggle" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="panel-left"></i></button>
                <h1 id="chat-title" class="text-lg font-semibold text-center flex-1 truncate px-4"></h1>
                <div class="flex items-center gap-2">
                    <button id="summarize-chat-btn" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 hidden" title="خلاصه سازی گفتگو"><i data-lucide="book-text"></i></button>
                    <button id="export-chat-btn" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 hidden" title="خروجی گرفتن (JSON)"><i data-lucide="download"></i></button>
                    <button id="fullscreen-btn" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700" title="تمام صفحه"><i data-lucide="maximize"></i></button>
                </div>
            </header>
            <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-6"></div>
            <footer class="p-4 bg-transparent">
                <div id="loading-indicator-container" class="hidden items-center justify-center mx-auto mb-2">
                    <!-- Loading animation will be injected here -->
                </div>
                <div class="relative">
                    <form id="chat-form" class="flex items-end gap-2 bg-[var(--bg-secondary)] p-3 rounded-2xl shadow-lg border border-[var(--border-color)]">
                        <input type="file" id="file-input" class="hidden" accept="image/*,text/plain,text/markdown,.js,.py,.html,.css" />
                        <button type="button" id="file-upload-btn" class="p-2 self-center flex-shrink-0 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" title="ارسال فایل"><i data-lucide="paperclip"></i></button>
                        <button type="button" id="mic-btn" class="p-2 self-center flex-shrink-0 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" title="ضبط صدا"><i data-lucide="mic"></i></button>
                        <textarea id="user-input" placeholder="پیام خود را بنویسید... (Ctrl+Enter برای ارسال)" class="flex-1 bg-transparent focus:outline-none resize-none px-2 py-2 max-h-48" rows="1"></textarea>
                        <button type="button" id="create-btn" class="p-2 self-center flex-shrink-0 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" title="خلق کردن"><i data-lucide="sparkles"></i></button>
                        <button type="submit" id="send-btn" class="bg-[var(--accent-color)] text-white p-3 self-center flex-shrink-0 rounded-full transition-colors hover:bg-[var(--accent-color-dark)] disabled:opacity-50 disabled:cursor-not-allowed"><i data-lucide="arrow-up"></i></button>
                        <button type="button" id="stop-btn" class="bg-red-500 text-white p-3 self-center flex-shrink-0 rounded-full hidden" title="توقف"><i data-lucide="square"></i></button>
                    </form>
                    <div id="char-counter" class="absolute bottom-0 left-4 text-xs text-[var(--text-secondary)] -mb-5">0</div>
                </div>
            </footer>
        </main>
    </div>
    
    <!-- Modals -->
    <div id="alert-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
        <div class="bg-[var(--bg-secondary)] rounded-2xl shadow-xl p-6 w-full max-w-sm mx-auto" data-modal-content>
            <div class="text-center">
                <i data-lucide="alert-triangle" class="w-12 h-12 mx-auto text-yellow-500"></i>
                <h3 id="alert-title" class="text-lg font-bold mt-4">توجه</h3>
                <p id="alert-body" class="text-sm text-[var(--text-secondary)] mt-2"></p>
                <button id="alert-ok-btn" class="mt-6 w-full p-2 rounded-lg bg-[var(--accent-color)] text-white">متوجه شدم</button>
            </div>
        </div>
    </div>

    <div id="about-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
        <div class="bg-[var(--bg-secondary)] rounded-2xl shadow-xl p-6 w-full max-w-2xl mx-auto" data-modal-content>
            <div class="flex justify-between items-center mb-4">
                 <h3 class="text-2xl font-bold">درباره استودیو هوش مصنوعی</h3>
                 <button class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-close-modal><i data-lucide="x"></i></button>
            </div>
            <div class="space-y-4 text-justify text-[var(--text-primary)]">
                <details class="bg-gray-500/10 p-3 rounded-lg" open>
                    <summary class="font-semibold cursor-pointer">چشم‌انداز ما</summary>
                    <p class="mt-2 text-sm text-[var(--text-secondary)]">
                        هدف ما، فراهم کردن یک دستیار هوشمند، خلاق و در دسترس برای تمام کاربران فارسی‌زبان است. ما به دنبال دموکراتیک کردن فناوری هوش مصنوعی در یک محیط کاربری ساده و زیبا هستیم.
                    </p>
                </details>
                <details class="bg-gray-500/10 p-3 rounded-lg">
                    <summary class="font-semibold cursor-pointer">توسعه‌دهنده</summary>
                    <p class="mt-2 text-sm text-[var(--text-secondary)]">
                        این پروژه با افتخار توسط <strong class="text-[var(--accent-color)]">محمد امین</strong>، توسعه‌دهنده علاقه‌مند به وب و هوش مصنوعی، طراحی و اجرا شده است.
                    </p>
                </details>
                <details class="bg-gray-500/10 p-3 rounded-lg">
                    <summary class="font-semibold cursor-pointer">فناوری‌های کلیدی</summary>
                    <ul class="list-disc list-inside mt-2 text-sm text-[var(--text-secondary)] space-y-1">
                        <li><strong>هوش مصنوعی:</strong> Google Gemini</li>
                        <li><strong>طراحی رابط کاربری:</strong> Tailwind CSS</li>
                        <li><strong>منطق برنامه:</strong> Vanilla JavaScript</li>
                    </ul>
                </details>
            </div>
        </div>
    </div>
    
    <div id="create-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
        <div class="bg-[var(--bg-secondary)] rounded-2xl shadow-xl p-6 w-full max-w-2xl mx-auto" data-modal-content>
            <div class="flex justify-between items-center mb-4">
                 <h3 class="text-xl font-bold">استودیو خلق</h3>
                 <button class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-close-modal><i data-lucide="x"></i></button>
            </div>
            <p class="text-[var(--text-secondary)] mb-6">ابزار مورد نظر خود را برای خلق کردن انتخاب کنید.</p>
            <div id="create-options" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button data-type="image" class="text-right p-4 border border-[var(--border-color)] rounded-lg hover:border-[var(--accent-color)] hover:bg-gray-500/10 transition-all group">
                    <i data-lucide="image" class="w-8 h-8 mb-2 text-[var(--accent-color)]"></i>
                    <h4 class="font-bold text-lg">خلق تصویر</h4>
                    <p class="text-sm text-[var(--text-secondary)]">ایده‌های خود را به تصاویر هنری و واقعی تبدیل کنید.</p>
                </button>
                <button data-type="code" class="text-right p-4 border border-[var(--border-color)] rounded-lg hover:border-[var(--accent-color)] hover:bg-gray-500/10 transition-all group">
                    <i data-lucide="code-2" class="w-8 h-8 mb-2 text-[var(--accent-color)]"></i>
                    <h4 class="font-bold text-lg">خلق وب‌سایت</h4>
                    <p class="text-sm text-[var(--text-secondary)]">یک صفحه وب کامل با HTML, CSS و JS بسازید.</p>
                </button>
            </div>
            <form id="create-form" class="hidden mt-6">
                <textarea id="create-prompt" rows="4" class="w-full p-2 border border-[var(--border-color)] rounded-md bg-transparent focus:ring-2 focus:ring-[var(--accent-color)] outline-none" required></textarea>
                <div class="flex justify-end gap-4 mt-4">
                    <button type="button" data-close-modal class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg">انصراف</button>
                    <button type="submit" class="px-4 py-2 bg-[var(--accent-color)] text-white rounded-lg">شروع کن!</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="settings-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
        <div class="bg-[var(--bg-secondary)] rounded-2xl shadow-xl w-full max-w-4xl mx-auto flex" style="height: 80vh;" data-modal-content>
            <div class="w-1/4 border-l border-[var(--border-color)] p-4 flex flex-col">
                <nav class="space-y-2">
                    <button data-tab="general" class="settings-nav-btn w-full text-right flex items-center gap-3 p-2 rounded-md active"><i data-lucide="sliders-horizontal"></i><span>عمومی</span></button>
                    <button data-tab="personalization" class="settings-nav-btn w-full text-right flex items-center gap-3 p-2 rounded-md"><i data-lucide="user-cog"></i><span>شخصی‌سازی</span></button>
                    <button data-tab="data" class="settings-nav-btn w-full text-right flex items-center gap-3 p-2 rounded-md"><i data-lucide="database"></i><span>مدیریت داده‌ها</span></button>
                    <button data-tab="api" class="settings-nav-btn w-full text-right flex items-center gap-3 p-2 rounded-md"><i data-lucide="key-round"></i><span>کلید API</span></button>
                </nav>
                <div class="mt-auto">
                    <button data-close-modal class="w-full text-center p-2 bg-gray-200 dark:bg-gray-600 rounded-lg">بستن</button>
                </div>
            </div>
            <div class="flex-1 p-6 overflow-y-auto">
                <!-- General Tab -->
                <div id="settings-tab-general" class="settings-tab-content space-y-6">
                    <h3 class="text-xl font-bold">عمومی</h3>
                    <div>
                        <label class="block mb-2 font-semibold">انتخاب تم</label>
                        <div id="theme-selector" class="flex flex-wrap gap-2">
                            <button data-theme="light" class="w-8 h-8 rounded-full bg-gray-200 ring-2 ring-offset-2 ring-offset-[var(--bg-primary)]" title="روشن"></button>
                            <button data-theme="dark" class="w-8 h-8 rounded-full bg-gray-800 ring-2 ring-offset-2 ring-offset-[var(--bg-primary)]" title="تاریک"></button>
                            <button data-theme="ocean" class="w-8 h-8 rounded-full bg-[#00BCD4] ring-2 ring-offset-2 ring-offset-[var(--bg-primary)]" title="اقیانوس"></button>
                            <button data-theme="forest" class="w-8 h-8 rounded-full bg-[#4CAF50] ring-2 ring-offset-2 ring-offset-[var(--bg-primary)]" title="جنگل"></button>
                            <button data-theme="rose" class="w-8 h-8 rounded-full bg-[#E91E63] ring-2 ring-offset-2 ring-offset-[var(--bg-primary)]" title="رز"></button>
                            <button data-theme="sunset" class="w-8 h-8 rounded-full bg-[#f97316] ring-2 ring-offset-2 ring-offset-[var(--bg-primary)]" title="غروب"></button>
                            <button data-theme="mint" class="w-8 h-8 rounded-full bg-[#10b981] ring-2 ring-offset-2 ring-offset-[var(--bg-primary)]" title="نعنا"></button>
                            <button data-theme="graphite" class="w-8 h-8 rounded-full bg-[#6b7280] ring-2 ring-offset-2 ring-offset-[var(--bg-primary)]" title="گرافیت"></button>
                        </div>
                    </div>
                    <div>
                        <label for="font-size-slider" class="block mb-2 font-semibold">اندازه فونت: <span id="font-size-value">متوسط</span></label>
                        <input id="font-size-slider" type="range" min="12" max="18" step="2" class="w-full">
                    </div>
                    <div>
                        <label class="flex items-center justify-between">
                            <span class="font-semibold">انیمیشن تایپ</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="animation-toggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </label>
                    </div>
                </div>
                <!-- Personalization Tab -->
                <div id="settings-tab-personalization" class="settings-tab-content space-y-6 hidden">
                    <h3 class="text-xl font-bold">شخصی‌سازی</h3>
                    <div>
                        <label class="block mb-2 font-semibold">انتخاب مدل</label>
                        <div id="model-selector" class="flex gap-4">
                            <label class="flex items-center gap-2"><input type="radio" name="model" value="gemini-1.5-flash-latest" checked><span>سریع</span></label>
                            <label class="flex items-center gap-2"><input type="radio" name="model" value="gemini-1.5-pro-latest"><span>قدرتمند</span></label>
                        </div>
                    </div>
                    <div>
                        <label class="block mb-2 font-semibold">شخصیت هوش مصنوعی (System Prompt)</label>
                        <textarea id="system-prompt-input" rows="4" class="w-full p-2 border border-[var(--border-color)] rounded-md bg-transparent focus:ring-2 focus:ring-[var(--accent-color)] outline-none" placeholder="مثال: تو یک دستیار برنامه‌نویس هستی که به زبان پایتون مسلط است."></textarea>
                    </div>
                    <div>
                        <label for="history-length-slider" class="block mb-2 font-semibold">حافظه گفتگو (تعداد پیام‌های قبلی): <span id="history-length-value">10</span></label>
                        <input id="history-length-slider" type="range" min="0" max="20" step="2" class="w-full">
                    </div>
                </div>
                <!-- Data Tab -->
                <div id="settings-tab-data" class="settings-tab-content space-y-6 hidden">
                     <h3 class="text-xl font-bold">مدیریت داده‌ها</h3>
                     <div>
                        <label class="block mb-2 font-semibold">مدیریت تنظیمات</label>
                        <div class="flex gap-2">
                            <input type="file" id="import-settings-input" class="hidden" accept=".json">
                            <button id="import-settings-btn" class="flex-1 text-center p-2 rounded-md border border-[var(--border-color)] hover:bg-gray-500/10">ورود تنظیمات</button>
                            <button id="export-settings-btn" class="flex-1 text-center p-2 rounded-md border border-[var(--border-color)] hover:bg-gray-500/10">خروج تنظیمات</button>
                        </div>
                    </div>
                    <div>
                        <label class="block mb-2 font-semibold">خروجی تمام گفتگوها</label>
                        <button id="export-all-chats-btn" class="w-full text-center p-2 rounded-md border border-[var(--border-color)] hover:bg-gray-500/10">ذخیره تمام گفتگوها (JSON)</button>
                    </div>
                    <div>
                        <label class="block mb-2 font-semibold">عملیات خطرناک</label>
                        <button id="clear-all-btn" class="w-full text-left p-3 rounded-md bg-red-500 text-white hover:bg-red-600 flex items-center gap-2"><i data-lucide="trash-2"></i>پاک کردن تمام داده‌ها</button>
                    </div>
                </div>
                <!-- API Tab -->
                <div id="settings-tab-api" class="settings-tab-content space-y-6 hidden">
                    <h3 class="text-xl font-bold">کلید API</h3>
                    <div>
                        <label class="block mb-2 font-semibold">کلید API گوگل</label>
                        <input type="password" id="api-key-input" placeholder="کلید خود را اینجا وارد کنید..." class="w-full p-2 text-sm border border-[var(--border-color)] rounded-md bg-transparent focus:ring-2 focus:ring-[var(--accent-color)] outline-none">
                        <p class="text-xs text-[var(--text-secondary)] mt-1">کلید شما به صورت امن در مرورگر شما ذخیره می‌شود.</p>
                    </div>
                    <div>
                        <label class="block mb-2 font-semibold">مصرف API در این نشست</label>
                        <p class="text-sm text-[var(--text-secondary)]">تعداد کل فراخوانی‌ها: <span id="api-call-counter">0</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="pro-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
        <div class="bg-[var(--bg-secondary)] rounded-2xl shadow-xl w-full max-w-4xl mx-auto" data-modal-content>
            <div class="p-6">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-bold">به دنیای حرفه‌ای‌ها خوش آمدید!</h3>
                    <button data-close-modal class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="x"></i></button>
                </div>
                <p class="text-[var(--text-secondary)] mt-2">با عضویت ویژه، قفل تمام قابلیت‌ها را باز کنید.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 p-6 bg-[var(--bg-primary)]">
                <div class="border border-[var(--border-color)] rounded-lg p-6 bg-[var(--bg-secondary)] text-center">
                    <h4 class="font-bold text-lg">پایه</h4>
                    <p class="text-3xl font-bold my-4">$10 <span class="text-sm font-normal">/ماهانه</span></p>
                    <ul class="space-y-2 text-sm text-[var(--text-secondary)]"><li>✓ 100 خلق تصویر</li><li>✓ 50 خلق وبسایت</li><li>✓ پشتیبانی استاندارد</li></ul>
                    <button class="mt-6 w-full p-2 rounded-lg border border-[var(--accent-color)] text-[var(--accent-color)] hover:bg-[var(--accent-color)] hover:text-white transition-colors">شروع کنید</button>
                </div>
                <div class="border-2 border-[var(--accent-color)] rounded-lg p-6 bg-[var(--bg-secondary)] text-center relative">
                    <div class="absolute -top-3 right-1/2 translate-x-1/2 bg-[var(--accent-color)] text-white px-3 py-1 rounded-full text-xs font-bold">محبوب‌ترین</div>
                    <h4 class="font-bold text-lg">حرفه‌ای</h4>
                    <p class="text-3xl font-bold my-4">$25 <span class="text-sm font-normal">/ماهانه</span></p>
                    <ul class="space-y-2 text-sm text-[var(--text-secondary)]"><li>✓ خلق تصویر نامحدود</li><li>✓ خلق وبسایت نامحدود</li><li>✓ دسترسی به مدل‌های جدید</li><li>✓ پشتیبانی ویژه</li></ul>
                    <button class="mt-6 w-full p-2 rounded-lg bg-[var(--accent-color)] text-white hover:bg-[var(--accent-color-dark)] transition-colors">همین حالا بخرید</button>
                </div>
                <div class="border border-[var(--border-color)] rounded-lg p-6 bg-[var(--bg-secondary)] text-center">
                    <h4 class="font-bold text-lg">سازمانی</h4>
                    <p class="text-3xl font-bold my-4">تماس بگیرید</p>
                    <ul class="space-y-2 text-sm text-[var(--text-secondary)]"><li>✓ تمام قابلیت‌های حرفه‌ای</li><li>✓ مدیریت تیم</li><li>✓ پشتیبانی اختصاصی</li></ul>
                    <button class="mt-6 w-full p-2 rounded-lg border border-[var(--accent-color)] text-[var(--accent-color)] hover:bg-[var(--accent-color)] hover:text-white transition-colors">تماс با ما</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="prompt-library-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
        <div class="bg-[var(--bg-secondary)] rounded-2xl shadow-xl p-6 w-full max-w-4xl mx-auto flex flex-col" style="height: 80vh;" data-modal-content>
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                 <h3 class="text-2xl font-bold">کتابخانه دستورات</h3>
                 <button id="random-prompt-btn" class="p-2 rounded-md hover:bg-gray-300/50 dark:hover:bg-gray-600/50" title="شگفت‌زده‌ام کن!"><i data-lucide="shuffle"></i></button>
                 <button class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-close-modal><i data-lucide="x"></i></button>
            </div>
            <div class="flex-grow overflow-y-auto">
                <div id="prompt-categories" class="space-y-4">
                    <!-- Prompt categories and items will be injected by JS -->
                </div>
            </div>
        </div>
    </div>

    <div id="persona-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
        <div class="bg-[var(--bg-secondary)] rounded-2xl shadow-xl p-6 w-full max-w-4xl mx-auto flex flex-col" style="height: 80vh;" data-modal-content>
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                 <h3 class="text-2xl font-bold">انتخاب شخصیت</h3>
                 <button class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-close-modal><i data-lucide="x"></i></button>
            </div>
            <div id="persona-list" class="flex-grow overflow-y-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Personas will be injected by JS -->
            </div>
        </div>
    </div>

    <div id="markdown-preview-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
        <div class="bg-[var(--bg-secondary)] rounded-2xl shadow-xl p-6 w-full max-w-4xl mx-auto flex flex-col" style="height: 80vh;" data-modal-content>
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                 <h3 class="text-2xl font-bold">ویرایشگر Markdown</h3>
                 <button class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-close-modal><i data-lucide="x"></i></button>
            </div>
            <div class="flex-grow grid grid-cols-2 gap-4 overflow-hidden">
                <textarea id="markdown-input" class="w-full h-full p-2 border border-[var(--border-color)] rounded-md bg-transparent resize-none"></textarea>
                <div id="markdown-preview" class="w-full h-full p-2 border border-[var(--border-color)] rounded-md overflow-y-auto prose max-w-none"></div>
            </div>
            <div class="flex justify-end gap-4 mt-4 flex-shrink-0">
                <button type="button" id="markdown-send-btn" class="px-4 py-2 bg-[var(--accent-color)] text-white rounded-lg">ارسال پیام</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        // --- IMPORTANT: NO Default API Key ---
        // The user must provide their own key in the settings.
        const DEFAULT_API_KEY = "AIzaSyAwMCgjjZeoWml0oBuHzRWmQQERBghDsa8";

        const elements = {
            appWrapper: document.getElementById('app-wrapper'),
            sidebar: document.getElementById('sidebar'),
            sidebarToggle: document.getElementById('sidebar-toggle'),
            sidebarBackdrop: document.getElementById('sidebar-backdrop'),
            chatContainer: document.getElementById('chat-container'),
            chatForm: document.getElementById('chat-form'),
            userInput: document.getElementById('user-input'),
            sendBtn: document.getElementById('send-btn'),
            stopBtn: document.getElementById('stop-btn'),
            newChatBtn: document.getElementById('new-chat-btn'),
            conversationsList: document.getElementById('conversations-list'),
            chatTitle: document.getElementById('chat-title'),
            loadingIndicatorContainer: document.getElementById('loading-indicator-container'),
            micBtn: document.getElementById('mic-btn'),
            fileUploadBtn: document.getElementById('file-upload-btn'),
            fileInput: document.getElementById('file-input'),
            createBtn: document.getElementById('create-btn'),
            createModal: document.getElementById('create-modal'),
            createOptions: document.getElementById('create-options'),
            createForm: document.getElementById('create-form'),
            createPrompt: document.getElementById('create-prompt'),
            settingsBtn: document.getElementById('settings-btn'),
            settingsModal: document.getElementById('settings-modal'),
            themeSelector: document.getElementById('theme-selector'),
            systemPromptInput: document.getElementById('system-prompt-input'),
            clearAllBtn: document.getElementById('clear-all-btn'),
            upgradeProBtn: document.getElementById('upgrade-pro-btn'),
            proModal: document.getElementById('pro-modal'),
            aboutBtn: document.getElementById('about-btn'),
            aboutModal: document.getElementById('about-modal'),
            exportChatBtn: document.getElementById('export-chat-btn'),
            exportSettingsBtn: document.getElementById('export-settings-btn'),
            importSettingsBtn: document.getElementById('import-settings-btn'),
            importSettingsInput: document.getElementById('import-settings-input'),
            searchInput: document.getElementById('search-input'),
            charCounter: document.getElementById('char-counter'),
            alertModal: document.getElementById('alert-modal'),
            alertTitle: document.getElementById('alert-title'),
            alertBody: document.getElementById('alert-body'),
            alertOkBtn: document.getElementById('alert-ok-btn'),
            fullscreenBtn: document.getElementById('fullscreen-btn'),
            promptLibraryBtn: document.getElementById('prompt-library-btn'),
            promptLibraryModal: document.getElementById('prompt-library-modal'),
            promptCategoriesContainer: document.getElementById('prompt-categories'),
            modelSelector: document.getElementById('model-selector'),
            historyLengthSlider: document.getElementById('history-length-slider'),
            historyLengthValue: document.getElementById('history-length-value'),
            animationToggle: document.getElementById('animation-toggle'),
            personaBtn: document.getElementById('persona-btn'),
            personaModal: document.getElementById('persona-modal'),
            personaList: document.getElementById('persona-list'),
            importChatBtn: document.getElementById('import-chat-btn'),
            importChatInput: document.getElementById('import-chat-input'),
            markdownPreviewBtn: document.getElementById('markdown-preview-btn'),
            markdownPreviewModal: document.getElementById('markdown-preview-modal'),
            markdownInput: document.getElementById('markdown-input'),
            markdownPreview: document.getElementById('markdown-preview'),
            markdownSendBtn: document.getElementById('markdown-send-btn'),
            apiCallCounter: document.getElementById('api-call-counter'),
            apiKeyInput: document.getElementById('api-key-input'),
            randomPromptBtn: document.getElementById('random-prompt-btn'),
            summarizeChatBtn: document.getElementById('summarize-chat-btn'),
            fontSizeSlider: document.getElementById('font-size-slider'),
            fontSizeValue: document.getElementById('font-size-value'),
            exportAllChatsBtn: document.getElementById('export-all-chats-btn'),
        };

        let state = {
            conversations: {},
            currentChatId: null,
            settings: { 
                apiKey: '',
                theme: 'light', 
                systemPrompt: '', 
                model: 'gemini-1.5-flash-latest',
                historyLength: 10,
                animations: true,
                fontSize: 14,
            },
            isRecording: false,
            apiCallCount: 0,
        };
        let currentCreateType = null;
        let recognition;
        let mediaRecorder;
        let audioChunks = [];
        let apiAbortController = null;
        let typingEffectInterval = null;

        const saveState = () => localStorage.setItem('ai-studio-state', JSON.stringify(state));
        
        const loadState = () => {
            const savedState = localStorage.getItem('ai-studio-state');
            if (savedState) {
                const parsed = JSON.parse(savedState);
                state.conversations = parsed.conversations || {};
                state.currentChatId = parsed.currentChatId;
                state.settings = { ...state.settings, ...parsed.settings };
            }
        };
        
        const applyTheme = () => {
            document.body.className = `theme-${state.settings.theme} overflow-hidden`;
            document.documentElement.classList.toggle('dark', state.settings.theme === 'dark');
            if (elements.themeSelector) {
                elements.themeSelector.querySelectorAll('button').forEach(btn => {
                    btn.classList.toggle('ring-[var(--accent-color)]', btn.dataset.theme === state.settings.theme);
                });
            }
        };
        
        const applyFontSize = () => {
            document.body.style.fontSize = `${state.settings.fontSize}px`;
            if (elements.fontSizeValue) {
                const sizeMap = { 12: 'کوچک', 14: 'متوسط', 16: 'بزرگ', 18: 'خیلی بزرگ' };
                elements.fontSizeValue.textContent = sizeMap[state.settings.fontSize] || 'متوسط';
            }
        }

        const showAlert = (message, title = 'توجه') => {
            elements.alertTitle.textContent = title;
            elements.alertBody.textContent = message;
            elements.alertModal.classList.remove('hidden');
            lucide.createIcons();
        };

        const callApi = async (url, payload, retries = 3, delay = 2000) => {
            const apiKey = state.settings.apiKey || DEFAULT_API_KEY;

            if (!apiKey) {
                throw new Error("کلید API گوگل تنظیم نشده است. لطفاً از منوی تنظیمات، یک کلید معتبر وارد کنید.");
            }
            
            state.apiCallCount++;
            if(elements.apiCallCounter) elements.apiCallCounter.textContent = state.apiCallCount;

            apiAbortController = new AbortController();
            try {
                const response = await fetch(`${url}?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: apiAbortController.signal
                });
                
                // We handle 429 specifically in the main logic to show a user-friendly message.
                // No need for automatic retry here as it might just prolong the issue if the user hit a hard quota.
                
                if (!response.ok) {
                    const errorBody = await response.json().catch(() => ({ error: { message: response.statusText } }));
                    throw new Error(`API Error ${response.status}: ${errorBody.error.message}`);
                }
                return await response.json();
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('API call aborted by user.');
                    return null; 
                }
                console.error("API Call failed:", error);
                throw error;
            } finally {
                apiAbortController = null;
            }
        };

        const generateContent = async (parts, history) => {
            const historyToSend = history.slice(-state.settings.historyLength).map(msg => {
                const contentParts = [];
                if (msg.type === 'text' || msg.type === 'code') {
                    contentParts.push({ text: msg.content });
                } else if (msg.type === 'file' || msg.type === 'image') {
                    if(msg.content.prompt) contentParts.push({ text: msg.content.prompt });
                }
                
                if (contentParts.length > 0) {
                    return { role: msg.role === 'user' ? 'user' : 'model', parts: contentParts };
                }
                return null;
            }).filter(Boolean);


            if (state.settings.systemPrompt) {
                historyToSend.unshift({ role: 'model', parts: [{ text: 'OK.' }] });
                historyToSend.unshift({ role: 'user', parts: [{ text: `System instruction: ${state.settings.systemPrompt}` }] });
            }
            
            historyToSend.push({ role: 'user', parts });
            
            const model = state.settings.model;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent`;
            const payload = { contents: historyToSend };
            
            const result = await callApi(apiUrl, payload);
            if (!result) return null;
            if (!result.candidates?.[0]?.content?.parts?.[0]?.text) {
                console.error('Invalid response structure from API:', result);
                const safetyFeedback = result.candidates?.[0]?.finishReason;
                if (safetyFeedback === 'SAFETY') {
                     throw new Error('پاسخ به دلیل خط‌مشی‌های ایمنی مسدود شد.');
                }
                throw new Error('پاسخ نامعتبر از سرور دریافت شد.');
            }
            return result.candidates[0].content.parts[0].text;
        };

        const toggleForm = (enabled) => {
            elements.userInput.disabled = !enabled;
            elements.sendBtn.classList.toggle('hidden', !enabled);
            elements.stopBtn.classList.toggle('hidden', enabled);
            
            if(enabled) {
                elements.loadingIndicatorContainer.classList.add('hidden');
                elements.loadingIndicatorContainer.innerHTML = '';
            } else {
                elements.loadingIndicatorContainer.classList.remove('hidden');
                elements.loadingIndicatorContainer.innerHTML = `
                    <div class="flex items-center gap-2 text-[var(--text-secondary)]">
                        <div class="w-5 h-5 border-2 border-dashed rounded-full animate-spin border-[var(--accent-color)]"></div>
                        <span>در حال پردازش...</span>
                    </div>
                `;
            }
        };
        
        const renderConversationsList = (searchTerm = '') => {
            elements.conversationsList.innerHTML = '';
            const filteredChats = Object.values(state.conversations)
                .filter(chat => chat.title.toLowerCase().includes(searchTerm.toLowerCase()));

            filteredChats.sort((a, b) => (b.isPinned || 0) - (a.isPinned || 0) || (b.createdAt || 0) - (a.createdAt || 0));
            
            filteredChats.forEach(chat => {
                const item = document.createElement('div');
                item.className = 'flex items-center group';
                const isActive = chat.id === state.currentChatId;
                item.innerHTML = `
                    <button data-action="load-chat" data-chat-id="${chat.id}" class="flex-1 text-right p-2 rounded-md truncate ${isActive ? 'bg-blue-100 dark:bg-gray-700' : 'hover:bg-gray-300/50 dark:hover:bg-gray-600/50'}">${chat.title}</button>
                    <button data-action="toggle-pin" data-chat-id="${chat.id}" class="p-2 rounded-md text-gray-500 hover:bg-yellow-200 hover:text-yellow-600 opacity-0 group-hover:opacity-100 transition-opacity" title="پین کردن">
                        <i data-lucide="pin" class="w-4 h-4 ${chat.isPinned ? 'fill-current text-yellow-500' : ''}"></i>
                    </button>
                    <button data-action="delete-chat" data-chat-id="${chat.id}" class="p-2 rounded-md text-gray-500 hover:bg-red-200 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity" title="حذف">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                `;
                elements.conversationsList.appendChild(item);
            });
            lucide.createIcons();
        };

        const streamTextResponse = (textElement, fullText, callback) => {
            let i = 0;
            clearInterval(typingEffectInterval);
            
            textElement.innerHTML = '<span></span><span class="typing-cursor"></span>';
            const textContainer = textElement.firstChild;
            const cursor = textElement.lastChild;

            typingEffectInterval = setInterval(() => {
                if (apiAbortController && apiAbortController.signal.aborted) {
                    clearInterval(typingEffectInterval);
                    if(cursor) cursor.remove();
                    if (callback) callback(textContainer.textContent); 
                    return;
                }

                if (i < fullText.length) {
                    textContainer.textContent += fullText[i];
                    i++;
                } else {
                    clearInterval(typingEffectInterval);
                    if(cursor) cursor.remove();
                    if (callback) callback(fullText);
                }
            }, 25);
        };

        const addMessageToUI = (role, content, type = 'text', messageId, isStreaming = false) => {
            const messageWrapper = document.createElement('div');
            messageWrapper.id = `msg-${messageId}`;
            messageWrapper.className = `flex items-start gap-3 group relative ${role === 'user' ? 'justify-end' : ''}`;
            
            const avatar = `<div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg flex-shrink-0 shadow-md ${role === 'user' ? 'bg-gray-300 dark:bg-gray-600' : 'bg-gradient-to-br from-blue-400 to-purple-500 text-white'}">${role === 'user' ? 'شما' : 'AI'}</div>`;
            
            let messageContentHTML = '';
            if (type === 'image') {
                 messageContentHTML = `<div class="p-3 rounded-lg shadow-md bg-[var(--accent-color)] text-white max-w-sm"><p class="mb-2">${content.prompt}</p><img src="${content.url}" alt="Uploaded Image" class="rounded-lg" /></div>`;
            } else if (type === 'audio') {
                messageContentHTML = `<div class="p-3 rounded-lg shadow-md bg-[var(--accent-color)] text-white"><audio controls src="${content.url}"></audio></div>`;
            } else {
                const proseClass = role === 'user' ? 'bg-[var(--accent-color)] text-white' : 'bg-[var(--bg-secondary)]';
                messageContentHTML = `<div class="prose max-w-none break-words p-3 rounded-lg shadow-md ${proseClass}"></div>`;
            }

            const messageControls = role === 'user' ? `
                <div class="absolute top-1/2 -translate-y-1/2 left-0 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button onclick="editMessage('${messageId}')" class="p-1 rounded-full bg-gray-500/20 text-[var(--text-secondary)]"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                    <button onclick="deleteMessage('${messageId}')" class="p-1 rounded-full bg-gray-500/20 text-[var(--text-secondary)]"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>` : '';

            const ttsButton = role === 'assistant' ? `<button class="absolute top-2 left-2 p-1 rounded-full bg-gray-500/20 text-[var(--text-secondary)] opacity-0 group-hover:opacity-100 transition-opacity" onclick="speakMessage(this)"><i data-lucide="volume-2" class="w-4 h-4"></i></button>` : '';
            const copyButton = role === 'assistant' ? `<button class="absolute top-2 left-10 p-1 rounded-full bg-gray-500/20 text-[var(--text-secondary)] opacity-0 group-hover:opacity-100 transition-opacity" onclick="copyMessage(this)"><i data-lucide="copy" class="w-4 h-4"></i></button>` : '';
            messageWrapper.innerHTML = (role === 'user' ? messageControls : '') + (role === 'user' ? '' : avatar) + `<div class="relative">${messageContentHTML}${ttsButton}${copyButton}</div>` + (role === 'user' ? avatar : '');
            
            elements.chatContainer.appendChild(messageWrapper);

            if (type === 'text' || type === 'code' || type === 'file') {
                const textElement = messageWrapper.querySelector('.prose');
                const textContent = (type === 'file') ? `فایل \`${content.name}\` آپلود شد:\n\n\`\`\`\n${content.text}\n\`\`\`` : content;
                if (isStreaming && state.settings.animations) {
                    streamTextResponse(textElement, textContent, (streamedText) => {
                         textElement.innerHTML = marked.parse(streamedText);
                         textElement.querySelectorAll('pre').forEach(pre => {
                            const code = pre.querySelector('code');
                            if (!code) return;
                            const lang = code.className.replace('language-', '') || 'code';
                            const header = document.createElement('div');
                            header.className = 'code-header';
                            header.innerHTML = `<span>${lang}</span><button class="copy-code-btn" onclick="copyCode(this)">کپی</button>`;
                            pre.prepend(header);
                        });
                         hljs.highlightAll();
                    });
                } else {
                    textElement.innerHTML = marked.parse(textContent);
                    textElement.querySelectorAll('pre').forEach(pre => {
                        const code = pre.querySelector('code');
                        if (!code) return;
                        const lang = code.className.replace('language-', '') || 'code';
                        const header = document.createElement('div');
                        header.className = 'code-header';
                        header.innerHTML = `<span>${lang}</span><button class="copy-code-btn" onclick="copyCode(this)">کپی</button>`;
                        pre.prepend(header);
                    });
                    hljs.highlightAll();
                }
            }
            
            elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight;
            lucide.createIcons();
        };
        
        const getFriendlyErrorMessage = (error) => {
            const errorMessage = error.message || '';
            if (errorMessage.includes("API Error 429")) {
                return `**خطا: سهمیه شما تمام شده است**\n\nشما از حد مجاز استفاده از API در طرح رایگان فراتر رفته‌اید. لطفاً چند دقیقه صبر کنید و دوباره امتحان کنید. اگر این خطا ادامه داشت، باید طرح خود را در Google Cloud ارتقا دهید.\n\n[اطلاعات بیشتر درباره محدودیت‌ها](https://ai.google.dev/gemini-api/docs/rate-limits)`;
            }
            if (errorMessage.includes("API key expired")) {
                return `**خطا: کلید API منقضی شده است**\n\nکلید API که استفاده می‌کنید دیگر معتبر نیست. لطفاً یک کلید جدید از Google AI Studio دریافت کرده و در تنظیمات وارد نمایید.`;
            }
            if (errorMessage.toLowerCase().includes("failed to fetch")) {
                return `**خطا در اتصال**\n\nاتصال به سرور برقرار نشد. لطفاً موارد زیر را بررسی کنید:\n1. از اتصال اینترنت خود مطمئن شوید.\n2. اگر از VPN استفاده می‌کنید، آن را موقتاً غیرفعال کنید.\n3. برنامه را از طریق یک سرور وب (مانند GitHub Pages یا Live Server) اجرا کنید، نه به صورت مستقیم به عنوان فایل.`;
            }
            return `**خطا:** متاسفانه مشکلی در ارتباط با سرور پیش آمد.\n\n\`\`\`\n${errorMessage}\n\`\`\``;
        };

        const handleUserMessage = async (userInput, fileData = null, isEdit = false, originalMessageId = null) => {
            if (!userInput.trim() && !fileData) return;
            toggleForm(false);
            const currentChat = state.conversations[state.currentChatId];

            if (isEdit) {
                const messageIndex = currentChat.history.findIndex(m => m.id === originalMessageId);
                if (messageIndex !== -1) {
                    currentChat.history.splice(messageIndex);
                }
            }
            
            const messageId = `msg-${Date.now()}`;
            let userMessage;
            if (fileData) {
                userMessage = { id: messageId, role: 'user', type: fileData.type, content: fileData.content };
            } else {
                userMessage = { id: messageId, role: 'user', type: 'text', content: userInput };
            }
            currentChat.history.push(userMessage);
            
            loadChat(state.currentChatId, true);

            try {
                const parts = [];
                if (fileData) {
                    if (fileData.type === 'image') {
                        parts.push({ text: userInput });
                        parts.push({ inlineData: { mimeType: fileData.content.mimeType, data: fileData.content.base64Data } });
                    } else { // text file
                        const fullPrompt = `با توجه به محتوای فایل ${fileData.content.name}:\n${fileData.content.text}\n\n${userInput}`;
                        parts.push({ text: fullPrompt });
                    }
                } else {
                    parts.push({ text: userInput });
                }

                const aiResponseText = await generateContent(parts, currentChat.history.slice(0, -1));
                
                toggleForm(true);
                if (aiResponseText) {
                    const aiMessageId = `msg-${Date.now() + 1}`;
                    const aiMessage = { id: aiMessageId, role: 'assistant', type: 'text', content: aiResponseText };
                    currentChat.history.push(aiMessage);
                    addMessageToUI(aiMessage.role, aiMessage.content, aiMessage.type, aiMessage.id, true);
                }
                
                if (currentChat.history.length <= 3 && !isEdit) {
                    const titlePrompt = `این گفتگو را در 3 یا 4 کلمه برای عنوان خلاصه کن: "${userInput}"`;
                    const newTitle = await generateContent([{ text: titlePrompt }], []);
                    if (newTitle) currentChat.title = newTitle.replace(/"/g, '').trim();
                    renderConversationsList();
                }
                saveState();
            } catch (error) {
                toggleForm(true);
                const friendlyError = getFriendlyErrorMessage(error);
                addMessageToUI('assistant', friendlyError, 'text', `msg-${Date.now() + 1}`);
            }
        };

        const handleCreateCommand = async (prompt, type) => {
            if (!prompt.trim()) return;
            toggleForm(false);
            const currentChat = state.conversations[state.currentChatId];
            
            const userMessageId = `msg-${Date.now()}`;
            const userMessage = { id: userMessageId, role: 'user', type: 'text', content: `خلق ${type === 'image' ? 'تصویر' : 'کد'}: ${prompt}` };
            currentChat.history.push(userMessage);
            addMessageToUI(userMessage.role, userMessage.content, userMessage.type, userMessage.id);

            try {
                let aiMessage;
                const aiMessageId = `msg-${Date.now() + 1}`;
                if (type === 'code') {
                    const codePrompt = `Create a complete, single-file webpage using HTML, Tailwind CSS, and JavaScript. The page should be about: ${prompt}. Provide only the code in a single HTML markdown block. Do not add any explanation outside the code block.`;
                    const codeContent = await generateContent([{ text: codePrompt }], []);
                    if(codeContent) aiMessage = { id: aiMessageId, role: 'assistant', type: 'code', content: codeContent };
                }

                if (aiMessage) {
                    currentChat.history.push(aiMessage);
                    addMessageToUI(aiMessage.role, aiMessage.content, aiMessage.type, aiMessage.id);
                }
                saveState();
            } catch (error) {
                toggleForm(true);
                const friendlyError = getFriendlyErrorMessage(error);
                addMessageToUI('assistant', friendlyError, 'text', `msg-${Date.now() + 1}`);
            } finally {
                toggleForm(true);
            }
        };

        const stopRecording = () => {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
            if (recognition && state.isRecording) {
                 recognition.stop();
            }
            state.isRecording = false;
            elements.micBtn.classList.remove('mic-active');
        };

        const setupSpeechRecognition = () => {
            window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!window.SpeechRecognition) {
                console.warn("Speech Recognition API not supported.");
                return;
            }
            recognition = new SpeechRecognition();
            recognition.lang = 'fa-IR';
            recognition.interimResults = false;
            recognition.continuous = false;

            recognition.onresult = (event) => {
                elements.userInput.value = event.results[0][0].transcript;
            };
            recognition.onerror = (event) => console.error('Speech recognition error', event.error);
            recognition.onend = stopRecording;
        };

        const startAudioRecording = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const messageId = `msg-${Date.now()}`;
                    const audioMessage = { id: messageId, role: 'user', type: 'audio', content: { url: audioUrl } };
                    state.conversations[state.currentChatId].history.push(audioMessage);
                    addMessageToUI(audioMessage.role, audioMessage.content, audioMessage.type, audioMessage.id);
                    saveState();
                };
                mediaRecorder.start();
                state.isRecording = true;
                elements.micBtn.classList.add('mic-active');
            } catch (error) {
                 console.error("Could not start audio recording:", error);
                showAlert("مرورگر شما از قابلیت ضبط صدا پشتیبانی نمی‌کند یا دسترسی به میکروفون مسدود شده است.");
                stopRecording();
            }
        };
        
        const showWelcomeScreen = () => {
            elements.chatContainer.innerHTML = `
                <div class="text-center h-full flex flex-col justify-center items-center">
                    <i data-lucide="bot" class="w-24 h-24 mb-4 text-[var(--accent-color)]"></i>
                    <h2 class="text-2xl font-bold">استودیو هوش مصنوعی</h2>
                    <p class="text-[var(--text-secondary)] mt-2">چطور میتونم امروز به شما کمک کنم؟</p>
                    <div class="grid grid-cols-2 gap-4 mt-8 max-w-md w-full">
                        <button class="welcome-prompt-btn">یک شعر درباره بهار بگو</button>
                        <button class="welcome-prompt-btn">ایده برای یک پست اینستاگرام</button>
                        <button class="welcome-prompt-btn">یک تابع جاوااسکریپت بنویس</button>
                        <button class="welcome-prompt-btn">پایتخت استرالیا کجاست؟</button>
                    </div>
                </div>
            `;
            document.querySelectorAll('.welcome-prompt-btn').forEach(btn => {
                btn.className = 'p-4 border border-[var(--border-color)] rounded-lg hover:border-[var(--accent-color)] hover:bg-gray-500/10 transition-all text-sm';
                btn.addEventListener('click', () => {
                    elements.userInput.value = btn.textContent;
                    handleUserMessage(btn.textContent);
                });
            });
            lucide.createIcons();
        };

        const loadChat = (chatId, isRerender = false) => {
            clearInterval(typingEffectInterval);
            if (!chatId || !state.conversations[chatId]) {
                const chatIds = Object.keys(state.conversations);
                if (chatIds.length === 0) {
                    startNewChat();
                    return;
                }
                chatId = chatIds.sort((a,b) => (state.conversations[b].createdAt || 0) - (state.conversations[a].createdAt || 0))[0];
            }
            state.currentChatId = chatId;
            const chat = state.conversations[chatId];
            
            if (!chat || chat.history.length === 0) {
                elements.chatContainer.innerHTML = '';
                showWelcomeScreen();
                elements.chatTitle.textContent = 'گفتگوی جدید';
                elements.exportChatBtn.classList.add('hidden');
                elements.summarizeChatBtn.classList.add('hidden');
            } else {
                elements.chatTitle.textContent = chat.title;
                elements.chatContainer.innerHTML = '';
                chat.history.forEach(msg => addMessageToUI(msg.role, msg.content, msg.type, msg.id));
                elements.exportChatBtn.classList.remove('hidden');
                elements.summarizeChatBtn.classList.remove('hidden');
            }

            if (!isRerender) {
                renderConversationsList();
                saveState();
            }
        };

        const startNewChat = () => {
            const newId = `chat-${Date.now()}`;
            state.conversations[newId] = { id: newId, title: 'گفتگوی جدید', history: [], createdAt: Date.now(), isPinned: false };
            loadChat(newId);
        };

        window.speakMessage = (btn) => {
            const text = btn.closest('.relative').querySelector('.prose').innerText;
            speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'fa-IR';
            speechSynthesis.speak(utterance);
        };
        window.copyCode = (btn) => {
            const pre = btn.closest('pre');
            const code = pre.querySelector('code').innerText;
            navigator.clipboard.writeText(code).then(() => {
                btn.innerText = 'کپی شد!';
                setTimeout(() => { btn.innerText = 'کپی'; }, 2000);
            });
        };
        window.deleteMessage = (messageId) => {
            const chat = state.conversations[state.currentChatId];
            const messageIndex = chat.history.findIndex(m => m.id === messageId);
            if (messageIndex !== -1) {
                chat.history.splice(messageIndex, 1);
                document.getElementById(messageId)?.remove();
                saveState();
            }
        };
        window.editMessage = (messageId) => {
            const messageEl = document.getElementById(messageId);
            const proseEl = messageEl.querySelector('.prose');
            const currentText = state.conversations[state.currentChatId].history.find(m => m.id === messageId).content;
            
            const editArea = document.createElement('textarea');
            editArea.className = 'w-full p-2 border border-[var(--border-color)] rounded-md bg-transparent';
            editArea.value = currentText;
            
            const saveBtn = document.createElement('button');
            saveBtn.className = 'px-3 py-1 bg-green-500 text-white rounded-md mt-2';
            saveBtn.textContent = 'ذخیره';
            
            proseEl.innerHTML = '';
            proseEl.appendChild(editArea);
            proseEl.appendChild(saveBtn);
            
            saveBtn.onclick = () => {
                handleUserMessage(editArea.value, null, true, messageId);
            };
        };
        window.copyMessage = (btn) => {
            const text = btn.closest('.relative').querySelector('.prose').innerText;
            navigator.clipboard.writeText(text).then(() => {
                showAlert('پاسخ کپی شد!', 'موفق');
            });
        };

        const init = () => {
            const setVh = () => {
                document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
            };
            window.addEventListener('resize', setVh);
            setVh();

            lucide.createIcons();
            loadState();
            applyTheme();
            applyFontSize();
            setupSpeechRecognition();
            
            if (elements.apiKeyInput) elements.apiKeyInput.value = state.settings.apiKey;
            if (elements.systemPromptInput) elements.systemPromptInput.value = state.settings.systemPrompt;
            if (elements.historyLengthSlider) elements.historyLengthSlider.value = state.settings.historyLength;
            if (elements.historyLengthValue) elements.historyLengthValue.textContent = state.settings.historyLength;
            if (elements.animationToggle) elements.animationToggle.checked = state.settings.animations;
            if (elements.fontSizeSlider) elements.fontSizeSlider.value = state.settings.fontSize;
            const modelInput = document.querySelector(`#model-selector input[value="${state.settings.model}"]`);
            if(modelInput) modelInput.checked = true;

            loadChat(state.currentChatId);

            if (elements.chatForm) elements.chatForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleUserMessage(elements.userInput.value);
                elements.userInput.value = '';
                elements.userInput.style.height = 'auto';
                elements.charCounter.textContent = 0;
            });
            if (elements.userInput) {
                elements.userInput.addEventListener('input', () => {
                    elements.userInput.style.height = 'auto';
                    elements.userInput.style.height = (elements.userInput.scrollHeight) + 'px';
                    elements.charCounter.textContent = elements.userInput.value.length;
                });
                elements.userInput.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 'Enter') {
                        e.preventDefault();
                        elements.chatForm.dispatchEvent(new Event('submit'));
                    }
                });
            }
            if (elements.sidebarToggle) elements.sidebarToggle.addEventListener('click', () => {
                 if (window.innerWidth < 768) {
                    elements.appWrapper.classList.toggle('sidebar-open');
                    elements.sidebarBackdrop.classList.toggle('hidden');
                } else {
                    elements.appWrapper.classList.toggle('sidebar-closed');
                }
            });
            if (elements.sidebarBackdrop) elements.sidebarBackdrop.addEventListener('click', () => {
                elements.appWrapper.classList.remove('sidebar-open');
                elements.sidebarBackdrop.classList.add('hidden');
            });
            if (elements.newChatBtn) elements.newChatBtn.addEventListener('click', startNewChat);

            document.querySelectorAll('[data-close-modal]').forEach(btn => btn.addEventListener('click', () => {
                btn.closest('.fixed').classList.add('hidden');
            }));
            if (elements.alertOkBtn) elements.alertOkBtn.addEventListener('click', () => elements.alertModal.classList.add('hidden'));
            if (elements.settingsBtn) elements.settingsBtn.addEventListener('click', () => {
                if (elements.apiCallCounter) elements.apiCallCounter.textContent = state.apiCallCount;
                elements.settingsModal.classList.remove('hidden');
            });
            if (elements.aboutBtn) elements.aboutBtn.addEventListener('click', () => elements.aboutModal.classList.remove('hidden'));
            if (elements.upgradeProBtn) elements.upgradeProBtn.addEventListener('click', () => elements.proModal.classList.remove('hidden'));
            if (elements.createBtn) elements.createBtn.addEventListener('click', () => {
                elements.createModal.classList.remove('hidden');
                elements.createForm.classList.add('hidden');
                elements.createOptions.classList.remove('hidden');
            });
            if (elements.createOptions) elements.createOptions.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (btn) {
                    currentCreateType = btn.dataset.type;
                    if (currentCreateType === 'image') {
                        showAlert('قابلیت ساخت تصویر به زودی اضافه خواهد شد!');
                        return;
                    }
                    elements.createOptions.classList.add('hidden');
                    elements.createForm.classList.remove('hidden');
                    elements.createPrompt.placeholder = `توصیف دقیق برای ${currentCreateType === 'image' ? 'تصویر' : 'وب‌سایت'}...`;
                    elements.createPrompt.focus();
                }
            });
            if (elements.createForm) elements.createForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleCreateCommand(elements.createPrompt.value, currentCreateType);
                elements.createModal.classList.add('hidden');
                elements.createPrompt.value = '';
            });
            
            if (elements.themeSelector) elements.themeSelector.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (btn && btn.dataset.theme) {
                    state.settings.theme = btn.dataset.theme;
                    applyTheme();
                    saveState();
                }
            });
            if (elements.apiKeyInput) elements.apiKeyInput.addEventListener('change', (e) => { state.settings.apiKey = e.target.value; saveState(); });
            if (elements.systemPromptInput) elements.systemPromptInput.addEventListener('change', () => { state.settings.systemPrompt = elements.systemPromptInput.value; saveState(); });
            if (elements.historyLengthSlider) {
                elements.historyLengthSlider.addEventListener('input', (e) => { elements.historyLengthValue.textContent = e.target.value; });
                elements.historyLengthSlider.addEventListener('change', (e) => { state.settings.historyLength = parseInt(e.target.value, 10); saveState(); });
            }
            if (elements.animationToggle) elements.animationToggle.addEventListener('change', (e) => { state.settings.animations = e.target.checked; saveState(); });
            if (elements.modelSelector) elements.modelSelector.addEventListener('change', (e) => { state.settings.model = e.target.value; saveState(); });
            if (elements.fontSizeSlider) {
                elements.fontSizeSlider.addEventListener('input', (e) => {
                    state.settings.fontSize = parseInt(e.target.value, 10);
                    applyFontSize();
                });
                elements.fontSizeSlider.addEventListener('change', saveState);
            }
            if (elements.clearAllBtn) elements.clearAllBtn.addEventListener('click', () => {
                if(confirm("آیا از پاک کردن تمام داده‌های برنامه مطمئن هستید؟ این عمل غیرقابل بازگشت است.")) {
                    localStorage.clear();
                    window.location.reload();
                }
            });
            
            if (elements.conversationsList) elements.conversationsList.addEventListener('click', (e) => {
                const targetButton = e.target.closest('button');
                if (!targetButton) return;

                const action = targetButton.dataset.action;
                const chatId = targetButton.dataset.chatId;

                if (action === 'load-chat') {
                    loadChat(chatId);
                    if (window.innerWidth < 768) {
                        elements.appWrapper.classList.remove('sidebar-open');
                        elements.sidebarBackdrop.classList.add('hidden');
                    }
                } else if (action === 'delete-chat') {
                    delete state.conversations[chatId];
                    if (state.currentChatId === chatId) {
                        state.currentChatId = null;
                        loadChat(null);
                    }
                    renderConversationsList(elements.searchInput.value);
                    saveState();
                } else if (action === 'toggle-pin') {
                    state.conversations[chatId].isPinned = !state.conversations[chatId].isPinned;
                    renderConversationsList(elements.searchInput.value);
                    saveState();
                }
            });

            if (elements.searchInput) elements.searchInput.addEventListener('input', (e) => {
                renderConversationsList(e.target.value);
            });

            if (elements.exportChatBtn) elements.exportChatBtn.addEventListener('click', () => {
                const chat = state.conversations[state.currentChatId];
                if (!chat) return;
                const chatJson = JSON.stringify(chat, null, 2);
                const blob = new Blob([chatJson], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${chat.title.replace(/ /g, '_')}.json`;
                a.click();
                URL.revokeObjectURL(url);
            });

            if (elements.micBtn) elements.micBtn.addEventListener('click', () => {
                if (state.isRecording) {
                    stopRecording();
                } else {
                    startAudioRecording();
                }
            });
            if (elements.fileUploadBtn) elements.fileUploadBtn.addEventListener('click', () => elements.fileInput.click());
            if (elements.fileInput) elements.fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                if (file.type.startsWith('image/')) {
                    reader.onload = (event) => {
                        const base64Data = event.target.result.split(',')[1];
                        const fileData = { type: 'image', content: { prompt: "این تصویر را تحلیل کن", url: event.target.result, base64Data, mimeType: file.type } };
                        const promptText = prompt("چه سوالی درباره این تصویر دارید؟", "این تصویر را توصیف کن");
                        if (promptText) {
                            fileData.content.prompt = promptText;
                            handleUserMessage(promptText, fileData);
                        }
                    };
                    reader.readAsDataURL(file);
                } else if (file.type.startsWith('text/') || file.name.endsWith('.js') || file.name.endsWith('.py') || file.name.endsWith('.html') || file.name.endsWith('.css')) {
                    reader.onload = (event) => {
                        const fileData = { type: 'file', content: { name: file.name, text: event.target.result } };
                        const promptText = prompt(`درباره محتوای فایل "${file.name}" چه دستوری دارید؟`, `محتوای این فایل را خلاصه کن`);
                        if (promptText) handleUserMessage(promptText, fileData);
                    };
                    reader.readAsText(file);
                } else {
                    showAlert(`نوع فایل ${file.type} پشتیبانی نمی‌شود.`);
                }
                elements.fileInput.value = ''; // Reset file input
            });

            // Settings Import/Export
            if (elements.exportSettingsBtn) elements.exportSettingsBtn.addEventListener('click', () => {
                const settingsJson = JSON.stringify(state.settings, null, 2);
                const blob = new Blob([settingsJson], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ai-studio-settings.json';
                a.click();
                URL.revokeObjectURL(url);
            });
            if (elements.importSettingsBtn) elements.importSettingsBtn.addEventListener('click', () => {
                elements.importSettingsInput.click();
            });
            if (elements.importSettingsInput) elements.importSettingsInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedSettings = JSON.parse(event.target.result);
                        state.settings = { ...state.settings, ...importedSettings };
                        applyTheme();
                        applyFontSize();
                        elements.apiKeyInput.value = state.settings.apiKey;
                        elements.systemPromptInput.value = state.settings.systemPrompt;
                        elements.historyLengthSlider.value = state.settings.historyLength;
                        elements.historyLengthValue.textContent = state.settings.historyLength;
                        elements.animationToggle.checked = state.settings.animations;
                        elements.fontSizeSlider.value = state.settings.fontSize;
                        const modelInput = document.querySelector(`#model-selector input[value="${state.settings.model}"]`);
                        if(modelInput) modelInput.checked = true;
                        saveState();
                        showAlert('تنظیمات با موفقیت وارد شد!', 'موفق');
                    } catch (err) {
                        showAlert('خطا در خواندن فایل تنظیمات. لطفاً از یک فایل معتبر استفاده کنید.');
                        console.error("Error parsing settings file:", err);
                    }
                };
                reader.readAsText(file);
            });

            // Fullscreen Toggle
            if (elements.fullscreenBtn) elements.fullscreenBtn.addEventListener('click', () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                    elements.fullscreenBtn.innerHTML = '<i data-lucide="minimize"></i>';
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                        elements.fullscreenBtn.innerHTML = '<i data-lucide="maximize"></i>';
                    }
                }
                lucide.createIcons();
            });

            // Prompt Library
            if (elements.promptLibraryBtn) elements.promptLibraryBtn.addEventListener('click', () => {
                elements.promptLibraryModal.classList.remove('hidden');
            });

            const promptLibrary = {
                'خلاقیت و تولید محتوا': [
                    { title: 'طوفان فکری', prompt: 'برای [موضوع]، ۱۰ ایده خلاقانه ارائه بده.' },
                    { title: 'نوشتن پست وبلاگ', prompt: 'یک پست وبلاگ جذاب درباره [موضوع] با لحنی [لحن، مثلا: دوستانه] بنویس.' },
                    { title: 'شعار تبلیغاتی', prompt: '۵ شعار تبلیغاتی برای [محصول یا برند] بساز.' },
                ],
                'برنامه‌نویسی': [
                    { title: 'توضیح کد', prompt: 'این قطعه کد [زبان برنامه‌نویسی] را خط به خط توضیح بده:\n```\n\n```' },
                    { title: 'نوشتن تابع', prompt: 'یک تابع به زبان [زبان برنامه‌نویسی] بنویس که [کاربرد تابع] را انجام دهد.' },
                    { title: 'دیباگ کردن کد', prompt: 'خطای موجود در این کد [زبان برنامه‌نویسی] را پیدا و اصلاح کن:\n```\n\n```' },
                ],
                'کار و تجارت': [
                    { title: 'نوشتن ایمیل رسمی', prompt: 'یک ایمیل رسمی به [گیرنده] با موضوع [موضوع] بنویس و در آن درخواست [درخواست] را مطرح کن.' },
                    { title: 'خلاصه‌سازی متن', prompt: 'متن زیر را در ۳ جمله کلیدی خلاصه کن:\n' },
                ],
            };

            if (elements.promptCategoriesContainer) {
                elements.promptCategoriesContainer.innerHTML = Object.entries(promptLibrary).map(([category, prompts]) => `
                    <div>
                        <h4 class="font-bold mb-2">${category}</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                            ${prompts.map(p => `<button class="prompt-item-btn">${p.title}</button>`).join('')}
                        </div>
                    </div>
                `).join('');
            
                document.querySelectorAll('.prompt-item-btn').forEach(btn => {
                    btn.className = 'p-3 text-sm text-right border border-[var(--border-color)] rounded-lg hover:border-[var(--accent-color)] hover:bg-gray-500/10 transition-all';
                    btn.addEventListener('click', () => {
                        const category = btn.closest('div').previousElementSibling.textContent;
                        const promptData = promptLibrary[category].find(p => p.title === btn.textContent);
                        if (promptData) {
                            elements.userInput.value = promptData.prompt;
                            elements.promptLibraryModal.classList.add('hidden');
                            elements.userInput.focus();
                        }
                    });
                });
            }

            // Persona Logic
            const personas = {
                'دستیار عمومی': { icon: 'bot', prompt: '' },
                'نویسنده خلاق': { icon: 'feather', prompt: 'تو یک نویسنده خلاق و داستان‌سرا هستی. پاسخ‌هایت باید سرشار از تصویرسازی و احساسات باشد.' },
                'کارشناس فنی': { icon: 'code-2', prompt: 'تو یک مهندس نرم‌افزار ارشد هستی. پاسخ‌هایت باید دقیق، فنی و همراه با مثال‌های کد در صورت نیاز باشد.' },
                'راهنمای سفر': { icon: 'map-pin', prompt: 'تو یک راهنمای سفر جهانی هستی. مکان‌های دیدنی، فرهنگ‌ها و نکات سفر را با جزئیات جذاب معرفی کن.' },
                'مترجم حرفه‌ای': { icon: 'languages', prompt: 'تو یک مترجم حرفه‌ای مسلط به چندین زبان هستی. ترجمه‌هایت باید دقیق، روان و طبیعی باشد.' },
            };

            if (elements.personaList) {
                elements.personaList.innerHTML = Object.entries(personas).map(([name, data]) => `
                    <button data-persona-prompt="${data.prompt}" class="text-right p-4 border border-[var(--border-color)] rounded-lg hover:border-[var(--accent-color)] hover:bg-gray-500/10 transition-all group">
                        <i data-lucide="${data.icon}" class="w-8 h-8 mb-2 text-[var(--accent-color)]"></i>
                        <h4 class="font-bold text-lg">${name}</h4>
                    </button>
                `).join('');
                lucide.createIcons();
                document.querySelectorAll('[data-persona-prompt]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const newPrompt = btn.dataset.personaPrompt;
                        state.settings.systemPrompt = newPrompt;
                        elements.systemPromptInput.value = newPrompt;
                        saveState();
                        elements.personaModal.classList.add('hidden');
                        showAlert(`شخصیت به "${btn.querySelector('h4').textContent}" تغییر کرد.`, 'موفق');
                    });
                });
            }
            if (elements.personaBtn) elements.personaBtn.addEventListener('click', () => elements.personaModal.classList.remove('hidden'));

            // Import Chat
            if (elements.importChatBtn) elements.importChatBtn.addEventListener('click', () => elements.importChatInput.click());
            if (elements.importChatInput) elements.importChatInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedChat = JSON.parse(event.target.result);
                        if (importedChat.id && importedChat.title && Array.isArray(importedChat.history)) {
                            state.conversations[importedChat.id] = importedChat;
                            saveState();
                            loadChat(importedChat.id);
                            showAlert('گفتگو با موفقیت وارد شد!', 'موفق');
                        } else {
                            throw new Error('Invalid chat file format.');
                        }
                    } catch (err) {
                        showAlert('خطا در خواندن فایل گفتگو. لطفاً از یک فایل معتبر استفاده کنید.');
                        console.error("Error parsing chat file:", err);
                    }
                };
                reader.readAsText(file);
            });

            // Markdown Previewer Logic
            if(elements.markdownPreviewBtn) elements.markdownPreviewBtn.addEventListener('click', () => {
                elements.markdownInput.value = elements.userInput.value;
                elements.markdownPreview.innerHTML = marked.parse(elements.userInput.value);
                elements.markdownPreviewModal.classList.remove('hidden');
            });
            if(elements.markdownInput) elements.markdownInput.addEventListener('input', (e) => {
                elements.markdownPreview.innerHTML = marked.parse(e.target.value);
            });
            if(elements.markdownSendBtn) elements.markdownSendBtn.addEventListener('click', () => {
                const content = elements.markdownInput.value;
                elements.userInput.value = content;
                handleUserMessage(content);
                elements.markdownPreviewModal.classList.add('hidden');
            });

            // Stop button
            if (elements.stopBtn) elements.stopBtn.addEventListener('click', () => {
                if (apiAbortController) {
                    apiAbortController.abort();
                }
                clearInterval(typingEffectInterval);
                toggleForm(true);
            });

            // Random Prompt
            if (elements.randomPromptBtn) elements.randomPromptBtn.addEventListener('click', () => {
                const allPrompts = Object.values(promptLibrary).flat();
                const randomPrompt = allPrompts[Math.floor(Math.random() * allPrompts.length)];
                elements.userInput.value = randomPrompt.prompt;
                elements.promptLibraryModal.classList.add('hidden');
                elements.userInput.focus();
            });

            // Settings Tab
            document.querySelectorAll('.settings-nav-btn').forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelectorAll('.settings-nav-btn').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    document.querySelectorAll('.settings-tab-content').forEach(tab => tab.classList.add('hidden'));
                    document.getElementById(`settings-tab-${button.dataset.tab}`).classList.remove('hidden');
                });
            });
            
            // Summarize Chat
            if (elements.summarizeChatBtn) elements.summarizeChatBtn.addEventListener('click', async () => {
                const chat = state.conversations[state.currentChatId];
                if (!chat || chat.history.length === 0) {
                    showAlert('گفتگویی برای خلاصه کردن وجود ندارد.');
                    return;
                }
                toggleForm(false);
                try {
                    const fullText = chat.history.map(m => `[${m.role}]: ${m.content.prompt || m.content}`).join('\n');
                    const prompt = `لطفاً این گفتگو را در چند جمله کلیدی خلاصه کن:\n\n${fullText}`;
                    const summary = await generateContent([{ text: prompt }], []);
                    
                    if(summary) {
                        addMessageToUI('assistant', `**خلاصه گفتگو:**\n\n${summary}`, 'text', `msg-${Date.now()}`);
                    }
                } catch(error) {
                    const friendlyError = getFriendlyErrorMessage(error);
                    addMessageToUI('assistant', friendlyError, 'text', `msg-${Date.now() + 1}`);
                } finally {
                    toggleForm(true);
                }
            });

            // Export All Chats
            if (elements.exportAllChatsBtn) elements.exportAllChatsBtn.addEventListener('click', () => {
                const allChatsJson = JSON.stringify(state.conversations, null, 2);
                const blob = new Blob([allChatsJson], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'all_conversations.json';
                a.click();
                URL.revokeObjectURL(url);
            });

        };

        init();
    });
    </script>
</body>
</html>