<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>استودیو هوش مصنوعی (نسخه حرفه‌ای)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Highlight.js for code syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- Vazirmatn Font -->
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.395.0/dist/umd/lucide.min.js"></script>
    <!-- Chart.js for Analysis Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- WordCloud2.js for Analysis Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.js"></script>

    <style>
        /* --- CSS Variables for Theming --- */
        :root {
            --bg-primary: #f4f7fe; --bg-secondary: #ffffff; --text-primary: #1a202c; --text-secondary: #718096; --accent-color: #4a90e2; --accent-color-dark: #3a7bc8; --sidebar-bg: #ffffff; --border-color: #e2e8f0; --pro-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --vh: 1vh; --font-size: 14px; --accent-color-rgb: 74, 144, 226;
        }
        .dark {
            --bg-primary: #121212; --bg-secondary: #1E1E1E; --text-primary: #e2e2e2; --text-secondary: #a0a0a0; --accent-color: #58a6ff; --accent-color-dark: #388bfd; --sidebar-bg: #1E1E1E; --border-color: #333333; --pro-bg: linear-gradient(135deg, #303a52 0%, #574b90 100%);
            --accent-color-rgb: 88, 166, 255;
        }
        /* Additional Themes */
        .theme-ocean { --bg-primary: #E0F7FA; --bg-secondary: #FFFFFF; --text-primary: #004D40; --text-secondary: #00796B; --accent-color: #00BCD4; --accent-color-dark: #0097A7; --sidebar-bg: #B2EBF2; --border-color: #4DD0E1; --pro-bg: linear-gradient(135deg, #00BCD4 0%, #00796B 100%); --accent-color-rgb: 0, 188, 212; }
        .theme-forest { --bg-primary: #E8F5E9; --bg-secondary: #FFFFFF; --text-primary: #1B5E20; --text-secondary: #388E3C; --accent-color: #4CAF50; --accent-color-dark: #388E3C; --sidebar-bg: #C8E6C9; --border-color: #A5D6A7; --pro-bg: linear-gradient(135deg, #4CAF50 0%, #1B5E20 100%); --accent-color-rgb: 76, 175, 80; }
        .theme-rose { --bg-primary: #FCE4EC; --bg-secondary: #FFFFFF; --text-primary: #880E4F; --text-secondary: #C2185B; --accent-color: #E91E63; --accent-color-dark: #C2185B; --sidebar-bg: #F8BBD0; --border-color: #F48FB1; --pro-bg: linear-gradient(135deg, #E91E63 0%, #880E4F 100%); --accent-color-rgb: 233, 30, 99; }
        .theme-sunset { --bg-primary: #fde68a; --bg-secondary: #ffffff; --text-primary: #7c2d12; --text-secondary: #b45309; --accent-color: #f97316; --accent-color-dark: #ea580c; --sidebar-bg: #fef3c7; --border-color: #fcd34d; --pro-bg: linear-gradient(135deg, #f97316 0%, #c2410c 100%); --accent-color-rgb: 249, 115, 22; }
        .theme-mint { --bg-primary: #d1fae5; --bg-secondary: #ffffff; --text-primary: #064e3b; --text-secondary: #047857; --accent-color: #10b981; --accent-color-dark: #059669; --sidebar-bg: #a7f3d0; --border-color: #6ee7b7; --pro-bg: linear-gradient(135deg, #10b981 0%, #065f46 100%); --accent-color-rgb: 16, 185, 129; }
        .theme-graphite { --bg-primary: #e5e7eb; --bg-secondary: #f9fafb; --text-primary: #111827; --text-secondary: #4b5563; --accent-color: #6b7280; --accent-color-dark: #4b5563; --sidebar-bg: #f3f4f6; --border-color: #d1d5db; --pro-bg: linear-gradient(135deg, #6b7280 0%, #1f2937 100%); --accent-color-rgb: 107, 114, 128; }

        body { font-family: 'Vazirmatn', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; font-size: var(--font-size); }
        
        #app-wrapper { height: 100vh; height: calc(var(--vh, 1vh) * 100); }
        #sidebar { transition: transform 0.3s ease-in-out, width 0.3s ease-in-out; flex-shrink: 0; }
        
        @media (max-width: 767px) {
            #sidebar { transform: translateX(100%); position: absolute; }
            #app-wrapper.sidebar-open #sidebar { transform: translateX(0); }
        }
        @media (min-width: 768px) {
            #app-wrapper.sidebar-closed #sidebar { transform: translateX(100%); width: 0; padding: 0; border: none; }
             #app-wrapper.sidebar-closed #sidebar > * { display: none; }
        }

        .prose pre { position: relative; background-color: #282c34; color: #abb2bf; padding: 2.5em 1em 1em; border-radius: 8px; overflow-x: auto; }
        .code-header { position: absolute; top: 0; left: 0; right: 0; display: flex; justify-content: space-between; align-items: center; padding: 4px 12px; background-color: #374151; color: white; border-top-left-radius: 8px; border-top-right-radius: 8px; font-size: 0.8em; }
        .copy-code-btn { background: none; border: none; color: white; cursor: pointer; padding: 4px; border-radius: 4px; }
        .copy-code-btn:hover { background-color: #4b5563; }
        textarea::-webkit-scrollbar { display: none; }
        .mic-active, .web-search-active { color: var(--accent-color); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(var(--accent-color-rgb), 0.7); } 70% { box-shadow: 0 0 0 10px rgba(var(--accent-color-rgb), 0); } 100% { box-shadow: 0 0 0 0 rgba(var(--accent-color-rgb), 0); } }

        .typing-cursor { display: inline-block; width: 8px; height: 1.2em; background-color: var(--text-primary); animation: blink 1s step-end infinite; }
        @keyframes blink { from, to { background-color: transparent } 50% { background-color: var(--text-primary); } }
        .toggle-switch { position: relative; display: inline-block; width: 40px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .toggle-slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: var(--accent-color); }
        input:checked + .toggle-slider:before { transform: translateX(16px); }
        
        .settings-nav-btn.active { background-color: var(--accent-color); color: white; }

        .popover { display: none; position: absolute; background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); z-index: 50; }
        .popover.show { display: block; }
        .popover-item { display: flex; align-items: center; gap: 12px; padding: 8px 12px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
        .popover-item:hover { background-color: rgba(128, 128, 128, 0.1); }
        
        /* Drag and Drop Styles */
        .dragging { opacity: 0.5; background: var(--accent-color); color: white; }
        .drag-over { border: 2px dashed var(--accent-color); }

        /* Token Counter Style */
        .token-counter { font-size: 0.7rem; color: var(--text-secondary); margin-top: 4px; text-align: left; padding-left: 8px; }
        
        #word-cloud-canvas { width: 100% !important; height: 300px !important; }
    </style>
</head>
<body class="overflow-hidden">
    <div id="app-wrapper" class="relative flex h-screen w-screen">
        <div id="sidebar-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden"></div>
        <aside id="sidebar" class="h-full w-72 bg-[var(--sidebar-bg)] flex flex-col z-40 border-l border-[var(--border-color)] shadow-lg">
            <div class="p-4 flex justify-between items-center border-b border-[var(--border-color)]">
                <h2 class="font-bold text-lg">تاریخچه</h2>
                <div class="flex items-center">
                     <button id="new-folder-btn" class="p-2 rounded-md hover:bg-gray-300/50 dark:hover:bg-gray-600/50" title="پوشه جدید"><i data-lucide="folder-plus"></i></button>
                     <button id="new-chat-btn" class="p-2 rounded-md hover:bg-gray-300/50 dark:hover:bg-gray-600/50" title="گفتگوی جدید"><i data-lucide="plus-square"></i></button>
                </div>
            </div>
            <div class="p-2 border-b border-[var(--border-color)]">
                <input type="search" id="search-input" placeholder="جستجو در گفتگوها..." class="w-full p-2 text-sm border border-[var(--border-color)] rounded-md bg-transparent focus:ring-2 focus:ring-[var(--accent-color)] outline-none">
            </div>
            <nav id="conversations-list" class="flex-1 overflow-y-auto p-2 space-y-1"></nav>
            
            <div class="p-3 border-t border-[var(--border-color)] relative">
                 <div class="flex items-center justify-between gap-2">
                    <button id="upgrade-pro-btn" class="flex-1 text-white font-bold flex items-center justify-center gap-3 p-3 rounded-lg hover:opacity-90 transition-opacity" style="background: var(--pro-bg);"><i data-lucide="zap"></i><span>ارتقاء به پرو</span></button>
                    <button id="more-menu-btn" class="p-3 rounded-lg hover:bg-gray-300/50 dark:hover:bg-gray-600/50 border border-transparent hover:border-[var(--border-color)]"><i data-lucide="more-vertical"></i></button>
                 </div>
                 <div id="more-menu-popover" class="popover" style="bottom: 100%; right: 0; margin-bottom: 10px; width: 250px; padding: 8px;">
                     <button id="template-btn" class="popover-item"><i data-lucide="layout-template"></i><span>شروع از قالب</span></button>
                     <button id="persona-btn" class="popover-item"><i data-lucide="user-circle"></i><span>انتخاب شخصیت</span></button>
                     <button id="plugins-btn" class="popover-item"><i data-lucide="puzzle"></i><span>پلاگین‌ها</span></button>
                     <button id="prompt-library-btn" class="popover-item"><i data-lucide="library"></i><span>کتابخانه دستورات</span></button>
                     <hr class="my-1 border-[var(--border-color)]">
                     <button id="import-chat-btn" class="popover-item"><i data-lucide="import"></i><span>ورود گفتگو</span></button>
                     <input type="file" id="import-chat-input" class="hidden" accept=".json">
                     <button id="settings-btn" class="popover-item"><i data-lucide="settings"></i><span>تنظیمات</span></button>
                     <button id="about-btn" class="popover-item"><i data-lucide="info"></i><span>درباره ما</span></button>
                 </div>
            </div>
        </aside>

        <main id="main-content" class="flex-1 flex flex-col bg-[var(--bg-primary)] min-w-0">
            <header class="flex items-center justify-between p-4 border-b border-[var(--border-color)] bg-[var(--bg-secondary)]/80 backdrop-blur-sm">
                <button id="sidebar-toggle" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="panel-left"></i></button>
                <h1 id="chat-title" class="text-lg font-semibold text-center flex-1 truncate px-4"></h1>
                <div class="flex items-center gap-2 relative">
                    <button id="analyze-chat-btn" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 hidden" title="تحلیل گفتگو"><i data-lucide="bar-chart-3"></i></button>
                    <button id="copy-chat-id-btn" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 hidden" title="کپی شناسه گفتگو"><i data-lucide="share-2"></i></button>
                    <button id="summarize-chat-btn" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 hidden" title="خلاصه سازی گفتگو"><i data-lucide="book-text"></i></button>
                    <div id="export-menu-container" class="relative">
                        <button id="export-chat-btn" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 hidden" title="خروجی گرفتن"><i data-lucide="download"></i></button>
                        <div id="export-options" class="hidden absolute top-full right-0 mt-2 w-32 bg-[var(--bg-secondary)] border border-[var(--border-color)] rounded-md shadow-lg z-10">
                            <a href="#" id="export-json" class="block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">JSON</a>
                            <a href="#" id="export-md" class="block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">Markdown</a>
                            <a href="#" id="export-txt" class="block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">Text</a>
                        </div>
                    </div>
                    <button id="fullscreen-btn" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700" title="تمام صفحه"><i data-lucide="maximize"></i></button>
                </div>
            </header>
            <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-6"></div>
            <div id="smart-suggestions-container" class="px-4 pb-4 flex flex-wrap justify-center gap-2"></div>
            <footer class="p-4 bg-transparent">
                <div id="loading-indicator-container" class="hidden items-center justify-center mx-auto mb-2"></div>
                <div class="relative">
                    <form id="chat-form" class="flex items-end gap-2 bg-[var(--bg-secondary)] p-3 rounded-2xl shadow-lg border border-[var(--border-color)]">
                        <div class="relative">
                             <button type="button" id="chat-actions-btn" class="p-2 self-center flex-shrink-0 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" title="ابزارها"><i data-lucide="plus"></i></button>
                             <div id="chat-actions-popover" class="popover" style="bottom: 100%; right: 0; margin-bottom: 10px; width: 240px;">
                                <div class="p-2 grid grid-cols-3 gap-2 text-[var(--text-primary)]">
                                    <button type="button" id="web-search-toggle" class="flex flex-col items-center p-2 rounded-lg hover:bg-gray-500/10" title="جستجوی وب"><i data-lucide="globe"></i><span class="text-xs mt-1">وب</span></button>
                                    <button type="button" id="markdown-editor-btn" class="flex flex-col items-center p-2 rounded-lg hover:bg-gray-500/10" title="ویرایشگر Markdown"><i data-lucide="pilcrow"></i><span class="text-xs mt-1">Markdown</span></button>
                                    <button type="button" id="file-upload-btn" class="flex flex-col items-center p-2 rounded-lg hover:bg-gray-500/10" title="ارسال فایل"><i data-lucide="paperclip"></i><span class="text-xs mt-1">فایل</span></button>
                                    <button type="button" id="mic-btn" class="flex flex-col items-center p-2 rounded-lg hover:bg-gray-500/10" title="ضبط صدا"><i data-lucide="mic"></i><span class="text-xs mt-1">صدا</span></button>
                                    <button type="button" id="create-btn" class="flex flex-col items-center p-2 rounded-lg hover:bg-gray-500/10" title="خلق کردن"><i data-lucide="sparkles"></i><span class="text-xs mt-1">خلق</span></button>
                                </div>
                             </div>
                        </div>
                        <input type="file" id="file-input" class="hidden" accept="image/*,text/plain,text/markdown,.js,.py,.html,.css" />
                        <textarea id="user-input" placeholder="پیام خود را بنویسید... (Ctrl+Enter برای ارسال)" class="flex-1 bg-transparent focus:outline-none resize-none px-2 py-2 max-h-48" rows="1"></textarea>
                        <button type="submit" id="send-btn" class="bg-[var(--accent-color)] text-white p-3 self-center flex-shrink-0 rounded-full transition-colors hover:bg-[var(--accent-color-dark)] disabled:opacity-50 disabled:cursor-not-allowed"><i data-lucide="arrow-up"></i></button>
                        <button type="button" id="stop-btn" class="bg-red-500 text-white p-3 self-center flex-shrink-0 rounded-full hidden" title="توقف"><i data-lucide="square"></i></button>
                    </form>
                    <div id="char-counter" class="absolute bottom-0 left-4 text-xs text-[var(--text-secondary)] -mb-5">0</div>
                </div>
            </footer>
        </main>
    </div>
    
    <!-- Modals -->
    <div id="alert-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
        <div class="bg-[var(--bg-secondary)] rounded-2xl shadow-xl p-6 w-full max-w-sm mx-auto" data-modal-content>
            <div class="text-center">
                <i data-lucide="alert-triangle" class="w-12 h-12 mx-auto text-yellow-500"></i>
                <h3 id="alert-title" class="text-lg font-bold mt-4">توجه</h3>
                <p id="alert-body" class="text-sm text-[var(--text-secondary)] mt-2"></p>
                <button id="alert-ok-btn" class="mt-6 w-full p-2 rounded-lg bg-[var(--accent-color)] text-white">متوجه شدم</button>
            </div>
        </div>
    </div>

    <div id="about-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
        <div class="bg-[var(--bg-secondary)] rounded-2xl shadow-xl p-6 w-full max-w-2xl mx-auto" data-modal-content>
            <div class="flex justify-between items-center mb-4">
                 <h3 class="text-2xl font-bold">درباره استودیو هوش مصنوعی</h3>
                 <button class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-close-modal><i data-lucide="x"></i></button>
            </div>
            <div class="space-y-4 text-justify text-[var(--text-primary)]">
                <details class="bg-gray-500/10 p-3 rounded-lg" open>
                    <summary class="font-semibold cursor-pointer">چشم‌انداز ما</summary>
                    <p class="mt-2 text-sm text-[var(--text-secondary)]">
                        هدف ما، فراهم کردن یک دستیار هوشمند، خلاق و در دسترس برای تمام کاربران فارسی‌زبان است. ما به دنبال دموکراتیک کردن فناوری هوش مصنوعی در یک محیط کاربری ساده و زیبا هستیم.
                    </p>
                </details>
                <details class="bg-gray-500/10 p-3 rounded-lg">
                    <summary class="font-semibold cursor-pointer">تاریخچه تغییرات (نسخه 9.0)</summary>
                    <div class="mt-2 text-sm text-[var(--text-secondary)] space-y-3">
                        <div>
                            <div class="font-bold">نسخه 9.0 (آگوست ۲۰۲۴) - نسخه حرفه‌ای</div>
                            <ul class="list-disc list-inside pr-4 mt-1">
                                <li><b>مدیریت چند کلید API:</b> قابلیت ذخیره و انتخاب بین چندین کلید API.</li>
                                <li><b>داشبورد تحلیل گفتگو:</b> نمایش ابر کلمات، آمار و نمودار فعالیت.</li>
                                <li><b>حافظه بلندمدت هوشمند:</b> خلاصه‌سازی خودکار گفتگو برای حفظ زمینه بحث.</li>
                                <li><b>ساخت شخصیت سفارشی:</b> امکان تعریف و ذخیره شخصیت‌های جدید برای AI.</li>
                            </ul>
                        </div>
                    </div>
                </details>
            </div>
        </div>
    </div>
    
    <div id="create-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
        <div class="bg-[var(--bg-secondary)] rounded-2xl shadow-xl p-6 w-full max-w-2xl mx-auto" data-modal-content>
            <div class="flex justify-between items-center mb-4">
                 <h3 class="text-xl font-bold">استودیو خلق</h3>
                 <button class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-close-modal><i data-lucide="x"></i></button>
            </div>
            <p class="text-[var(--text-secondary)] mb-6">ابزار مورد نظر خود را برای خلق کردن انتخاب کنید.</p>
            <div id="create-options" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button data-type="image" class="text-right p-4 border border-[var(--border-color)] rounded-lg hover:border-[var(--accent-color)] hover:bg-gray-500/10 transition-all group">
                    <i data-lucide="image" class="w-8 h-8 mb-2 text-[var(--accent-color)]"></i>
                    <h4 class="font-bold text-lg">خلق تصویر</h4>
                    <p class="text-sm text-[var(--text-secondary)]">ایده‌های خود را به تصاویر هنری و واقعی تبدیل کنید.</p>
                </button>
                <button data-type="code" class="text-right p-4 border border-[var(--border-color)] rounded-lg hover:border-[var(--accent-color)] hover:bg-gray-500/10 transition-all group">
                    <i data-lucide="code-2" class="w-8 h-8 mb-2 text-[var(--accent-color)]"></i>
                    <h4 class="font-bold text-lg">خلق وب‌سایت</h4>
                    <p class="text-sm text-[var(--text-secondary)]">یک صفحه وب کامل با HTML, CSS و JS بسازید.</p>
                </button>
            </div>
            <form id="create-form" class="hidden mt-6">
                <textarea id="create-prompt" rows="4" class="w-full p-2 border border-[var(--border-color)] rounded-md bg-transparent focus:ring-2 focus:ring-[var(--accent-color)] outline-none" required></textarea>
                <div class="flex justify-end gap-4 mt-4">
                    <button type="button" data-close-modal class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg">انصراف</button>
                    <button type="submit" class="px-4 py-2 bg-[var(--accent-color)] text-white rounded-lg">شروع کن!</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="settings-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
        <div class="bg-[var(--bg-secondary)] rounded-2xl shadow-xl w-full max-w-4xl mx-auto flex" style="height: 80vh;" data-modal-content>
            <div class="w-1/4 border-l border-[var(--border-color)] p-4 flex flex-col">
                <nav class="space-y-2">
                    <button data-tab="general" class="settings-nav-btn w-full text-right flex items-center gap-3 p-2 rounded-md active"><i data-lucide="sliders-horizontal"></i><span>عمومی</span></button>
                    <button data-tab="personalization" class="settings-nav-btn w-full text-right flex items-center gap-3 p-2 rounded-md"><i data-lucide="user-cog"></i><span>شخصی‌سازی</span></button>
                    <button data-tab="data" class="settings-nav-btn w-full text-right flex items-center gap-3 p-2 rounded-md"><i data-lucide="database"></i><span>مدیریت داده‌ها</span></button>
                    <button data-tab="api" class="settings-nav-btn w-full text-right flex items-center gap-3 p-2 rounded-md"><i data-lucide="key-round"></i><span>کلید API</span></button>
                </nav>
                <div class="mt-auto">
                    <button data-close-modal class="w-full text-center p-2 bg-gray-200 dark:bg-gray-600 rounded-lg">بستن</button>
                </div>
            </div>
            <div class="flex-1 p-6 overflow-y-auto">
                <!-- General Tab -->
                <div id="settings-tab-general" class="settings-tab-content space-y-6">
                    <h3 class="text-xl font-bold">عمومی</h3>
                    <div>
                        <label class="block mb-2 font-semibold">انتخاب تم</label>
                        <div id="theme-selector" class="flex flex-wrap gap-2">
                            <button data-theme="light" class="w-8 h-8 rounded-full bg-gray-200 ring-2 ring-offset-2 ring-offset-[var(--bg-primary)]" title="روشن"></button>
                            <button data-theme="dark" class="w-8 h-8 rounded-full bg-gray-800 ring-2 ring-offset-2 ring-offset-[var(--bg-primary)]" title="تاریک"></button>
                            <button data-theme="ocean" class="w-8 h-8 rounded-full bg-[#00BCD4] ring-2 ring-offset-2 ring-offset-[var(--bg-primary)]" title="اقیانوس"></button>
                            <button data-theme="forest" class="w-8 h-8 rounded-full bg-[#4CAF50] ring-2 ring-offset-2 ring-offset-[var(--bg-primary)]" title="جنگل"></button>
                            <button data-theme="rose" class="w-8 h-8 rounded-full bg-[#E91E63] ring-2 ring-offset-2 ring-offset-[var(--bg-primary)]" title="رز"></button>
                            <button data-theme="sunset" class="w-8 h-8 rounded-full bg-[#f97316] ring-2 ring-offset-2 ring-offset-[var(--bg-primary)]" title="غروب"></button>
                            <button data-theme="mint" class="w-8 h-8 rounded-full bg-[#10b981] ring-2 ring-offset-2 ring-offset-[var(--bg-primary)]" title="نعنا"></button>
                            <button data-theme="graphite" class="w-8 h-8 rounded-full bg-[#6b7280] ring-2 ring-offset-2 ring-offset-[var(--bg-primary)]" title="گرافیت"></button>
                        </div>
                    </div>
                    <div>
                        <label for="font-size-slider" class="block mb-2 font-semibold">اندازه فونت: <span id="font-size-value">متوسط</span></label>
                        <input id="font-size-slider" type="range" min="12" max="18" step="2" class="w-full">
                    </div>
                    <div>
                        <label for="tts-voice-selector" class="block mb-2 font-semibold">انتخاب صدای گوینده</label>
                        <select id="tts-voice-selector" class="w-full p-2 border border-[var(--border-color)] rounded-md bg-transparent"></select>
                    </div>
                    <div>
                        <label class="flex items-center justify-between">
                            <span class="font-semibold">انیمیشن تایپ</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="animation-toggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </label>
                    </div>
                </div>
                <!-- Personalization Tab -->
                <div id="settings-tab-personalization" class="settings-tab-content space-y-6 hidden">
                    <h3 class="text-xl font-bold">شخصی‌سازی</h3>
                    <div>
                        <label class="block mb-2 font-semibold">انتخاب مدل</label>
                        <div id="model-selector" class="flex gap-4">
                            <label class="flex items-center gap-2"><input type="radio" name="model" value="gemini-1.5-flash-latest" checked><span>سریع</span></label>
                            <label class="flex items-center gap-2"><input type="radio" name="model" value="gemini-1.5-pro-latest"><span>قدرتمند</span></label>
                        </div>
                    </div>
                    <div>
                        <label class="block mb-2 font-semibold">شخصیت هوش مصنوعی (System Prompt)</label>
                        <textarea id="system-prompt-input" rows="4" class="w-full p-2 border border-[var(--border-color)] rounded-md bg-transparent focus:ring-2 focus:ring-[var(--accent-color)] outline-none" placeholder="مثال: تو یک دستیار برنامه‌نویس هستی که به زبان پایتون مسلط است."></textarea>
                    </div>
                    <div>
                        <label for="history-length-slider" class="block mb-2 font-semibold">حافظه گفتگو (تعداد پیام‌های قبلی): <span id="history-length-value">10</span></label>
                        <input id="history-length-slider" type="range" min="0" max="20" step="2" class="w-full">
                    </div>
                    <div>
                        <label class="flex items-center justify-between">
                            <span class="font-semibold">حافظه بلندمدت هوشمند (خلاصه خودکار)</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="auto-summary-toggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </label>
                        <p class="text-xs text-[var(--text-secondary)] mt-1">با فعال‌سازی، AI به طور خودکار هر ۸ پیام یکبار گفتگو را خلاصه می‌کند تا زمینه بحث حفظ شود.</p>
                    </div>
                </div>
                <!-- Data Tab -->
                <div id="settings-tab-data" class="settings-tab-content space-y-6 hidden">
                     <h3 class="text-xl font-bold">مدیریت داده‌ها</h3>
                     <div>
                        <label class="block mb-2 font-semibold">مدیریت تنظیمات</label>
                        <div class="flex gap-2">
                            <input type="file" id="import-settings-input" class="hidden" accept=".json">
                            <button id="import-settings-btn" class="flex-1 text-center p-2 rounded-md border border-[var(--border-color)] hover:bg-gray-500/10">ورود تنظیمات</button>
                            <button id="export-settings-btn" class="flex-1 text-center p-2 rounded-md border border-[var(--border-color)] hover:bg-gray-500/10">خروج تنظیمات</button>
                        </div>
                    </div>
                    <div>
                        <label class="block mb-2 font-semibold">خروجی تمام گفتگوها</label>
                        <button id="export-all-chats-btn" class="w-full text-center p-2 rounded-md border border-[var(--border-color)] hover:bg-gray-500/10">ذخیره تمام گفتگوها (JSON)</button>
                    </div>
                    <div>
                        <label class="block mb-2 font-semibold">عملیات خطرناک</label>
                        <button id="clear-all-btn" class="w-full text-left p-3 rounded-md bg-red-500 text-white hover:bg-red-600 flex items-center gap-2"><i data-lucide="trash-2"></i>پاک کردن تمام داده‌ها</button>
                    </div>
                </div>
                <!-- API Tab -->
                <div id="settings-tab-api" class="settings-tab-content space-y-6 hidden">
                    <h3 class="text-xl font-bold">مدیریت کلیدهای API</h3>
                    <form id="add-api-key-form" class="grid grid-cols-1 md:grid-cols-3 gap-2 items-end">
                        <div class="md:col-span-1">
                            <label for="api-key-name-input" class="block text-sm font-medium mb-1">نام کلید</label>
                            <input type="text" id="api-key-name-input" placeholder="مثلا: کلید شخصی" required class="w-full p-2 text-sm border border-[var(--border-color)] rounded-md bg-transparent focus:ring-2 focus:ring-[var(--accent-color)] outline-none">
                        </div>
                        <div class="md:col-span-2">
                            <label for="api-key-value-input" class="block text-sm font-medium mb-1">کلید API</label>
                            <input type="password" id="api-key-value-input" placeholder="کلید خود را اینجا وارد کنید..." required class="w-full p-2 text-sm border border-[var(--border-color)] rounded-md bg-transparent focus:ring-2 focus:ring-[var(--accent-color)] outline-none">
                        </div>
                        <button type="submit" class="md:col-span-3 w-full p-2 mt-2 rounded-md bg-[var(--accent-color)] text-white">افزودن کلید</button>
                    </form>
                    <hr class="border-[var(--border-color)]">
                    <div>
                        <label for="active-api-key-selector" class="block mb-2 font-semibold">کلید فعال</label>
                        <select id="active-api-key-selector" class="w-full p-2 border border-[var(--border-color)] rounded-md bg-transparent"></select>
                    </div>
                    <div>
                        <label class="block mb-2 font-semibold">کلیدهای ذخیره شده</label>
                        <div id="api-keys-list" class="space-y-2"></div>
                    </div>
                    <div>
                        <label class="block mb-2 font-semibold">مصرف API در این نشست</label>
                        <p class="text-sm text-[var(--text-secondary)]">تعداد کل فراخوانی‌ها: <span id="api-call-counter">0</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="pro-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
        <div class="bg-[var(--bg-secondary)] rounded-2xl shadow-xl w-full max-w-4xl mx-auto" data-modal-content>
            <div class="p-6">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-bold">به دنیای حرفه‌ای‌ها خوش آمدید!</h3>
                    <button data-close-modal class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="x"></i></button>
                </div>
                <p class="text-[var(--text-secondary)] mt-2">با عضویت ویژه، قفل تمام قابلیت‌ها را باز کنید.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 p-6 bg-[var(--bg-primary)]">
                <div class="border border-[var(--border-color)] rounded-lg p-6 bg-[var(--bg-secondary)] text-center">
                    <h4 class="font-bold text-lg">پایه</h4>
                    <p class="text-3xl font-bold my-4">$10 <span class="text-sm font-normal">/ماهانه</span></p>
                    <ul class="space-y-2 text-sm text-[var(--text-secondary)]"><li>✓ 100 خلق تصویر</li><li>✓ 50 خلق وبسایت</li><li>✓ پشتیبانی استاندارد</li></ul>
                    <button class="mt-6 w-full p-2 rounded-lg border border-[var(--accent-color)] text-[var(--accent-color)] hover:bg-[var(--accent-color)] hover:text-white transition-colors">شروع کنید</button>
                </div>
                <div class="border-2 border-[var(--accent-color)] rounded-lg p-6 bg-[var(--bg-secondary)] text-center relative">
                    <div class="absolute -top-3 right-1/2 translate-x-1/2 bg-[var(--accent-color)] text-white px-3 py-1 rounded-full text-xs font-bold">محبوب‌ترین</div>
                    <h4 class="font-bold text-lg">حرفه‌ای</h4>
                    <p class="text-3xl font-bold my-4">$25 <span class="text-sm font-normal">/ماهانه</span></p>
                    <ul class="space-y-2 text-sm text-[var(--text-secondary)]"><li>✓ خلق تصویر نامحدود</li><li>✓ خلق وبسایت نامحدود</li><li>✓ دسترسی به مدل‌های جدید</li><li>✓ پشتیبانی ویژه</li></ul>
                    <button class="mt-6 w-full p-2 rounded-lg bg-[var(--accent-color)] text-white hover:bg-[var(--accent-color-dark)] transition-colors">همین حالا بخرید</button>
                </div>
                <div class="border border-[var(--border-color)] rounded-lg p-6 bg-[var(--bg-secondary)] text-center">
                    <h4 class="font-bold text-lg">سازمانی</h4>
                    <p class="text-3xl font-bold my-4">تماس بگیرید</p>
                    <ul class="space-y-2 text-sm text-[var(--text-secondary)]"><li>✓ تمام قابلیت‌های حرفه‌ای</li><li>✓ مدیریت تیم</li><li>✓ پشتیبانی اختصاصی</li></ul>
                    <button class="mt-6 w-full p-2 rounded-lg border border-[var(--accent-color)] text-[var(--accent-color)] hover:bg-[var(--accent-color)] hover:text-white transition-colors">تماс با ما</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="prompt-library-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
        <div class="bg-[var(--bg-secondary)] rounded-2xl shadow-xl p-6 w-full max-w-4xl mx-auto flex flex-col" style="height: 80vh;" data-modal-content>
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                 <h3 class="text-2xl font-bold">کتابخانه دستورات</h3>
                 <button id="random-prompt-btn" class="p-2 rounded-md hover:bg-gray-300/50 dark:hover:bg-gray-600/50" title="شگفت‌زده‌ام کن!"><i data-lucide="shuffle"></i></button>
                 <button class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-close-modal><i data-lucide="x"></i></button>
            </div>
            <div class="flex-grow overflow-y-auto">
                <div id="prompt-categories" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <div id="persona-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
        <div class="bg-[var(--bg-secondary)] rounded-2xl shadow-xl p-6 w-full max-w-4xl mx-auto flex flex-col" style="height: 80vh;" data-modal-content>
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                 <h3 class="text-2xl font-bold">انتخاب شخصیت</h3>
                 <button class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-close-modal><i data-lucide="x"></i></button>
            </div>
            <div id="persona-list-container" class="flex-grow overflow-y-auto">
                <div id="persona-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                <button id="add-persona-btn" class="mt-4 w-full flex items-center justify-center gap-2 p-4 border-2 border-dashed border-[var(--border-color)] rounded-lg hover:border-[var(--accent-color)] hover:bg-gray-500/10 transition-all">
                    <i data-lucide="plus"></i>
                    <span>ساخت شخصیت جدید</span>
                </button>
            </div>
            <div id="add-persona-form-container" class="hidden flex-grow overflow-y-auto">
                <h4 class="text-xl font-bold mb-4">ساخت شخصیت جدید</h4>
                <form id="add-persona-form" class="space-y-4">
                    <div>
                        <label for="persona-name" class="block mb-1 font-semibold">نام شخصیت</label>
                        <input type="text" id="persona-name" required class="w-full p-2 border border-[var(--border-color)] rounded-md bg-transparent">
                    </div>
                    <div>
                        <label class="block mb-1 font-semibold">آیکون</label>
                        <div id="persona-icon-selector" class="flex flex-wrap gap-2"></div>
                    </div>
                    <div>
                        <label for="persona-prompt" class="block mb-1 font-semibold">دستور سیستمی (System Prompt)</label>
                        <textarea id="persona-prompt" rows="6" required class="w-full p-2 border border-[var(--border-color)] rounded-md bg-transparent"></textarea>
                    </div>
                    <div class="flex justify-end gap-2">
                        <button type="button" id="cancel-add-persona-btn" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg">انصراف</button>
                        <button type="submit" class="px-4 py-2 bg-[var(--accent-color)] text-white rounded-lg">ذخیره شخصیت</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="markdown-editor-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
        <div class="bg-[var(--bg-secondary)] rounded-2xl shadow-xl p-6 w-full max-w-4xl mx-auto flex flex-col" style="height: 80vh;" data-modal-content>
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                 <h3 class="text-2xl font-bold">ویرایشگر Markdown</h3>
                 <button class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-close-modal><i data-lucide="x"></i></button>
            </div>
            <div class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-4 overflow-hidden">
                <textarea id="markdown-input" class="w-full h-full p-2 border border-[var(--border-color)] rounded-md bg-transparent resize-none focus:ring-2 focus:ring-[var(--accent-color)] outline-none"></textarea>
                <div id="markdown-preview" class="w-full h-full p-2 border border-[var(--border-color)] rounded-md overflow-y-auto prose dark:prose-invert max-w-none"></div>
            </div>
            <div class="flex justify-end gap-4 mt-4 flex-shrink-0">
                <button type="button" data-close-modal class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg">انصراف</button>
                <button type="button" id="markdown-send-btn" class="px-4 py-2 bg-[var(--accent-color)] text-white rounded-lg">ارسال پیام</button>
            </div>
        </div>
    </div>

    <div id="template-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
        <div class="bg-[var(--bg-secondary)] rounded-2xl shadow-xl p-6 w-full max-w-4xl mx-auto flex flex-col" style="height: 80vh;" data-modal-content>
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                 <h3 class="text-2xl font-bold">شروع از قالب</h3>
                 <button class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-close-modal><i data-lucide="x"></i></button>
            </div>
            <div id="template-list" class="flex-grow overflow-y-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>
    </div>

    <div id="plugins-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
        <div class="bg-[var(--bg-secondary)] rounded-2xl shadow-xl p-6 w-full max-w-2xl mx-auto" data-modal-content>
            <div class="flex justify-between items-center mb-4">
                 <h3 class="text-2xl font-bold">راهنمای پلاگین‌ها</h3>
                 <button class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-close-modal><i data-lucide="x"></i></button>
            </div>
            <p class="text-[var(--text-secondary)] mb-6">از دستورات زیر در کادر چت برای فعال کردن پلاگین‌ها استفاده کنید:</p>
            <div class="space-y-4">
                <div class="p-3 bg-gray-500/10 rounded-lg">
                    <p class="font-mono font-bold">/weather [city_name]</p>
                    <p class="text-sm text-[var(--text-secondary)] mt-1">وضعیت آب و هوای شهر مورد نظر را نمایش می‌دهد. مثال: `/weather Tehran`</p>
                </div>
                <div class="p-3 bg-gray-500/10 rounded-lg">
                    <p class="font-mono font-bold">/calc [expression]</p>
                    <p class="text-sm text-[var(--text-secondary)] mt-1">یک عبارت ریاضی را محاسبه می‌کند. مثال: `/calc 2 * (10 + 5)`</p>
                </div>
            </div>
        </div>
    </div>

    <div id="analysis-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
        <div class="bg-[var(--bg-secondary)] rounded-2xl shadow-xl p-6 w-full max-w-4xl mx-auto flex flex-col" style="height: 90vh;" data-modal-content>
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                 <h3 class="text-2xl font-bold">داشبورد تحلیل گفتگو</h3>
                 <button class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-close-modal><i data-lucide="x"></i></button>
            </div>
            <div class="flex-grow overflow-y-auto space-y-6">
                <div>
                    <h4 class="font-bold mb-2">ابر کلمات</h4>
                    <div id="word-cloud-container" class="border border-[var(--border-color)] rounded-lg p-2 flex justify-center items-center">
                        <canvas id="word-cloud-canvas"></canvas>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="p-4 border border-[var(--border-color)] rounded-lg text-center">
                        <h5 class="font-semibold text-sm text-[var(--text-secondary)]">کل پیام‌ها</h5>
                        <p id="analysis-total-messages" class="text-2xl font-bold"></p>
                    </div>
                    <div class="p-4 border border-[var(--border-color)] rounded-lg text-center">
                        <h5 class="font-semibold text-sm text-[var(--text-secondary)]">کل توکن‌ها</h5>
                        <p id="analysis-total-tokens" class="text-2xl font-bold"></p>
                    </div>
                    <div class="p-4 border border-[var(--border-color)] rounded-lg text-center">
                        <h5 class="font-semibold text-sm text-[var(--text-secondary)]">میانگین پیام</h5>
                        <p id="analysis-avg-length" class="text-2xl font-bold"></p>
                    </div>
                </div>
                 <div>
                    <h4 class="font-bold mb-2">نمودار فعالیت</h4>
                     <div class="border border-[var(--border-color)] rounded-lg p-2">
                        <canvas id="activity-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        const DEFAULT_API_KEY = "AIzaSyDT32NpOOc5jUcBJ_0o9ta9OXhv9EgrHvQ";
        const DEFAULT_API_KEY_ID = "default-key";

        const elements = {
            appWrapper: document.getElementById('app-wrapper'),
            sidebar: document.getElementById('sidebar'),
            sidebarToggle: document.getElementById('sidebar-toggle'),
            sidebarBackdrop: document.getElementById('sidebar-backdrop'),
            chatContainer: document.getElementById('chat-container'),
            chatForm: document.getElementById('chat-form'),
            userInput: document.getElementById('user-input'),
            sendBtn: document.getElementById('send-btn'),
            stopBtn: document.getElementById('stop-btn'),
            newChatBtn: document.getElementById('new-chat-btn'),
            conversationsList: document.getElementById('conversations-list'),
            chatTitle: document.getElementById('chat-title'),
            loadingIndicatorContainer: document.getElementById('loading-indicator-container'),
            micBtn: document.getElementById('mic-btn'),
            fileUploadBtn: document.getElementById('file-upload-btn'),
            fileInput: document.getElementById('file-input'),
            createBtn: document.getElementById('create-btn'),
            createModal: document.getElementById('create-modal'),
            createOptions: document.getElementById('create-options'),
            createForm: document.getElementById('create-form'),
            createPrompt: document.getElementById('create-prompt'),
            settingsBtn: document.getElementById('settings-btn'),
            settingsModal: document.getElementById('settings-modal'),
            themeSelector: document.getElementById('theme-selector'),
            systemPromptInput: document.getElementById('system-prompt-input'),
            clearAllBtn: document.getElementById('clear-all-btn'),
            upgradeProBtn: document.getElementById('upgrade-pro-btn'),
            proModal: document.getElementById('pro-modal'),
            aboutBtn: document.getElementById('about-btn'),
            aboutModal: document.getElementById('about-modal'),
            exportChatBtn: document.getElementById('export-chat-btn'),
            exportSettingsBtn: document.getElementById('export-settings-btn'),
            importSettingsBtn: document.getElementById('import-settings-btn'),
            importSettingsInput: document.getElementById('import-settings-input'),
            searchInput: document.getElementById('search-input'),
            charCounter: document.getElementById('char-counter'),
            alertModal: document.getElementById('alert-modal'),
            alertTitle: document.getElementById('alert-title'),
            alertBody: document.getElementById('alert-body'),
            alertOkBtn: document.getElementById('alert-ok-btn'),
            fullscreenBtn: document.getElementById('fullscreen-btn'),
            promptLibraryBtn: document.getElementById('prompt-library-btn'),
            promptLibraryModal: document.getElementById('prompt-library-modal'),
            promptCategoriesContainer: document.getElementById('prompt-categories'),
            modelSelector: document.getElementById('model-selector'),
            historyLengthSlider: document.getElementById('history-length-slider'),
            historyLengthValue: document.getElementById('history-length-value'),
            animationToggle: document.getElementById('animation-toggle'),
            personaBtn: document.getElementById('persona-btn'),
            personaModal: document.getElementById('persona-modal'),
            personaListContainer: document.getElementById('persona-list-container'),
            personaList: document.getElementById('persona-list'),
            addPersonaBtn: document.getElementById('add-persona-btn'),
            addPersonaFormContainer: document.getElementById('add-persona-form-container'),
            addPersonaForm: document.getElementById('add-persona-form'),
            cancelAddPersonaBtn: document.getElementById('cancel-add-persona-btn'),
            personaNameInput: document.getElementById('persona-name'),
            personaIconSelector: document.getElementById('persona-icon-selector'),
            personaPromptInput: document.getElementById('persona-prompt'),
            importChatBtn: document.getElementById('import-chat-btn'),
            importChatInput: document.getElementById('import-chat-input'),
            markdownEditorBtn: document.getElementById('markdown-editor-btn'),
            markdownEditorModal: document.getElementById('markdown-editor-modal'),
            markdownInput: document.getElementById('markdown-input'),
            markdownPreview: document.getElementById('markdown-preview'),
            markdownSendBtn: document.getElementById('markdown-send-btn'),
            apiCallCounter: document.getElementById('api-call-counter'),
            addApiKeyForm: document.getElementById('add-api-key-form'),
            apiKeyNameInput: document.getElementById('api-key-name-input'),
            apiKeyValueInput: document.getElementById('api-key-value-input'),
            activeApiKeySelector: document.getElementById('active-api-key-selector'),
            apiKeysList: document.getElementById('api-keys-list'),
            randomPromptBtn: document.getElementById('random-prompt-btn'),
            summarizeChatBtn: document.getElementById('summarize-chat-btn'),
            fontSizeSlider: document.getElementById('font-size-slider'),
            fontSizeValue: document.getElementById('font-size-value'),
            exportAllChatsBtn: document.getElementById('export-all-chats-btn'),
            moreMenuBtn: document.getElementById('more-menu-btn'),
            moreMenuPopover: document.getElementById('more-menu-popover'),
            webSearchToggle: document.getElementById('web-search-toggle'),
            newFolderBtn: document.getElementById('new-folder-btn'),
            ttsVoiceSelector: document.getElementById('tts-voice-selector'),
            autoSummaryToggle: document.getElementById('auto-summary-toggle'),
            copyChatIdBtn: document.getElementById('copy-chat-id-btn'),
            exportMenuContainer: document.getElementById('export-menu-container'),
            exportOptions: document.getElementById('export-options'),
            exportJsonBtn: document.getElementById('export-json'),
            exportMdBtn: document.getElementById('export-md'),
            exportTxtBtn: document.getElementById('export-txt'),
            templateBtn: document.getElementById('template-btn'),
            templateModal: document.getElementById('template-modal'),
            templateList: document.getElementById('template-list'),
            chatActionsBtn: document.getElementById('chat-actions-btn'),
            chatActionsPopover: document.getElementById('chat-actions-popover'),
            smartSuggestionsContainer: document.getElementById('smart-suggestions-container'),
            pluginsBtn: document.getElementById('plugins-btn'),
            pluginsModal: document.getElementById('plugins-modal'),
            analyzeChatBtn: document.getElementById('analyze-chat-btn'),
            analysisModal: document.getElementById('analysis-modal'),
            wordCloudCanvas: document.getElementById('word-cloud-canvas'),
            analysisTotalMessages: document.getElementById('analysis-total-messages'),
            analysisTotalTokens: document.getElementById('analysis-total-tokens'),
            analysisAvgLength: document.getElementById('analysis-avg-length'),
            activityChart: document.getElementById('activity-chart'),
        };

        let state = {
            conversations: {},
            folders: {},
            personas: {},
            currentChatId: null,
            settings: { 
                apiKeys: [{ id: DEFAULT_API_KEY_ID, name: 'کلید پیش‌فرض (محدود)', key: DEFAULT_API_KEY, active: true }],
                theme: 'light', 
                systemPrompt: '', 
                model: 'gemini-1.5-flash-latest',
                historyLength: 10,
                animations: true,
                fontSize: 14,
                webSearch: false,
                ttsVoiceURI: null,
                autoSummary: false,
            },
            isRecording: false,
            apiCallCount: 0,
        };
        let currentCreateType = null;
        let recognition;
        let ttsVoices = [];
        let apiAbortController = null;
        let typingEffectInterval = null;
        let draggedChatId = null;
        let activityChartInstance = null;
        
        const AUTO_SUMMARY_INTERVAL = 8; // Summarize every 8 messages

        const saveState = () => localStorage.setItem('ai-studio-state-v9', JSON.stringify(state));
        
        const loadState = () => {
            const savedState = localStorage.getItem('ai-studio-state-v9');
            if (savedState) {
                const parsed = JSON.parse(savedState);
                state.conversations = parsed.conversations || {};
                state.folders = parsed.folders || {};
                state.personas = parsed.personas || {};
                state.currentChatId = parsed.currentChatId;
                // Merge settings carefully, ensuring apiKeys has the default
                const defaultKeys = state.settings.apiKeys;
                state.settings = { ...state.settings, ...parsed.settings };
                if (!parsed.settings.apiKeys || parsed.settings.apiKeys.length === 0) {
                    state.settings.apiKeys = defaultKeys;
                }
            }
        };
        
        const applyTheme = () => {
            document.body.className = `theme-${state.settings.theme} overflow-hidden`;
            document.documentElement.classList.toggle('dark', state.settings.theme === 'dark');
            if (elements.themeSelector) {
                elements.themeSelector.querySelectorAll('button').forEach(btn => {
                    btn.classList.toggle('ring-[var(--accent-color)]', btn.dataset.theme === state.settings.theme);
                });
            }
            const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim();
            if (accentColor.startsWith('#')) {
                const r = parseInt(accentColor.slice(1, 3), 16);
                const g = parseInt(accentColor.slice(3, 5), 16);
                const b = parseInt(accentColor.slice(5, 7), 16);
                document.documentElement.style.setProperty('--accent-color-rgb', `${r}, ${g}, ${b}`);
            }
        };
        
        const applyFontSize = () => {
            document.body.style.fontSize = `${state.settings.fontSize}px`;
            if (elements.fontSizeValue) {
                const sizeMap = { 12: 'کوچک', 14: 'متوسط', 16: 'بزرگ', 18: 'خیلی بزرگ' };
                elements.fontSizeValue.textContent = sizeMap[state.settings.fontSize] || 'متوسط';
            }
        }

        const showAlert = (message, title = 'توجه') => {
            elements.alertTitle.textContent = title;
            elements.alertBody.textContent = message;
            elements.alertModal.classList.remove('hidden');
            lucide.createIcons();
        };

        const callApi = async (url, payload, generationConfig = {}) => {
            const activeKey = state.settings.apiKeys.find(k => k.active);
            const apiKey = activeKey ? activeKey.key : DEFAULT_API_KEY;

            if (!apiKey) {
                throw new Error("هیچ کلید API فعالی انتخاب نشده است. لطفاً از منوی تنظیمات، یک کلید معتبر را فعال کنید.");
            }
            
            state.apiCallCount++;
            if(elements.apiCallCounter) elements.apiCallCounter.textContent = state.apiCallCount;

            apiAbortController = new AbortController();
            const finalPayload = { ...payload, generationConfig };
            try {
                const response = await fetch(`${url}?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(finalPayload),
                    signal: apiAbortController.signal
                });
                
                if (!response.ok) {
                    const errorBody = await response.json().catch(() => ({ error: { message: response.statusText } }));
                    throw new Error(`API Error ${response.status}: ${errorBody.error.message}`);
                }
                return await response.json();
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('API call aborted by user.');
                    return null; 
                }
                console.error("API Call failed:", error);
                throw error;
            } finally {
                apiAbortController = null;
            }
        };

        const performWebSearch = async (query) => {
            console.log(`Performing mock web search for: ${query}`);
            await new Promise(resolve => setTimeout(resolve, 1500));
            return `نتایج جستجوی شبیه‌سازی شده برای "${query}": هوش مصنوعی به سرعت در حال پیشرفت است و در زمینه‌های مختلفی مانند پزشکی، حمل و نقل و هنر کاربرد دارد. مدل‌های زبانی بزرگ مانند سری Gemini از گوگل، قابلیت‌های گفتگوی طبیعی و تولید محتوای خلاقانه را فراهم می‌کنند.`;
        };

        const generateContent = async (parts, history, summary = null) => {
            let historyToSend = history.slice(-state.settings.historyLength).map(msg => {
                if (msg.type === 'generated-image' || msg.type === 'plugin') return null;
                const contentParts = [];
                if (msg.type === 'text' || msg.type === 'code') {
                    contentParts.push({ text: msg.content });
                } else if (msg.type === 'file' || msg.type === 'image') {
                    if(msg.content.prompt) contentParts.push({ text: msg.content.prompt });
                }
                if (contentParts.length > 0) {
                    return { role: msg.role === 'user' ? 'user' : 'model', parts: contentParts };
                }
                return null;
            }).filter(Boolean);

            let systemInstructions = [];
            if (state.settings.systemPrompt) {
                systemInstructions.push({ role: 'user', parts: [{ text: `System instruction: ${state.settings.systemPrompt}` }] });
                systemInstructions.push({ role: 'model', parts: [{ text: 'OK.' }] });
            }
            if (summary) {
                 systemInstructions.push({ role: 'user', parts: [{ text: `This is a summary of the conversation so far, use it for context: ${summary}` }] });
                 systemInstructions.push({ role: 'model', parts: [{ text: 'OK, I will use that context.' }] });
            }

            historyToSend.unshift(...systemInstructions);
            historyToSend.push({ role: 'user', parts });
            
            const model = state.settings.model;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent`;
            const payload = { contents: historyToSend };
            
            const result = await callApi(apiUrl, payload);
            if (!result) return null;

            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            const tokenCount = result.usageMetadata?.totalTokenCount || 0;

            if (!text) {
                console.error('Invalid response structure from API:', result);
                const safetyFeedback = result.candidates?.[0]?.finishReason;
                if (safetyFeedback === 'SAFETY') {
                     throw new Error('SAFETY');
                }
                throw new Error('Invalid response from server');
            }
            return { text, tokenCount };
        };

        const toggleForm = (enabled, loadingText = 'در حال پردازش...') => {
            elements.userInput.disabled = !enabled;
            elements.sendBtn.classList.toggle('hidden', !enabled);
            elements.stopBtn.classList.toggle('hidden', enabled);
            
            if(enabled) {
                elements.loadingIndicatorContainer.classList.add('hidden');
                elements.loadingIndicatorContainer.innerHTML = '';
            } else {
                elements.loadingIndicatorContainer.classList.remove('hidden');
                elements.loadingIndicatorContainer.innerHTML = `
                    <div class="flex items-center gap-2 text-[var(--text-secondary)]">
                        <div class="w-5 h-5 border-2 border-dashed rounded-full animate-spin border-[var(--accent-color)]"></div>
                        <span>${loadingText}</span>
                    </div>
                `;
            }
        };
        
        const renderConversationsList = (searchTerm = '') => {
            elements.conversationsList.innerHTML = '';
            const lowerSearchTerm = searchTerm.toLowerCase();

            Object.values(state.folders).forEach(folder => {
                const folderDetails = document.createElement('details');
                folderDetails.className = 'folder-container group';
                folderDetails.open = folder.isOpen;
                folderDetails.dataset.folderId = folder.id;

                const summary = document.createElement('summary');
                summary.className = 'flex items-center justify-between p-2 rounded-md cursor-pointer hover:bg-gray-300/50 dark:hover:bg-gray-600/50';
                summary.innerHTML = `
                    <div class="flex items-center gap-2 font-semibold">
                        <i data-lucide="folder" class="w-4 h-4"></i>
                        <span class="folder-title" contenteditable="false">${folder.name}</span>
                    </div>
                    <div>
                        <button data-action="edit-folder" class="p-1 rounded-md opacity-0 group-hover:opacity-100"><i data-lucide="pencil" class="w-3 h-3"></i></button>
                        <button data-action="delete-folder" class="p-1 rounded-md opacity-0 group-hover:opacity-100"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                    </div>
                `;
                folderDetails.appendChild(summary);
                elements.conversationsList.appendChild(folderDetails);
            });

            const chats = Object.values(state.conversations)
                .filter(chat => chat.title.toLowerCase().includes(lowerSearchTerm));
            
            chats.sort((a, b) => (b.isPinned || 0) - (a.isPinned || 0) || (b.createdAt || 0) - (a.createdAt || 0));

            chats.forEach(chat => {
                const item = document.createElement('div');
                item.className = 'flex items-center group chat-item';
                item.draggable = true;
                item.dataset.chatId = chat.id;
                const isActive = chat.id === state.currentChatId;
                item.innerHTML = `
                    <button data-action="load-chat" data-chat-id="${chat.id}" class="flex-1 text-right p-2 rounded-md truncate ${isActive ? 'bg-blue-100 dark:bg-gray-700' : 'hover:bg-gray-300/50 dark:hover:bg-gray-600/50'}">${chat.title}</button>
                    <button data-action="toggle-pin" data-chat-id="${chat.id}" class="p-2 rounded-md text-gray-500 hover:bg-yellow-200 hover:text-yellow-600 opacity-0 group-hover:opacity-100 transition-opacity" title="پین کردن">
                        <i data-lucide="pin" class="w-4 h-4 ${chat.isPinned ? 'fill-current text-yellow-500' : ''}"></i>
                    </button>
                    <button data-action="delete-chat" data-chat-id="${chat.id}" class="p-2 rounded-md text-gray-500 hover:bg-red-200 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity" title="حذف">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                `;
                
                const folderContainer = document.querySelector(`.folder-container[data-folder-id="${chat.folderId}"]`);
                if (folderContainer) {
                    folderContainer.appendChild(item);
                } else {
                    elements.conversationsList.appendChild(item);
                }
            });

            lucide.createIcons();
        };

        const streamTextResponse = (textElement, fullText, callback) => {
            let i = 0;
            clearInterval(typingEffectInterval);
            
            textElement.innerHTML = '<span></span><span class="typing-cursor"></span>';
            const textContainer = textElement.firstChild;
            const cursor = textElement.lastChild;

            typingEffectInterval = setInterval(() => {
                if (apiAbortController && apiAbortController.signal.aborted) {
                    clearInterval(typingEffectInterval);
                    if(cursor) cursor.remove();
                    if (callback) callback(textContainer.textContent); 
                    return;
                }

                if (i < fullText.length) {
                    textContainer.textContent += fullText[i];
                    i++;
                } else {
                    clearInterval(typingEffectInterval);
                    if(cursor) cursor.remove();
                    if (callback) callback(fullText);
                }
            }, 25);
        };

        const addMessageToUI = (role, content, type = 'text', messageId, isStreaming = false, tokenCount = 0, searchResults = null) => {
            const messageWrapper = document.createElement('div');
            messageWrapper.id = `msg-${messageId}`;
            messageWrapper.className = `flex items-start gap-3 group relative ${role === 'user' ? 'justify-end' : ''}`;
            
            const avatar = `<div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg flex-shrink-0 shadow-md ${role === 'user' ? 'bg-gray-300 dark:bg-gray-600' : 'bg-gradient-to-br from-blue-400 to-purple-500 text-white'}">${role === 'user' ? 'شما' : 'AI'}</div>`;
            
            let messageContentHTML = '';
            if (type === 'image') {
                 messageContentHTML = `<div class="p-3 rounded-lg shadow-md bg-[var(--accent-color)] text-white max-w-sm"><p class="mb-2">${content.prompt}</p><img src="${content.url}" alt="Uploaded Image" class="rounded-lg" /></div>`;
            } else if (type === 'generated-image') {
                messageContentHTML = `<div class="p-3 rounded-lg shadow-md bg-[var(--bg-secondary)] max-w-md"><p class="mb-2 text-sm text-[var(--text-secondary)]">${content.prompt}</p><img src="${content.url}" alt="Generated Image" class="rounded-lg w-full" /></div>`;
            } else if (type === 'audio') {
                messageContentHTML = `<div class="p-3 rounded-lg shadow-md bg-[var(--accent-color)] text-white"><audio controls src="${content.url}"></audio></div>`;
            } else if (type === 'plugin') {
                messageContentHTML = `<div class="p-3 rounded-lg shadow-md bg-[var(--bg-secondary)]">${content}</div>`;
            } else {
                const proseClass = role === 'user' ? 'bg-[var(--accent-color)] text-white' : 'bg-[var(--bg-secondary)] dark:prose-invert';
                messageContentHTML = `<div class="prose max-w-none break-words p-3 rounded-lg shadow-md ${proseClass}"></div>`;
            }

            let searchResultsHTML = '';
            if (searchResults) {
                searchResultsHTML = `
                    <details class="mt-2 text-xs border-t border-[var(--border-color)] pt-2">
                        <summary class="cursor-pointer font-semibold text-[var(--text-secondary)]">مشاهده منابع جستجو</summary>
                        <p class="mt-1 p-2 bg-gray-500/10 rounded-md">${searchResults}</p>
                    </details>
                `;
            }

            const tokenCounterHTML = tokenCount > 0 ? `<div class="token-counter">${tokenCount} توکن</div>` : '';

            const messageControls = role === 'user' ? `
                <div class="absolute top-1/2 -translate-y-1/2 left-0 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button onclick="editMessage('${messageId}')" class="p-1 rounded-full bg-gray-500/20 text-[var(--text-secondary)]" title="ویرایش"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                    <button onclick="deleteMessage('${messageId}')" class="p-1 rounded-full bg-gray-500/20 text-[var(--text-secondary)]" title="حذف"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>` : '';

            const assistantControls = (role === 'assistant' && type !== 'plugin') ? `
                <div class="absolute top-2 left-2 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button onclick="speakMessage(this)" class="p-1 rounded-full bg-gray-500/20 text-[var(--text-secondary)]" title="خواندن متن"><i data-lucide="volume-2" class="w-4 h-4"></i></button>
                    <button onclick="copyMessage(this)" class="p-1 rounded-full bg-gray-500/20 text-[var(--text-secondary)]" title="کپی"><i data-lucide="copy" class="w-4 h-4"></i></button>
                    <button onclick="regenerateResponse('${messageId}')" class="p-1 rounded-full bg-gray-500/20 text-[var(--text-secondary)]" title="تولید مجدد"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button>
                </div>` : '';
            
            const contentWrapperClass = role === 'user' ? 'relative max-w-3xl' : 'relative w-full max-w-3xl';

            messageWrapper.innerHTML = (role === 'user' ? messageControls : '') + (role === 'user' ? '' : avatar) + `<div class="${contentWrapperClass}">${messageContentHTML}${searchResultsHTML}${tokenCounterHTML}${assistantControls}</div>` + (role === 'user' ? avatar : '');
            
            elements.chatContainer.appendChild(messageWrapper);

            if (type === 'text' || type === 'code' || type === 'file') {
                const textElement = messageWrapper.querySelector('.prose');
                const textContent = (type === 'file') ? `فایل \`${content.name}\` آپلود شد:\n\n\`\`\`\n${content.text}\n\`\`\`` : content;
                if (isStreaming && state.settings.animations) {
                    streamTextResponse(textElement, textContent, (streamedText) => {
                         textElement.innerHTML = marked.parse(streamedText);
                         textElement.querySelectorAll('pre').forEach(pre => {
                            const code = pre.querySelector('code');
                            if (!code) return;
                            const lang = code.className.replace('language-', '') || 'code';
                            const header = document.createElement('div');
                            header.className = 'code-header';
                            header.innerHTML = `<span>${lang}</span><button class="copy-code-btn" onclick="copyCode(this)">کپی</button>`;
                            pre.prepend(header);
                        });
                         hljs.highlightAll();
                    });
                } else {
                    textElement.innerHTML = marked.parse(textContent);
                    textElement.querySelectorAll('pre').forEach(pre => {
                        const code = pre.querySelector('code');
                        if (!code) return;
                        const lang = code.className.replace('language-', '') || 'code';
                        const header = document.createElement('div');
                        header.className = 'code-header';
                        header.innerHTML = `<span>${lang}</span><button class="copy-code-btn" onclick="copyCode(this)">کپی</button>`;
                        pre.prepend(header);
                    });
                    hljs.highlightAll();
                }
            }
            
            elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight;
            lucide.createIcons();
        };
        
        const getFriendlyErrorMessage = (error) => {
            const errorMessage = error.message || '';
            
            if (errorMessage.includes("API Error 429")) {
                return `
### ⚠️ خطا: اتمام سهمیه API

**چه اتفاقی افتاده؟**
شما بیش از حد مجاز از API رایگان در یک بازه زمانی کوتاه استفاده کرده‌اید.

**چکار باید بکنید؟**
1.  **صبر کنید:** بهترین راه حل این است که چند دقیقه صبر کرده و دوباره امتحان کنید.
2.  **استفاده از کلید شخصی:** اگر مشکل ادامه داشت، می‌توانید از منوی **تنظیمات -> کلید API**، یک کلید شخصی جدید که از Google AI Studio دریافت کرده‌اید را وارد و فعال کنید.
                `;
            }
            if (errorMessage.includes("API key") || errorMessage.includes("هیچ کلید API فعالی انتخاب نشده")) {
                return `
### 📛 خطا: کلید API نامعتبر است

**چه اتفاقی افتاده؟**
کلید API که در حال حاضر فعال است، نامعتبر، منقضی شده یا اشتباه است.

**چکار باید بکنید؟**
1.  به بخش **تنظیمات** بروید (از منوی سه نقطه در پایین).
2.  وارد تب **کلید API** شوید.
3.  یک کلید API جدید و معتبر از [Google AI Studio](https://aistudio.google.com/app/apikey) دریافت کرده و آن را در برنامه اضافه و فعال نمایید.
                `;
            }
             if (errorMessage.includes("SAFETY")) {
                return `
### 🛡️ خطا: محتوا مسدود شد

**چه اتفاقی افتاده؟**
درخواست شما یا پاسخی که توسط هوش مصنوعی تولید شد، با قوانین ایمنی گوگل مغایرت داشت و برای محافظت، مسدود شد.

**چکار باید بکنید؟**
* سعی کنید درخواست خود را با کلمات و عبارات دیگری که حساسیت کمتری دارند، مطرح کنید. از درخواست محتوای حساس یا نامناسب خودداری کنید.
                `;
            }
            if (errorMessage.toLowerCase().includes("failed to fetch")) {
                return `
### 🌐 خطا: مشکل در اتصال به اینترنت

**چه اتفاقی افتاده؟**
برنامه نتوانست به سرورهای هوش مصنوعی متصل شود. این مشکل معمولاً از سمت دستگاه شماست.

**چکار باید بکنید؟**
1.  **اتصال اینترنت:** از اتصال اینترنت خود مطمئن شوید.
2.  **VPN و فایروال:** اگر از VPN یا فایروال استفاده می‌کنید، آن‌ها را موقتاً غیرفعال کنید.
3.  **اجرای محلی:** اگر برنامه را به صورت یک فایل HTML روی کامپیوتر خود باز کرده‌اید، ممکن است با خطا مواجه شوید. بهتر است آن را از طریق یک سرور وب (مانند افزونه Live Server در VSCode) اجرا کنید.
                `;
            }
             if (errorMessage.includes("imagen")) {
                return `
### 🖼️ خطا: عدم موفقیت در تولید تصویر

**چه اتفاقی افتاده؟**
مدل تولید تصویر نتوانست برای درخواست شما تصویری بسازد. این مشکل می‌تواند به دلایل زیر باشد:
-   درخواست شما با قوانین ایمنی مدل مغایرت داشته است.
-   توصیف شما برای مدل گنگ یا نامفهوم بوده است.
-   یک مشکل فنی موقت در سرور رخ داده است.

**چکار باید بکنید؟**
1.  **توصیف را تغییر دهید:** از کلمات و عبارات متفاوتی استفاده کنید.
2.  **دقیق‌تر باشید:** جزئیات بیشتری به توصیف خود اضافه کنید.
3.  **دوباره تلاش کنید:** چند دقیقه بعد دوباره امتحان کنید.
                `;
            }

            return `
### ⚙️ خطای پیش‌بینی نشده

**چه اتفاقی افتاده؟**
یک خطای عمومی در سیستم رخ داده است.

**متن فنی خطا:**
\`\`\`
${errorMessage}
\`\`\`
            `;
        };

        const handleUserMessage = async (userInput, fileData = null, isRegeneration = false, originalMessageId = null) => {
            if (!userInput.trim() && !fileData) return;
            
            renderSmartSuggestions([]); 

            if (userInput.trim().startsWith('/')) {
                handlePluginCommand(userInput);
                return;
            }

            const currentChat = state.conversations[state.currentChatId];

            if (isRegeneration) {
                toggleForm(false);
                const messageIndex = currentChat.history.findIndex(m => m.id === originalMessageId);
                if (messageIndex !== -1) {
                    currentChat.history.splice(messageIndex);
                }
            } else {
                const messageId = `msg-${Date.now()}`;
                let userMessage;
                if (fileData) {
                    userMessage = { id: messageId, role: 'user', type: fileData.type, content: fileData.content };
                } else {
                    userMessage = { id: messageId, role: 'user', type: 'text', content: userInput };
                }
                currentChat.history.push(userMessage);
                toggleForm(false);
            }
            
            loadChat(state.currentChatId, true);

            try {
                let finalPrompt = userInput;
                let summaryForContext = currentChat.autoSummary || null;
                let searchResults = null;

                if (state.settings.webSearch) {
                    toggleForm(false, 'در حال جستجو در وب...');
                    searchResults = await performWebSearch(userInput);
                    finalPrompt = `با توجه به اطلاعات زیر از وب: "${searchResults}"\n\nبه این سوال پاسخ بده: ${userInput}`;
                }
                
                // Auto-summary logic
                if (state.settings.autoSummary && currentChat.history.length > 1 && currentChat.history.length % AUTO_SUMMARY_INTERVAL === 0) {
                    toggleForm(false, 'در حال پردازش حافظه...');
                    const fullText = currentChat.history.map(m => `[${m.role}]: ${m.content.prompt || m.content}`).join('\n');
                    const summaryPrompt = `این گفتگو را در چند جمله کوتاه برای ایجاد زمینه خلاصه کن:\n\n${fullText}`;
                    const summaryResult = await generateContent([{ text: summaryPrompt }], []);
                    currentChat.autoSummary = summaryResult.text;
                    summaryForContext = currentChat.autoSummary;
                    console.log("Auto-summary generated:", currentChat.autoSummary);
                }


                toggleForm(false);
                const parts = [];
                if (fileData) {
                    if (fileData.type === 'image') {
                        parts.push({ text: finalPrompt });
                        parts.push({ inlineData: { mimeType: fileData.content.mimeType, data: fileData.content.base64Data } });
                    } else { 
                        const fullPrompt = `با توجه به محتوای فایل ${fileData.content.name}:\n${fileData.content.text}\n\n${finalPrompt}`;
                        parts.push({ text: fullPrompt });
                    }
                } else {
                    parts.push({ text: finalPrompt });
                }

                const { text: aiResponseText, tokenCount } = await generateContent(parts, currentChat.history.slice(0, -1), summaryForContext);
                
                if (aiResponseText) {
                    const aiMessageId = `msg-${Date.now() + 1}`;
                    const aiMessage = { id: aiMessageId, role: 'assistant', type: 'text', content: aiResponseText, tokenCount, searchResults };
                    currentChat.history.push(aiMessage);
                    addMessageToUI(aiMessage.role, aiMessage.content, aiMessage.type, aiMessage.id, true, tokenCount, searchResults);
                    fetchSmartSuggestions(currentChat.history);
                }
                
                if (currentChat.history.length <= 3 && !isRegeneration) {
                    const titlePrompt = `این گفتگو را در 3 یا 4 کلمه برای عنوان خلاصه کن: "${userInput}"`;
                    const { text: newTitle } = await generateContent([{ text: titlePrompt }], []);
                    if (newTitle) currentChat.title = newTitle.replace(/"/g, '').trim();
                    renderConversationsList();
                }
                saveState();
            } catch (error) {
                const friendlyError = getFriendlyErrorMessage(error);
                addMessageToUI('assistant', friendlyError, 'text', `msg-${Date.now() + 1}`);
            } finally {
                toggleForm(true);
            }
        };

        const handleCreateCommand = async (prompt, type) => {
            if (!prompt.trim()) return;
            
            renderSmartSuggestions([]);
            const currentChat = state.conversations[state.currentChatId];
            
            const userMessageId = `msg-${Date.now()}`;
            const userMessage = { id: userMessageId, role: 'user', type: 'text', content: `خلق ${type === 'image' ? 'تصویر' : 'کد'}: ${prompt}` };
            currentChat.history.push(userMessage);
            addMessageToUI(userMessage.role, userMessage.content, userMessage.type, userMessage.id);
            toggleForm(false, `در حال خلق ${type === 'image' ? 'تصویر' : 'کد'}...`);

            try {
                let aiMessage;
                const aiMessageId = `msg-${Date.now() + 1}`;
                if (type === 'code') {
                    const codePrompt = `Create a complete, single-file webpage using HTML, Tailwind CSS, and JavaScript. The page should be about: ${prompt}. Provide only the code in a single HTML markdown block. Do not add any explanation outside the code block.`;
                    const { text: codeContent, tokenCount } = await generateContent([{ text: codePrompt }], []);
                    if(codeContent) aiMessage = { id: aiMessageId, role: 'assistant', type: 'code', content: codeContent, tokenCount };
                } else if (type === 'image') {
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict`;
                    const payload = { instances: [{ prompt: prompt }], parameters: { sampleCount: 1 } };
                    const result = await callApi(apiUrl, payload);
                    
                    if (result.predictions && result.predictions[0].bytesBase64Encoded) {
                        const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                        aiMessage = { id: aiMessageId, role: 'assistant', type: 'generated-image', content: { prompt: prompt, url: imageUrl }, tokenCount: 0 };
                    } else {
                        throw new Error("پاسخ نامعتبر از مدل تولید تصویر دریافت شد. (imagen)");
                    }
                }

                if (aiMessage) {
                    currentChat.history.push(aiMessage);
                    addMessageToUI(aiMessage.role, aiMessage.content, aiMessage.type, aiMessage.id, false, aiMessage.tokenCount);
                }
                saveState();
            } catch (error) {
                const friendlyError = getFriendlyErrorMessage(error);
                addMessageToUI('assistant', friendlyError, 'text', `msg-${Date.now() + 1}`);
            } finally {
                toggleForm(true);
            }
        };

        const stopRecording = () => {
            if (recognition && state.isRecording) {
                 recognition.stop();
            }
            state.isRecording = false;
            elements.micBtn.classList.remove('mic-active');
            elements.micBtn.title = 'ضبط صدا';
        };

        const setupSpeechRecognition = () => {
            window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!window.SpeechRecognition) {
                elements.micBtn.style.display = 'none';
                console.warn("Speech Recognition API not supported.");
                return;
            }
            recognition = new SpeechRecognition();
            recognition.lang = 'fa-IR';
            recognition.interimResults = false;
            recognition.continuous = false;

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                elements.userInput.value += transcript;
                elements.userInput.dispatchEvent(new Event('input'));
            };
            recognition.onerror = (event) => {
                console.error('Speech recognition error', event.error);
                if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                    showAlert('دسترسی به میکروفون مسدود شده است. لطفاً دسترسی را در تنظیمات مرورگر فعال کنید.');
                }
            };
            recognition.onend = stopRecording;
        };

        const startAudioRecording = async () => {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showAlert("مرورگر شما از قابلیت ضبط صدا پشتیبانی نمی‌کند.");
                return;
            }
            try {
                await navigator.mediaDevices.getUserMedia({ audio: true });
                if (recognition) {
                    recognition.start();
                    state.isRecording = true;
                    elements.micBtn.classList.add('mic-active');
                    elements.micBtn.title = 'توقف ضبط';
                }
            } catch (error) {
                 console.error("Could not start audio recording:", error);
                showAlert("مرورگر شما از قابلیت ضبط صدا پشتیبانی نمی‌کند یا دسترسی به میکروفون مسدود شده است.");
                stopRecording();
            }
        };
        
        const showWelcomeScreen = () => {
            elements.chatContainer.innerHTML = `
                <div class="text-center h-full flex flex-col justify-center items-center">
                    <i data-lucide="bot" class="w-24 h-24 mb-4 text-[var(--accent-color)]"></i>
                    <h2 class="text-2xl font-bold">استودیو هوش مصنوعی</h2>
                    <p class="text-[var(--text-secondary)] mt-2">چطور میتونم امروز به شما کمک کنم؟</p>
                    <div class="grid grid-cols-2 gap-4 mt-8 max-w-md w-full">
                        <button class="welcome-prompt-btn">یک شعر درباره بهار بگو</button>
                        <button class="welcome-prompt-btn">ایده برای یک پست اینستاگرام</button>
                        <button class="welcome-prompt-btn">یک تابع جاوااسکریپت بنویس</button>
                        <button class="welcome-prompt-btn">پایتخت استرالیا کجاست؟</button>
                    </div>
                </div>
            `;
            document.querySelectorAll('.welcome-prompt-btn').forEach(btn => {
                btn.className = 'p-4 border border-[var(--border-color)] rounded-lg hover:border-[var(--accent-color)] hover:bg-gray-500/10 transition-all text-sm';
                btn.addEventListener('click', () => {
                    elements.userInput.value = btn.textContent;
                    handleUserMessage(btn.textContent);
                });
            });
            lucide.createIcons();
        };

        const loadChat = (chatId, isRerender = false) => {
            clearInterval(typingEffectInterval);
            renderSmartSuggestions([]);
            if (!chatId || !state.conversations[chatId]) {
                const chatIds = Object.keys(state.conversations);
                if (chatIds.length === 0) {
                    startNewChat();
                    return;
                }
                chatId = chatIds.sort((a,b) => (state.conversations[b].createdAt || 0) - (state.conversations[a].createdAt || 0))[0];
            }
            state.currentChatId = chatId;
            const chat = state.conversations[chatId];
            
            if (!chat || chat.history.length === 0) {
                elements.chatContainer.innerHTML = '';
                showWelcomeScreen();
                elements.chatTitle.textContent = 'گفتگوی جدید';
                elements.exportChatBtn.classList.add('hidden');
                elements.summarizeChatBtn.classList.add('hidden');
                elements.copyChatIdBtn.classList.add('hidden');
                elements.analyzeChatBtn.classList.add('hidden');
            } else {
                elements.chatTitle.textContent = chat.title;
                elements.chatContainer.innerHTML = '';
                chat.history.forEach(msg => addMessageToUI(msg.role, msg.content, msg.type, msg.id, false, msg.tokenCount, msg.searchResults));
                elements.exportChatBtn.classList.remove('hidden');
                elements.summarizeChatBtn.classList.remove('hidden');
                elements.copyChatIdBtn.classList.remove('hidden');
                elements.analyzeChatBtn.classList.remove('hidden');
            }

            if (!isRerender) {
                renderConversationsList();
                saveState();
            }
        };

        const startNewChat = (template = null) => {
            const newId = `chat-${Date.now()}`;
            const newChat = { 
                id: newId, 
                title: template ? template.title : 'گفتگوی جدید', 
                history: [], 
                createdAt: Date.now(), 
                isPinned: false, 
                folderId: null,
                autoSummary: null,
            };
            
            if (template) {
                state.settings.systemPrompt = template.systemPrompt;
                elements.systemPromptInput.value = template.systemPrompt;
                if (template.starterMessage) {
                    const starterId = `msg-${Date.now() + 1}`;
                    newChat.history.push({ id: starterId, role: 'assistant', type: 'text', content: template.starterMessage });
                }
            }
            
            state.conversations[newId] = newChat;
            loadChat(newId);
        };

        const populateTtsVoices = () => {
            ttsVoices = speechSynthesis.getVoices();
            elements.ttsVoiceSelector.innerHTML = '';
            ttsVoices.forEach(voice => {
                const option = document.createElement('option');
                option.textContent = `${voice.name} (${voice.lang})`;
                option.value = voice.voiceURI;
                if (voice.voiceURI === state.settings.ttsVoiceURI) {
                    option.selected = true;
                }
                elements.ttsVoiceSelector.appendChild(option);
            });
        };

        window.speakMessage = (btn) => {
            const messageDiv = btn.closest('.relative');
            const textContent = messageDiv.querySelector('.prose, p')?.innerText;
            if (textContent) {
                speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(textContent);
                const selectedVoice = ttsVoices.find(v => v.voiceURI === state.settings.ttsVoiceURI);
                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                } else {
                    utterance.lang = 'fa-IR';
                }
                speechSynthesis.speak(utterance);
            }
        };
        window.copyCode = (btn) => {
            const pre = btn.closest('pre');
            const code = pre.querySelector('code').innerText;
            navigator.clipboard.writeText(code).then(() => {
                btn.innerText = 'کپی شد!';
                setTimeout(() => { btn.innerText = 'کپی'; }, 2000);
            });
        };
        window.deleteMessage = (messageId) => {
            const chat = state.conversations[state.currentChatId];
            const messageIndex = chat.history.findIndex(m => m.id === messageId);
            if (messageIndex !== -1) {
                chat.history.splice(messageIndex, 1);
                document.getElementById(messageId)?.remove();
                saveState();
            }
        };
        window.editMessage = (messageId) => {
            const messageEl = document.getElementById(messageId);
            const proseEl = messageEl.querySelector('.prose');
            const currentText = state.conversations[state.currentChatId].history.find(m => m.id === messageId).content;
            
            const editArea = document.createElement('textarea');
            editArea.className = 'w-full p-2 border border-[var(--border-color)] rounded-md bg-transparent';
            editArea.value = currentText;
            
            const saveBtn = document.createElement('button');
            saveBtn.className = 'px-3 py-1 bg-green-500 text-white rounded-md mt-2';
            saveBtn.textContent = 'ذخیره';
            
            proseEl.innerHTML = '';
            proseEl.appendChild(editArea);
            proseEl.appendChild(saveBtn);
            
            saveBtn.onclick = () => {
                const chat = state.conversations[state.currentChatId];
                const message = chat.history.find(m => m.id === messageId);
                message.content = editArea.value;
                saveState();
                loadChat(state.currentChatId);
            };
        };
        window.copyMessage = (btn) => {
            const messageDiv = btn.closest('.relative');
            const textContent = messageDiv.querySelector('.prose, p')?.innerText;
            if (textContent) {
                navigator.clipboard.writeText(textContent).then(() => {
                    showAlert('پاسخ کپی شد!', 'موفق');
                });
            }
        };
        window.regenerateResponse = (messageId) => {
            const chat = state.conversations[state.currentChatId];
            const messageIndex = chat.history.findIndex(m => m.id === messageId);
            if (messageIndex > 0 && chat.history[messageIndex].role === 'assistant') {
                const lastUserMessage = chat.history[messageIndex - 1];
                if (lastUserMessage.role === 'user') {
                    if (lastUserMessage.content.startsWith('خلق ')) {
                        let prompt, type;
                        if (lastUserMessage.content.startsWith('خلق تصویر: ')) {
                            type = 'image';
                            prompt = lastUserMessage.content.substring('خلق تصویر: '.length);
                        } else if (lastUserMessage.content.startsWith('خلق کد: ')) {
                            type = 'code';
                            prompt = lastUserMessage.content.substring('خلق کد: '.length);
                        }
                        
                        if (type && prompt) {
                            chat.history.splice(messageIndex);
                            handleCreateCommand(prompt, type);
                        }
                    } else {
                         handleUserMessage(lastUserMessage.content, null, true, messageId);
                    }
                }
            }
        };

        const renderSmartSuggestions = (suggestions = []) => {
            elements.smartSuggestionsContainer.innerHTML = '';
            if (suggestions.length === 0) return;

            suggestions.forEach(text => {
                const button = document.createElement('button');
                button.textContent = text;
                button.className = "px-3 py-2 text-sm border border-[var(--border-color)] rounded-full hover:bg-gray-500/20 transition-all";
                button.onclick = () => {
                    elements.userInput.value = text;
                    elements.chatForm.dispatchEvent(new Event('submit', { bubbles: true }));
                };
                elements.smartSuggestionsContainer.appendChild(button);
            });
        };

        const fetchSmartSuggestions = async (history) => {
            try {
                const context = history.slice(-4).map(m => `${m.role}: ${m.content.prompt || m.content}`).join('\n');
                const prompt = `Based on this conversation context:\n\n${context}\n\nSuggest 3 short, relevant, and insightful follow-up questions a user might ask. Respond ONLY with a valid JSON array of strings in Persian. Example: ["سوال اول؟", "سوال دوم؟", "سوال سوم؟"]`;
                const model = 'gemini-1.5-flash-latest';
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent`;
                const payload = { contents: [{ role: 'user', parts: [{ text: prompt }] }] };
                const config = { responseMimeType: "application/json" };
                const result = await callApi(apiUrl, payload, config);
                const suggestionsText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (suggestionsText) {
                    const suggestions = JSON.parse(suggestionsText);
                    if(Array.isArray(suggestions)) {
                        renderSmartSuggestions(suggestions.slice(0, 3));
                    }
                }
            } catch (error) {
                console.error("Failed to fetch smart suggestions:", error);
                renderSmartSuggestions([]);
            }
        };

        const handlePluginCommand = (userInput) => {
            const currentChat = state.conversations[state.currentChatId];
            const [command, ...args] = userInput.trim().slice(1).split(/\s+/);
            const userMessageId = `msg-${Date.now()}`;
            const userMessage = { id: userMessageId, role: 'user', type: 'text', content: userInput };
            currentChat.history.push(userMessage);
            addMessageToUI(userMessage.role, userMessage.content, userMessage.type, userMessage.id);

            let resultHtml = '';
            switch (command.toLowerCase()) {
                case 'weather':
                    const city = args[0] || 'Tehran';
                    resultHtml = `
                        <div class="p-4 rounded-lg border border-[var(--border-color)]">
                            <div class="flex items-center gap-3 mb-2">
                                <i data-lucide="sun" class="w-10 h-10 text-yellow-500"></i>
                                <div>
                                    <p class="font-bold text-xl">25°C in ${city}</p>
                                    <p class="text-sm text-[var(--text-secondary)]">آفتابی</p>
                                </div>
                            </div>
                            <p class="text-xs text-[var(--text-secondary)]">(این یک داده شبیه‌سازی شده است)</p>
                        </div>`;
                    break;
                case 'calc':
                    try {
                        const expression = args.join(' ');
                        const result = new Function('return ' + expression.replace(/[^-()\d/*+.]/g, ''))();
                        resultHtml = `<p class="font-mono text-lg"><span class="text-[var(--text-secondary)]">${expression} =</span> <span class="font-bold">${result}</span></p>`;
                    } catch (e) {
                        resultHtml = `<p class="text-red-500">### 🔢 خطا: عبارت ریاضی نامعتبر\n\n**چه اتفاقی افتاده؟**\nعبارتی که در پلاگین ماشین حساب وارد کردید، قابل محاسبه نیست.\n\n**چکار باید بکنید؟**\n* از اعداد و عملگرهای استاندارد ریاضی (\`+\`, \`-\`, \`*\`, \`/\`) در عبارت خود استفاده کنید.\n* مطمئن شوید پرانتزها به درستی باز و بسته شده‌اند.</p>`;
                    }
                    break;
                default:
                    resultHtml = `<p class="text-red-500">### ❓ خطا: دستور یا پلاگین یافت نشد\n\n**چه اتفاقی افتاده؟**\nدستوری که با \`/\` شروع کردید، در سیستم تعریف نشده است.\n\n**چکار باید بکنید؟**\n1.  از صحت املای دستور مطمئن شوید (مثلاً \`/calc\` و نه \`/cal\`).\n2.  برای دیدن لیست پلاگین‌های موجود، از منوی اصلی روی **پلاگین‌ها** کلیک کنید.</p>`;
            }

            const pluginMessageId = `msg-${Date.now() + 1}`;
            const pluginMessage = { id: pluginMessageId, role: 'assistant', type: 'plugin', content: resultHtml };
            currentChat.history.push(pluginMessage);
            addMessageToUI(pluginMessage.role, pluginMessage.content, pluginMessage.type, pluginMessage.id);
            saveState();
        };

        const renderApiKeys = () => {
            elements.apiKeysList.innerHTML = '';
            elements.activeApiKeySelector.innerHTML = '';

            state.settings.apiKeys.forEach(key => {
                // Add to list
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-2 border border-[var(--border-color)] rounded-md';
                const isDefault = key.id === DEFAULT_API_KEY_ID;
                item.innerHTML = `
                    <div>
                        <span class="font-semibold">${key.name}</span>
                        <p class="text-xs text-[var(--text-secondary)] font-mono">${isDefault ? 'کلید داخلی برنامه' : '...' + key.key.slice(-4)}</p>
                    </div>
                    ${isDefault ? '' : `<button data-key-id="${key.id}" class="delete-api-key-btn p-2 text-red-500 hover:bg-red-100 rounded-md"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`}
                `;
                elements.apiKeysList.appendChild(item);

                // Add to selector
                const option = document.createElement('option');
                option.value = key.id;
                option.textContent = key.name;
                if (key.active) {
                    option.selected = true;
                }
                elements.activeApiKeySelector.appendChild(option);
            });
            lucide.createIcons();
        };

        const renderPersonas = () => {
            const defaultPersonas = {
                'default': { name: 'دستیار عمومی', icon: 'bot', prompt: '' },
                'creative': { name: 'نویسنده خلاق', icon: 'feather', prompt: 'تو یک نویسنده خلاق و داستان‌سرا هستی. پاسخ‌هایت باید سرشار از تصویرسازی و احساسات باشد.' },
                'technical': { name: 'کارشناس فنی', icon: 'code-2', prompt: 'تو یک مهندس نرم‌افزار ارشد هستی. پاسخ‌هایت باید دقیق، فنی و همراه با مثال‌های کد در صورت نیاز باشد.' },
            };
            const allPersonas = {...defaultPersonas, ...state.personas };

            elements.personaList.innerHTML = Object.entries(allPersonas).map(([id, data]) => `
                <button data-persona-id="${id}" class="persona-item-btn text-right p-4 border border-[var(--border-color)] rounded-lg hover:border-[var(--accent-color)] hover:bg-gray-500/10 transition-all group">
                    <i data-lucide="${data.icon}" class="w-8 h-8 mb-2 text-[var(--accent-color)]"></i>
                    <h4 class="font-bold text-lg">${data.name}</h4>
                </button>
            `).join('');
            lucide.createIcons();

            document.querySelectorAll('.persona-item-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.personaId;
                    const newPrompt = allPersonas[id].prompt;
                    state.settings.systemPrompt = newPrompt;
                    elements.systemPromptInput.value = newPrompt;
                    saveState();
                    elements.personaModal.classList.add('hidden');
                    showAlert(`شخصیت به "${allPersonas[id].name}" تغییر کرد.`, 'موفق');
                });
            });
        };

        const init = () => {
            const setVh = () => {
                document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
            };
            window.addEventListener('resize', setVh);
            setVh();

            lucide.createIcons();
            loadState();
            applyTheme();
            applyFontSize();
            setupSpeechRecognition();
            renderApiKeys();
            renderPersonas();
            
            populateTtsVoices();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = populateTtsVoices;
            }
            
            if (elements.systemPromptInput) elements.systemPromptInput.value = state.settings.systemPrompt;
            if (elements.historyLengthSlider) elements.historyLengthSlider.value = state.settings.historyLength;
            if (elements.historyLengthValue) elements.historyLengthValue.textContent = state.settings.historyLength;
            if (elements.animationToggle) elements.animationToggle.checked = state.settings.animations;
            if (elements.fontSizeSlider) elements.fontSizeSlider.value = state.settings.fontSize;
            if (elements.webSearchToggle) {
                elements.webSearchToggle.classList.toggle('web-search-active', state.settings.webSearch);
                elements.webSearchToggle.title = state.settings.webSearch ? 'جستجوی وب (فعال)' : 'جستجوی وب (غیرفعال)';
            }
            if (elements.autoSummaryToggle) elements.autoSummaryToggle.checked = state.settings.autoSummary;
            const modelInput = document.querySelector(`#model-selector input[value="${state.settings.model}"]`);
            if(modelInput) modelInput.checked = true;

            loadChat(state.currentChatId);

            if (elements.chatForm) elements.chatForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleUserMessage(elements.userInput.value);
                elements.userInput.value = '';
                elements.userInput.style.height = 'auto';
                elements.charCounter.textContent = 0;
            });
            if (elements.userInput) {
                elements.userInput.addEventListener('input', () => {
                    elements.userInput.style.height = 'auto';
                    elements.userInput.style.height = (elements.userInput.scrollHeight) + 'px';
                    elements.charCounter.textContent = elements.userInput.value.length;
                });
                elements.userInput.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 'Enter') {
                        e.preventDefault();
                        elements.chatForm.dispatchEvent(new Event('submit'));
                    }
                });
            }
            if (elements.sidebarToggle) elements.sidebarToggle.addEventListener('click', () => {
                 if (window.innerWidth < 768) {
                    elements.appWrapper.classList.toggle('sidebar-open');
                    elements.sidebarBackdrop.classList.toggle('hidden');
                } else {
                    elements.appWrapper.classList.toggle('sidebar-closed');
                }
            });
            if (elements.sidebarBackdrop) elements.sidebarBackdrop.addEventListener('click', () => {
                elements.appWrapper.classList.remove('sidebar-open');
                elements.sidebarBackdrop.classList.add('hidden');
            });
            if (elements.newChatBtn) elements.newChatBtn.addEventListener('click', () => startNewChat());

            document.querySelectorAll('[data-close-modal]').forEach(btn => btn.addEventListener('click', () => {
                btn.closest('.fixed').classList.add('hidden');
            }));
            if (elements.alertOkBtn) elements.alertOkBtn.addEventListener('click', () => elements.alertModal.classList.add('hidden'));
            
            // Popover logic
            document.addEventListener('click', (e) => {
                if (elements.moreMenuPopover.classList.contains('show') && !elements.moreMenuPopover.contains(e.target) && !elements.moreMenuBtn.contains(e.target)) {
                    elements.moreMenuPopover.classList.remove('show');
                }
                if (elements.chatActionsPopover.classList.contains('show') && !elements.chatActionsPopover.contains(e.target) && !elements.chatActionsBtn.contains(e.target)) {
                    elements.chatActionsPopover.classList.remove('show');
                }
            });

            if (elements.moreMenuBtn) {
                elements.moreMenuBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    elements.moreMenuPopover.classList.toggle('show');
                });
            }

            if (elements.chatActionsBtn) {
                elements.chatActionsBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    elements.chatActionsPopover.classList.toggle('show');
                });
            }
            
            const connectPopoverButton = (btnId, modalId) => {
                const btn = document.getElementById(btnId);
                const modal = document.getElementById(modalId);
                if (btn && modal) {
                    btn.addEventListener('click', () => {
                        modal.classList.remove('hidden');
                        elements.moreMenuPopover.classList.remove('show');
                    });
                }
            };
            connectPopoverButton('settings-btn', 'settings-modal');
            connectPopoverButton('about-btn', 'about-modal');
            connectPopoverButton('prompt-library-btn', 'prompt-library-modal');
            connectPopoverButton('persona-btn', 'persona-modal');
            connectPopoverButton('template-btn', 'template-modal');
            connectPopoverButton('plugins-btn', 'plugins-modal');
            
            if (elements.upgradeProBtn) elements.upgradeProBtn.addEventListener('click', () => elements.proModal.classList.remove('hidden'));
            if (elements.createBtn) elements.createBtn.addEventListener('click', () => {
                elements.createModal.classList.remove('hidden');
                elements.createForm.classList.add('hidden');
                elements.createOptions.classList.remove('hidden');
                elements.chatActionsPopover.classList.remove('show');
            });
            if (elements.createOptions) elements.createOptions.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (btn) {
                    currentCreateType = btn.dataset.type;
                    elements.createOptions.classList.add('hidden');
                    elements.createForm.classList.remove('hidden');
                    elements.createPrompt.placeholder = `توصیف دقیق برای ${currentCreateType === 'image' ? 'تصویر' : 'وب‌سایت'}...`;
                    elements.createPrompt.focus();
                }
            });
            if (elements.createForm) elements.createForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleCreateCommand(elements.createPrompt.value, currentCreateType);
                elements.createModal.classList.add('hidden');
                elements.createPrompt.value = '';
            });
            
            if (elements.themeSelector) elements.themeSelector.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (btn && btn.dataset.theme) {
                    state.settings.theme = btn.dataset.theme;
                    applyTheme();
                    saveState();
                }
            });
            if (elements.systemPromptInput) elements.systemPromptInput.addEventListener('change', () => { state.settings.systemPrompt = elements.systemPromptInput.value; saveState(); });
            if (elements.historyLengthSlider) {
                elements.historyLengthSlider.addEventListener('input', (e) => { elements.historyLengthValue.textContent = e.target.value; });
                elements.historyLengthSlider.addEventListener('change', (e) => { state.settings.historyLength = parseInt(e.target.value, 10); saveState(); });
            }
            if (elements.animationToggle) elements.animationToggle.addEventListener('change', (e) => { state.settings.animations = e.target.checked; saveState(); });
            if (elements.modelSelector) elements.modelSelector.addEventListener('change', (e) => { state.settings.model = e.target.value; saveState(); });
            if (elements.fontSizeSlider) {
                elements.fontSizeSlider.addEventListener('input', (e) => {
                    state.settings.fontSize = parseInt(e.target.value, 10);
                    applyFontSize();
                });
                elements.fontSizeSlider.addEventListener('change', saveState);
            }
            if (elements.clearAllBtn) elements.clearAllBtn.addEventListener('click', () => {
                if(confirm("آیا از پاک کردن تمام داده‌های برنامه مطمئن هستید؟ این عمل غیرقابل بازگشت است.")) {
                    localStorage.clear();
                    window.location.reload();
                }
            });
            
            elements.conversationsList.addEventListener('click', (e) => {
                const targetButton = e.target.closest('button');
                if (!targetButton) return;

                const action = targetButton.dataset.action;
                const chatId = targetButton.dataset.chatId;
                const folderId = targetButton.closest('.folder-container')?.dataset.folderId;

                if (action === 'load-chat') {
                    loadChat(chatId);
                    if (window.innerWidth < 768) {
                        elements.appWrapper.classList.remove('sidebar-open');
                        elements.sidebarBackdrop.classList.add('hidden');
                    }
                } else if (action === 'delete-chat') {
                    delete state.conversations[chatId];
                    if (state.currentChatId === chatId) {
                        state.currentChatId = null;
                        loadChat(null);
                    }
                    renderConversationsList(elements.searchInput.value);
                    saveState();
                } else if (action === 'toggle-pin') {
                    state.conversations[chatId].isPinned = !state.conversations[chatId].isPinned;
                    renderConversationsList(elements.searchInput.value);
                    saveState();
                } else if (action === 'delete-folder') {
                    if (confirm(`آیا از حذف پوشه "${state.folders[folderId].name}" مطمئن هستید؟`)) {
                        delete state.folders[folderId];
                        Object.values(state.conversations).forEach(c => {
                            if (c.folderId === folderId) c.folderId = null;
                        });
                        renderConversationsList();
                        saveState();
                    }
                } else if (action === 'edit-folder') {
                    const titleSpan = targetButton.closest('summary').querySelector('.folder-title');
                    const oldName = titleSpan.textContent;
                    titleSpan.contentEditable = true;
                    titleSpan.focus();
                    titleSpan.onblur = () => {
                        titleSpan.contentEditable = false;
                        const newName = titleSpan.textContent.trim();
                        if (newName && newName !== oldName) {
                            state.folders[folderId].name = newName;
                            saveState();
                        } else {
                            titleSpan.textContent = oldName;
                        }
                    };
                    titleSpan.onkeydown = (ev) => { if (ev.key === 'Enter') { ev.preventDefault(); titleSpan.blur(); }};
                }
            });
            elements.conversationsList.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('chat-item')) {
                    draggedChatId = e.target.dataset.chatId;
                    e.target.classList.add('dragging');
                }
            });
            elements.conversationsList.addEventListener('dragend', (e) => {
                if (e.target.classList.contains('chat-item')) {
                    e.target.classList.remove('dragging');
                    draggedChatId = null;
                }
            });
            elements.conversationsList.addEventListener('dragover', (e) => {
                e.preventDefault();
                const targetFolder = e.target.closest('.folder-container');
                document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                if (targetFolder) {
                    targetFolder.classList.add('drag-over');
                }
            });
            elements.conversationsList.addEventListener('drop', (e) => {
                e.preventDefault();
                document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                const targetFolder = e.target.closest('.folder-container');
                if (draggedChatId && targetFolder) {
                    const folderId = targetFolder.dataset.folderId;
                    state.conversations[draggedChatId].folderId = folderId;
                    renderConversationsList();
                    saveState();
                }
            });
            elements.conversationsList.addEventListener('toggle', (e) => {
                if(e.target.classList.contains('folder-container')) {
                    const folderId = e.target.dataset.folderId;
                    state.folders[folderId].isOpen = e.target.open;
                    saveState();
                }
            }, true);

            if (elements.searchInput) elements.searchInput.addEventListener('input', (e) => {
                renderConversationsList(e.target.value);
            });

            if (elements.exportChatBtn) {
                elements.exportChatBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    elements.exportOptions.classList.toggle('hidden');
                });
                document.addEventListener('click', (e) => {
                    if (!elements.exportMenuContainer.contains(e.target)) {
                        elements.exportOptions.classList.add('hidden');
                    }
                });
            }

            const exportChat = (format) => {
                const chat = state.conversations[state.currentChatId];
                if (!chat) return;
                let content = '';
                let ext = format;
                let mime = 'text/plain';

                if (format === 'json') {
                    content = JSON.stringify(chat, null, 2);
                    mime = 'application/json';
                } else if (format === 'md') {
                    content = `# ${chat.title}\n\n`;
                    chat.history.forEach(msg => {
                        const role = msg.role === 'user' ? 'شما' : 'AI';
                        content += `**${role}:**\n\n${msg.content}\n\n---\n\n`;
                    });
                    mime = 'text/markdown';
                } else { // txt
                    content = `${chat.title}\n\n`;
                    chat.history.forEach(msg => {
                        const role = msg.role === 'user' ? 'شما' : 'AI';
                        content += `${role}:\n${msg.content}\n\n-----------------\n\n`;
                    });
                }
                
                const blob = new Blob([content], { type: mime });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${chat.title.replace(/ /g, '_')}.${ext}`;
                a.click();
                URL.revokeObjectURL(url);
                elements.exportOptions.classList.add('hidden');
            };

            if (elements.exportJsonBtn) elements.exportJsonBtn.addEventListener('click', (e) => { e.preventDefault(); exportChat('json'); });
            if (elements.exportMdBtn) elements.exportMdBtn.addEventListener('click', (e) => { e.preventDefault(); exportChat('md'); });
            if (elements.exportTxtBtn) elements.exportTxtBtn.addEventListener('click', (e) => { e.preventDefault(); exportChat('txt'); });


            if (elements.micBtn) elements.micBtn.addEventListener('click', () => {
                if (state.isRecording) {
                    stopRecording();
                } else {
                    startAudioRecording();
                }
            });
            if (elements.fileUploadBtn) elements.fileUploadBtn.addEventListener('click', () => elements.fileInput.click());
            if (elements.fileInput) elements.fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                if (file.type.startsWith('image/')) {
                    reader.onload = (event) => {
                        const base64Data = event.target.result.split(',')[1];
                        const fileData = { type: 'image', content: { prompt: "این تصویر را تحلیل کن", url: event.target.result, base64Data, mimeType: file.type } };
                        const promptText = prompt("چه سوالی درباره این تصویر دارید؟", "این تصویر را توصیف کن");
                        if (promptText) {
                            fileData.content.prompt = promptText;
                            handleUserMessage(promptText, fileData);
                        }
                    };
                    reader.readAsDataURL(file);
                } else if (file.type.startsWith('text/') || file.name.endsWith('.js') || file.name.endsWith('.py') || file.name.endsWith('.html') || file.name.endsWith('.css')) {
                    reader.onload = (event) => {
                        const fileData = { type: 'file', content: { name: file.name, text: event.target.result } };
                        const promptText = prompt(`درباره محتوای فایل "${file.name}" چه دستوری دارید؟`, `محتوای این فایل را خلاصه کن`);
                        if (promptText) handleUserMessage(promptText, fileData);
                    };
                    reader.readAsText(file);
                } else {
                    showAlert(`نوع فایل ${file.type} پشتیبانی نمی‌شود.`);
                }
                elements.fileInput.value = '';
            });

            if (elements.exportSettingsBtn) elements.exportSettingsBtn.addEventListener('click', () => {
                const settingsJson = JSON.stringify({settings: state.settings, personas: state.personas}, null, 2);
                const blob = new Blob([settingsJson], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ai-studio-settings.json';
                a.click();
                URL.revokeObjectURL(url);
            });
            if (elements.importSettingsBtn) elements.importSettingsBtn.addEventListener('click', () => {
                elements.importSettingsInput.click();
            });
            if (elements.importSettingsInput) elements.importSettingsInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (importedData.settings) {
                           state.settings = { ...state.settings, ...importedData.settings };
                        }
                        if (importedData.personas) {
                            state.personas = { ...state.personas, ...importedData.personas };
                        }
                        
                        applyTheme();
                        applyFontSize();
                        renderApiKeys();
                        renderPersonas();
                        elements.systemPromptInput.value = state.settings.systemPrompt;
                        elements.historyLengthSlider.value = state.settings.historyLength;
                        elements.historyLengthValue.textContent = state.settings.historyLength;
                        elements.animationToggle.checked = state.settings.animations;
                        elements.fontSizeSlider.value = state.settings.fontSize;
                        elements.webSearchToggle.classList.toggle('web-search-active', state.settings.webSearch);
                        elements.autoSummaryToggle.checked = state.settings.autoSummary;
                        const modelInput = document.querySelector(`#model-selector input[value="${state.settings.model}"]`);
                        if(modelInput) modelInput.checked = true;
                        saveState();
                        showAlert('تنظیمات با موفقیت وارد شد!', 'موفق');
                    } catch (err) {
                        showAlert('خطا در خواندن فایل تنظیمات. لطفاً از یک فایل معتبر استفاده کنید.');
                        console.error("Error parsing settings file:", err);
                    }
                };
                reader.readAsText(file);
            });

            if (elements.fullscreenBtn) elements.fullscreenBtn.addEventListener('click', () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                    elements.fullscreenBtn.innerHTML = '<i data-lucide="minimize"></i>';
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                        elements.fullscreenBtn.innerHTML = '<i data-lucide="maximize"></i>';
                    }
                }
                lucide.createIcons();
            });

            const promptLibrary = {
                'خلاقیت و تولید محتوا': [
                    { title: 'طوفان فکری', prompt: 'برای [موضوع]، ۱۰ ایده خلاقانه ارائه بده.' },
                    { title: 'نوشتن پست وبلاگ', prompt: 'یک پست وبلاگ جذاب درباره [موضوع] با لحنی [لحن, مثلا: دوستانه] بنویس.' },
                ],
                'برنامه‌نویسی': [
                    { title: 'توضیح کد', prompt: 'این قطعه کد [زبان برنامه‌نویسی] را خط به خط توضیح بده:\n```\n\n```' },
                    { title: 'نوشتن تابع', prompt: 'یک تابع به زبان [زبان برنامه‌نویسی] بنویس که [کاربرد تابع] را انجام دهد.' },
                ],
            };

            if (elements.promptCategoriesContainer) {
                elements.promptCategoriesContainer.innerHTML = Object.entries(promptLibrary).map(([category, prompts]) => `
                    <div>
                        <h4 class="font-bold mb-2">${category}</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                            ${prompts.map(p => `<button class="prompt-item-btn">${p.title}</button>`).join('')}
                        </div>
                    </div>
                `).join('');
            
                document.querySelectorAll('.prompt-item-btn').forEach(btn => {
                    btn.className = 'p-3 text-sm text-right border border-[var(--border-color)] rounded-lg hover:border-[var(--accent-color)] hover:bg-gray-500/10 transition-all';
                    btn.addEventListener('click', () => {
                        const category = btn.closest('div').previousElementSibling.textContent;
                        const promptData = promptLibrary[category].find(p => p.title === btn.textContent);
                        if (promptData) {
                            elements.userInput.value = promptData.prompt;
                            elements.promptLibraryModal.classList.add('hidden');
                            elements.userInput.focus();
                        }
                    });
                });
            }
            
            if (elements.importChatBtn) elements.importChatBtn.addEventListener('click', () => elements.importChatInput.click());
            if (elements.importChatInput) elements.importChatInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedChat = JSON.parse(event.target.result);
                        if (importedChat.id && importedChat.title && Array.isArray(importedChat.history)) {
                            state.conversations[importedChat.id] = importedChat;
                            saveState();
                            loadChat(importedChat.id);
                            showAlert('گفتگو با موفقیت وارد شد!', 'موفق');
                        } else {
                            throw new Error('Invalid chat file format.');
                        }
                    } catch (err) {
                        showAlert('خطا در خواندن فایل گفتگو. لطفاً از یک فایل معتبر استفاده کنید.');
                        console.error("Error parsing chat file:", err);
                    }
                };
                reader.readAsText(file);
            });

            if(elements.markdownEditorBtn) elements.markdownEditorBtn.addEventListener('click', () => {
                elements.markdownInput.value = elements.userInput.value;
                elements.markdownPreview.innerHTML = marked.parse(elements.userInput.value);
                elements.markdownEditorModal.classList.remove('hidden');
                elements.chatActionsPopover.classList.remove('show');
            });
            if(elements.markdownInput) elements.markdownInput.addEventListener('input', (e) => {
                elements.markdownPreview.innerHTML = marked.parse(e.target.value);
            });
            if(elements.markdownSendBtn) elements.markdownSendBtn.addEventListener('click', () => {
                const content = elements.markdownInput.value;
                elements.userInput.value = content;
                elements.userInput.dispatchEvent(new Event('input'));
                elements.markdownEditorModal.classList.add('hidden');
                handleUserMessage(content);
            });

            if (elements.stopBtn) elements.stopBtn.addEventListener('click', () => {
                if (apiAbortController) {
                    apiAbortController.abort();
                }
                clearInterval(typingEffectInterval);
                toggleForm(true);
            });

            if (elements.randomPromptBtn) elements.randomPromptBtn.addEventListener('click', () => {
                const allPrompts = Object.values(promptLibrary).flat();
                const randomPrompt = allPrompts[Math.floor(Math.random() * allPrompts.length)];
                elements.userInput.value = randomPrompt.prompt;
                elements.promptLibraryModal.classList.add('hidden');
                elements.userInput.focus();
            });

            document.querySelectorAll('.settings-nav-btn').forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelectorAll('.settings-nav-btn').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    document.querySelectorAll('.settings-tab-content').forEach(tab => tab.classList.add('hidden'));
                    document.getElementById(`settings-tab-${button.dataset.tab}`).classList.remove('hidden');
                });
            });
            
            if (elements.summarizeChatBtn) elements.summarizeChatBtn.addEventListener('click', async () => {
                const chat = state.conversations[state.currentChatId];
                if (!chat || chat.history.length === 0) {
                    showAlert('گفتگویی برای خلاصه کردن وجود ندارد.');
                    return;
                }
                toggleForm(false, 'در حال خلاصه‌سازی...');
                try {
                    const fullText = chat.history.map(m => `[${m.role}]: ${m.content.prompt || m.content}`).join('\n');
                    const prompt = `لطفاً این گفتگو را در چند جمله کلیدی خلاصه کن:\n\n${fullText}`;
                    const { text: summary } = await generateContent([{ text: prompt }], []);
                    
                    if(summary) {
                        const summaryId = `msg-${Date.now()}`;
                        const summaryMessage = { id: summaryId, role: 'assistant', type: 'text', content: `**خلاصه گفتگو:**\n\n${summary}`};
                        chat.history.push(summaryMessage);
                        addMessageToUI(summaryMessage.role, summaryMessage.content, summaryMessage.type, summaryMessage.id);
                        saveState();
                    }
                } catch(error) {
                    const friendlyError = getFriendlyErrorMessage(error);
                    addMessageToUI('assistant', friendlyError, 'text', `msg-${Date.now() + 1}`);
                } finally {
                    toggleForm(true);
                }
            });

            if (elements.exportAllChatsBtn) elements.exportAllChatsBtn.addEventListener('click', () => {
                const dataToExport = {
                    conversations: state.conversations,
                    folders: state.folders
                };
                const allChatsJson = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([allChatsJson], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'all_conversations_and_folders.json';
                a.click();
                URL.revokeObjectURL(url);
            });

            if (elements.webSearchToggle) elements.webSearchToggle.addEventListener('click', () => {
                state.settings.webSearch = !state.settings.webSearch;
                elements.webSearchToggle.classList.toggle('web-search-active', state.settings.webSearch);
                elements.webSearchToggle.title = state.settings.webSearch ? 'جستجوی وب (فعال)' : 'جستجوی وب (غیرفعال)';
                saveState();
            });
            
            if (elements.newFolderBtn) elements.newFolderBtn.addEventListener('click', () => {
                const folderName = prompt("نام پوشه جدید را وارد کنید:", "پوشه جدید");
                if (folderName) {
                    const newFolderId = `folder-${Date.now()}`;
                    state.folders[newFolderId] = { id: newFolderId, name: folderName, isOpen: true };
                    renderConversationsList();
                    saveState();
                }
            });

            if (elements.ttsVoiceSelector) elements.ttsVoiceSelector.addEventListener('change', (e) => {
                state.settings.ttsVoiceURI = e.target.value;
                saveState();
            });
            
            if (elements.autoSummaryToggle) elements.autoSummaryToggle.addEventListener('change', (e) => {
                state.settings.autoSummary = e.target.checked;
                saveState();
            });

            if (elements.copyChatIdBtn) elements.copyChatIdBtn.addEventListener('click', () => {
                if (state.currentChatId) {
                    navigator.clipboard.writeText(state.currentChatId).then(() => {
                        showAlert('شناسه گفتگو کپی شد!', 'موفق');
                    });
                }
            });

            const templates = {
                'خلاصه‌سازی': { icon: 'book-text', title: 'خلاصه کردن متن', systemPrompt: 'تو یک دستیار متخصص در خلاصه‌سازی متون هستی. نکات کلیدی را استخراج کرده و به صورت روان ارائه بده.', starterMessage: 'لطفاً متنی را که می‌خواهید خلاصه شود، اینجا وارد کنید.'},
                'ایده‌پردازی': { icon: 'lightbulb', title: 'طوفان فکری', systemPrompt: 'تو یک دستیار خلاق برای ایده‌پردازی هستی. ایده‌های نوآورانه و خارج از چارچوب ارائه بده.', starterMessage: 'موضوعی که می‌خواهید در مورد آن ایده‌پردازی کنیم چیست؟'},
                'رفع اشکال کد': { icon: 'code-2', title: 'دیباگ کردن کد', systemPrompt: 'تو یک برنامه‌نویس ارشد و متخصص در یافتن و رفع اشکالات کد هستی. توضیحاتت باید دقیق و فنی باشد.', starterMessage: 'لطفاً قطعه کدی که در آن با مشکل مواجه شده‌اید را به همراه خطای دریافتی وارد کنید.'},
            };

            if (elements.templateList) {
                elements.templateList.innerHTML = Object.values(templates).map(t => `
                    <button data-template-title="${t.title}" class="template-item-btn text-right p-4 border border-[var(--border-color)] rounded-lg hover:border-[var(--accent-color)] hover:bg-gray-500/10 transition-all group">
                        <i data-lucide="${t.icon}" class="w-8 h-8 mb-2 text-[var(--accent-color)]"></i>
                        <h4 class="font-bold text-lg">${t.title}</h4>
                    </button>
                `).join('');
                lucide.createIcons();
                document.querySelectorAll('.template-item-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const title = btn.dataset.templateTitle;
                        const template = Object.values(templates).find(t => t.title === title);
                        if (template) {
                            startNewChat(template);
                            elements.templateModal.classList.add('hidden');
                        }
                    });
                });
            }

            // New API Key Management Listeners
            if (elements.addApiKeyForm) elements.addApiKeyForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = elements.apiKeyNameInput.value.trim();
                const key = elements.apiKeyValueInput.value.trim();
                if (name && key) {
                    const newKey = { id: `key-${Date.now()}`, name, key, active: false };
                    state.settings.apiKeys.push(newKey);
                    renderApiKeys();
                    saveState();
                    elements.addApiKeyForm.reset();
                }
            });

            if (elements.apiKeysList) elements.apiKeysList.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-api-key-btn');
                if (deleteBtn) {
                    const keyId = deleteBtn.dataset.keyId;
                    state.settings.apiKeys = state.settings.apiKeys.filter(k => k.id !== keyId);
                    renderApiKeys();
                    saveState();
                }
            });

            if (elements.activeApiKeySelector) elements.activeApiKeySelector.addEventListener('change', (e) => {
                const selectedId = e.target.value;
                state.settings.apiKeys.forEach(k => k.active = (k.id === selectedId));
                saveState();
            });

            // New Persona Management Listeners
            if (elements.addPersonaBtn) elements.addPersonaBtn.addEventListener('click', () => {
                elements.personaListContainer.classList.add('hidden');
                elements.addPersonaFormContainer.classList.remove('hidden');
                const icons = ['user', 'briefcase', 'book', 'mail', 'edit-3', 'globe'];
                elements.personaIconSelector.innerHTML = icons.map(icon => `
                    <label class="p-2 border rounded-md cursor-pointer has-[:checked]:bg-[var(--accent-color)] has-[:checked]:text-white">
                        <input type="radio" name="persona-icon" value="${icon}" class="hidden">
                        <i data-lucide="${icon}"></i>
                    </label>
                `).join('');
                lucide.createIcons();
            });
            if (elements.cancelAddPersonaBtn) elements.cancelAddPersonaBtn.addEventListener('click', () => {
                elements.addPersonaFormContainer.classList.add('hidden');
                elements.personaListContainer.classList.remove('hidden');
            });
            if (elements.addPersonaForm) elements.addPersonaForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = elements.personaNameInput.value.trim();
                const icon = elements.addPersonaForm.querySelector('input[name="persona-icon"]:checked')?.value;
                const prompt = elements.personaPromptInput.value.trim();
                if (name && icon && prompt) {
                    const id = `persona-${Date.now()}`;
                    state.personas[id] = { name, icon, prompt };
                    saveState();
                    renderPersonas();
                    elements.addPersonaForm.reset();
                    elements.addPersonaFormContainer.classList.add('hidden');
                    elements.personaListContainer.classList.remove('hidden');
                } else {
                    showAlert('لطفاً تمام فیلدها را پر کنید.');
                }
            });
            
            // New Analysis Dashboard Listener
            if (elements.analyzeChatBtn) elements.analyzeChatBtn.addEventListener('click', () => {
                const chat = state.conversations[state.currentChatId];
                if (!chat || chat.history.length === 0) return;

                // 1. Calculate Stats
                const totalMessages = chat.history.length;
                const totalTokens = chat.history.reduce((sum, msg) => sum + (msg.tokenCount || 0), 0);
                const userMessages = chat.history.filter(m => m.role === 'user');
                const assistantMessages = chat.history.filter(m => m.role === 'assistant');
                const allText = chat.history.map(m => typeof m.content === 'string' ? m.content : m.content.prompt || '').join(' ');
                const avgLength = totalMessages > 0 ? Math.round(allText.length / totalMessages) : 0;
                
                elements.analysisTotalMessages.textContent = totalMessages;
                elements.analysisTotalTokens.textContent = totalTokens;
                elements.analysisAvgLength.textContent = `${avgLength} کاراکتر`;

                // 2. Word Cloud
                const wordCounts = {};
                const words = allText.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"").toLowerCase().split(/\s+/);
                words.forEach(word => {
                    if (word.length > 3 && isNaN(word)) { // Filter short words and numbers
                        wordCounts[word] = (wordCounts[word] || 0) + 1;
                    }
                });
                const wordList = Object.entries(wordCounts).map(([text, weight]) => [text, weight * 10]);
                
                if (wordList.length > 0) {
                    WordCloud(elements.wordCloudCanvas, { list: wordList, backgroundColor: 'transparent', color: getComputedStyle(document.body).getPropertyValue('--text-primary') });
                } else {
                    elements.wordCloudCanvas.getContext('2d').clearRect(0,0,elements.wordCloudCanvas.width, elements.wordCloudCanvas.height);
                }


                // 3. Activity Chart
                if (activityChartInstance) {
                    activityChartInstance.destroy();
                }
                activityChartInstance = new Chart(elements.activityChart, {
                    type: 'doughnut',
                    data: {
                        labels: ['پیام‌های شما', 'پاسخ‌های AI'],
                        datasets: [{
                            label: 'تعداد پیام‌ها',
                            data: [userMessages.length, assistantMessages.length],
                            backgroundColor: [
                                'rgba(var(--accent-color-rgb), 0.7)',
                                'rgba(128, 128, 128, 0.5)'
                            ],
                            borderColor: [
                                'rgba(var(--accent-color-rgb), 1)',
                                'rgba(128, 128, 128, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                       responsive: true,
                       plugins: {
                           legend: {
                               position: 'top',
                               labels: {
                                   color: getComputedStyle(document.body).getPropertyValue('--text-primary')
                               }
                           }
                       }
                    }
                });

                elements.analysisModal.classList.remove('hidden');
            });

        };

        init();
    });
    </script>
</body>
</html>
